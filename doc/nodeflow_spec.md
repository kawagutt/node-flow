# NodeFlow v1.2 ä»•æ§˜ï¼ˆCore / Execution äºŒå±¤æ§‹é€ ç‰ˆï¼‰

---

# Part I â€” Core Modelï¼ˆStrict Versionï¼‰

æœ¬ç« ã¯ NodeFlow ã®æŠ½è±¡è¨ˆç®—ãƒ¢ãƒ‡ãƒ«ã‚’å®šç¾©ã™ã‚‹ã€‚
æ§‹æ–‡ã¨æ„å‘³è«–ã‚’åˆ†é›¢ã—ã€Execution æ¦‚å¿µã¯å«ã‚ãªã„ã€‚

---

# 0. Scope

## 0.1 Core Principles

Nodes do not have access to graph topology. They only receive resolved input ports. Connection information is exclusively managed by StructuralNode.

---

Core Model ã¯ä»¥ä¸‹ã®ã¿ã‚’å®šç¾©ã™ã‚‹ï¼š

* æ§‹æ–‡ï¼ˆNode, Graphï¼‰
* æ„å‘³è«–ï¼ˆGraph ã®è©•ä¾¡ï¼‰
* Loop æ¼”ç®—å­

ä»¥ä¸‹ã¯å®šç¾©ã—ãªã„ï¼š

* å®Ÿè¡Œé †åº
* ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒªãƒ³ã‚°
* ä¸¦åˆ—æ€§
* åˆ¶é™ï¼ˆlimitï¼‰
* åœæ­¢åˆ¶å¾¡
* pause / status
* revision
* å®Ÿè£…ã‚¯ãƒ©ã‚¹
* Runner

Core ã¯ç´”ç²‹ãªè¨ˆç®—ãƒ¢ãƒ‡ãƒ«ã§ã‚ã‚‹ã€‚

---

# 1. Node

## 1.1 Syntax

```
Node = (S, f)
```

* S : çŠ¶æ…‹ç©ºé–“
* f : é·ç§»é–¢æ•°

å…¥åŠ›ç©ºé–“ã‚’ Xã€å‡ºåŠ›ç©ºé–“ã‚’ Y ã¨ã™ã‚‹ã¨ï¼š

```
f : (X Ã— S) â†’ (Y Ã— S)
```

Node ã¯çŠ¶æ…‹ä»˜ãé·ç§»å™¨ã§ã‚ã‚‹ã€‚

---

## 1.2 Properties

* Node ã¯ black-box
* ä»– Node ã®å­˜åœ¨ã‚’çŸ¥ã‚‰ãªã„
* Graph æ§‹é€ ã‚’çŸ¥ã‚‰ãªã„
* è‡ªèº«ã® state ã¨ inputs ã®ã¿å‚ç…§å¯èƒ½

Core ã¯ Node ã®å†…éƒ¨æ§‹é€ ã‚’è¦å®šã—ãªã„ã€‚

---

## 1.3 Port structureï¼ˆCore å¥‘ç´„ï¼‰

**Each output port MUST be a dictionary.**

Core ã¯ port ã®å…·è±¡æ§‹é€ ã‚’è¦å®šã—ãªã„ã€‚å…·è±¡çš„ãª port æ§‹é€ ï¼ˆ`_meta`ã€`revision` ç­‰ï¼‰ã¯ Execution å±¤ã§å®šç¾©ã™ã‚‹ï¼ˆPart II Â§5 ç­‰ï¼‰ã€‚

If a Node returns a non-dict port value, the behavior is undefined and treated as fatal.

---

# 2. Graph

## 2.1 Syntax

```
Graph = (Nodes, Edges)
```

* Nodes : Node ã®æœ‰é™é›†åˆ
* Edges : Node ã®å‡ºåŠ›ãƒãƒ¼ãƒˆã‹ã‚‰å…¥åŠ›ãƒãƒ¼ãƒˆã¸ã®æœ‰å‘æ¥ç¶šé›†åˆ

Edges ã¯æ¬¡ã®å½¢ã‚’æŒã¤ï¼š

```
u.output_port â†’ v.input_port
```

å¾ªç’°ã¯è¨±å¯ã•ã‚Œã‚‹ã€‚

---

## 2.2 Boundary

Graph ã¯å¤–éƒ¨ã¨ã®å…¥å‡ºåŠ›å¢ƒç•Œã‚’æŒã¤ã€‚

* Graph å…¥åŠ›ç©ºé–“ã‚’ X_G
* Graph å‡ºåŠ›ç©ºé–“ã‚’ Y_G

å¢ƒç•Œã¯ Graph æ§‹é€ ã«ã‚ˆã£ã¦å®šã¾ã‚‹ã€‚

---

# 3. Graph Semantics

Graph ã¯æ§‹é€ ã§ã‚ã‚Šã€é·ç§»å™¨ã§ã¯ãªã„ã€‚
Graph ã‚’é·ç§»å™¨ã¨ã—ã¦è§£é‡ˆã™ã‚‹ãŸã‚ã«è©•ä¾¡æ„å‘³è«–ã‚’å®šç¾©ã™ã‚‹ã€‚

---

## 3.1 Evaluation Function

```
âŸ¦ Â· âŸ§ : Graph â†’ Node
```

ä»»æ„ã® Graph G ã«å¯¾ã—ï¼š

```
âŸ¦GâŸ§ = (S_G, f_G)
```

ãŒå®šç¾©ã•ã‚Œã‚‹ã€‚

---

## 3.2 Induced State Space

```
S_G = âˆ_{n âˆˆ Nodes} S_n
```

å„ Node ã®çŠ¶æ…‹ã®ç›´ç©ã§ã‚ã‚‹ã€‚

---

## 3.3 Induced Transition

```
f_G : (X_G Ã— S_G) â†’ (Y_G Ã— S_G)
```

f_G ã¯ Graph æ§‹é€  (Nodes, Edges) ã¨æ•´åˆçš„ãªé·ç§»é–¢æ•°ã¨ã—ã¦å®šç¾©ã•ã‚Œã‚‹ã€‚

è©•ä¾¡é †åºã‚„é©ç”¨æˆ¦ç•¥ã¯è¦å®šã—ãªã„ã€‚**Core ã¯æˆ¦ç•¥ç‹¬ç«‹ãªæ„å‘³è«–ã‚’å‰æã¨ã™ã‚‹ã€‚** ãŸã ã—ã“ã®å‰æã¯ Node ã®é·ç§»é–¢æ•°ãŒæ±ºå®šçš„ã§ã‚ã‚‹ã“ã¨ã«ä¾å­˜ã™ã‚‹ã€‚ã™ãªã‚ã¡ Graph ã®æ„å‘³è«– âŸ¦GâŸ§ ã¯è©•ä¾¡æˆ¦ç•¥ã«ä¾å­˜ã—ãªã„ã€‚æˆ¦ç•¥ç‹¬ç«‹ã¨ã¯ã€Graph æ§‹é€ ã¨ Node ã®é·ç§»é–¢æ•°ãŒæ±ºå®šçš„ã§ã‚ã‚‹é™ã‚Šã€è©•ä¾¡é †åºã®é•ã„ãŒ f_G ã®çµæœã«å½±éŸ¿ã—ãªã„ã“ã¨ã‚’æ„å‘³ã™ã‚‹ã€‚æˆ¦ç•¥ç‹¬ç«‹æ€§ã¯ã€å„ Node ã®é·ç§»é–¢æ•°ãŒæ±ºå®šçš„ã§ã‚ã‚Šã€Graph æ§‹é€ ãŒè©•ä¾¡é †åºã«ä¾å­˜ã—ãªã„è¨­è¨ˆã§ã‚ã‚‹ã“ã¨ã‚’å‰æã¨ã™ã‚‹ã€‚

**Scope of strategy independence**  
The strategy independence property stated above holds for well-formed acyclic Graphs. For Graphs containing cycles, the semantics âŸ¦GâŸ§ may depend on the evaluation strategy (i.e., the fixed point reached may vary). In such cases, the semantics is defined only partially, and the Execution Layer is responsible for ensuring deterministic behavior through scheduling policy (Â§7.1.1) and initial value injection (Â§8).

ãŸã ã—æ„å‘³è«– âŸ¦GâŸ§ ã¯ï¼š

* Graph æ§‹é€ ã®ã¿ã«ä¾å­˜ã™ã‚‹
* å¤–éƒ¨çŠ¶æ…‹ã‚„æ™‚é–“ã«ä¾å­˜ã—ãªã„
* åŒä¸€ã® Graph ã«å¯¾ã—ã¦åŒä¸€ã«å®šã¾ã‚‹

ã‚‚ã®ã¨ã™ã‚‹ã€‚

---

## 3.4 Determinism

Graph G ãŒ well-formed ã§ã‚ã‚‹ã¨ã¯ã€æ§‹é€ ã¨ Node ã®é·ç§»é–¢æ•°ãŒæ±ºå®šçš„ã§ã‚ã‚Šã€ã‹ã¤ G ãŒ **éå¾ªç’°** ã§ã‚ã‚‹ï¼ˆã¾ãŸã¯å¾ªç’°ã«å¯¾ã—ã¦åˆæœŸå€¤ãŒæ˜ç¤ºçš„ã«ä¸ãˆã‚‰ã‚Œã¦ã„ã‚‹ï¼‰ã¨ãã€æ„å‘³è«– âŸ¦GâŸ§ = (S_G, f_G) ãŒä¸€æ„ã«å®šã¾ã‚‹ã“ã¨ã‚’ã„ã†ã€‚å¾ªç’°ã‚°ãƒ©ãƒ•ã®æ„å‘³è«–ã¯éƒ¨åˆ†çš„ã«ã®ã¿å®šç¾©ã•ã‚Œã‚‹ã€‚Execution Layer ã«ãŠã‘ã‚‹å¾ªç’°ã®æ‰±ã„ã¯ Â§8 ã«å¾“ã†ã€‚

Core Model ã¯æ±ºå®šçš„æ„å‘³è«–ã‚’å‰æã¨ã™ã‚‹ã€‚**Core ã® determinism ã¯ã€Node ã®é·ç§»é–¢æ•° f ãŒæ±ºå®šçš„ã§ã‚ã‚‹å ´åˆã«é™ã‚Šæˆã‚Šç«‹ã¤ã€‚**

---

# 4. Loop

Loop ã¯ Graph ä¸Šã«å®šç¾©ã•ã‚Œã‚‹é«˜éšæ¼”ç®—å­ã§ã‚ã‚‹ã€‚

---

## 4.1 Definition

```
Loop = (G, P)
```

* G : Graph
* P : Y_G â†’ Bool

ãŸã ã— âŸ¦GâŸ§ = (S_G, f_G) ã¨ã™ã‚‹ã€‚

---

## 4.2 Well-formedness Condition

Loop ãŒå®šç¾©å¯èƒ½ã§ã‚ã‚‹ãŸã‚ã«ã¯ï¼š

```
X_G = Y_G
```

ã§ãªã‘ã‚Œã°ãªã‚‰ãªã„ã€‚

ã™ãªã‚ã¡ï¼š

```
f_G : (X_G Ã— S_G) â†’ (X_G Ã— S_G)
```

ã§ã‚ã‚‹ã€‚

---

## 4.3 Semantics

åˆæœŸå…¥åŠ› (xâ‚€, sâ‚€) âˆˆ X_G Ã— S_G ã«å¯¾ã—ï¼š

```
(xâ‚™â‚Šâ‚, sâ‚™â‚Šâ‚) = f_G(xâ‚™, sâ‚™)
```

åœæ­¢æ¡ä»¶ï¼š

```
P(xâ‚™â‚Šâ‚) = true
```

Loop ã¯åæŸã‚’ä¿è¨¼ã—ãªã„ã€‚

---

# 5. Core Invariants

* Node ã¯çŠ¶æ…‹ä»˜ãé·ç§»å™¨ã§ã‚ã‚‹
* Graph ã¯ Node ã®æ¥ç¶šæ§‹é€ ã§ã‚ã‚‹
* ä»»æ„ã® well-formed Graph G ã«å¯¾ã—ã€æ„å‘³è«– âŸ¦GâŸ§ ã¯ä¸€æ„ã«å®šã¾ã‚‹
* Loop ã¯ Graph ã®æ„å‘³è«–ä¸Šã§å®šç¾©ã•ã‚Œã‚‹

Core ã¯ï¼š

* å®Ÿè¡Œé †åº
* æ™‚é–“
* åˆ¶é™
* å®Ÿè£…æ§‹é€ 

ã‚’è¦å®šã—ãªã„ã€‚

---

# 6. Structural Closure

Graph ã®æ„å‘³è«– âŸ¦GâŸ§ ã¯ Node ã§ã‚ã‚‹ã€‚

ã—ãŸãŒã£ã¦ã€Graph ã¯ãã®æ„å‘³è«–ã‚’é€šã˜ã¦ Node ã¨ã—ã¦æ‰±ã†ã“ã¨ãŒã§ãã‚‹ã€‚

ã“ã®æ„å‘³ã§ã€Node ã¨ Graph ã®æ§‹é€ ã¯å†å¸°çš„ã«é–‰ã˜ã¦ã„ã‚‹ã€‚

Core ã¯ã“ã®æ§‹é€ çš„é–‰åŒ…æ€§ã‚’å‰æã¨ã™ã‚‹ã€‚

---

# 7. What Is Not Defined

Core ã¯ä»¥ä¸‹ã‚’å®šç¾©ã—ãªã„ï¼š

* å®Ÿè¡Œé †åº
* æ™‚é–“
* ä¸¦åˆ—æ€§
* å®Ÿè¡Œéç¨‹ã®æ±ºå®šæ€§ï¼ˆè©•ä¾¡é †åºã‚„æ™‚é–“ä¾å­˜æ€§ï¼‰
* åœæ­¢ä¿è¨¼
* åˆ¶é™
* ã‚¨ãƒ©ãƒ¼å‡¦ç†
* å®Ÿè£…ãƒ¢ãƒ‡ãƒ«

æ„å‘³è«– âŸ¦GâŸ§ ã®ä¸€æ„æ€§ã®ã¿ã‚’å‰æã¨ã™ã‚‹ã€‚

---

# 8. Core ã¨ Implementation

Core Model ã¯æŠ½è±¡è¨ˆç®—ãƒ¢ãƒ‡ãƒ«ã§ã‚ã‚‹ã€‚

å®Ÿè£…å±¤ã¯ï¼š

* Node ã‚’å…·ä½“çš„ã«å®Ÿè£…ã™ã‚‹
* Graph ã®æ„å‘³è«– âŸ¦Â·âŸ§ ã‚’å…·ä½“çš„å®Ÿè¡Œæ©Ÿæ§‹ã¨ã—ã¦å®Ÿç¾ã™ã‚‹

Core ã¯å®Ÿè£…å½¢å¼ã‚’åˆ¶é™ã—ãªã„ã€‚

---

# Part II â€” NodeFlow Execution Layer v1.2

æœ¬ç« ã¯ Core Model ã®å…·ä½“å®Ÿè£…ä»•æ§˜ã§ã‚ã‚‹ã€‚BaseNodeã€execute/runã€status ç¨®é¡ã€pauseã€limitã€revisionã€usageã€Runnerã€YAMLã€resume ç­‰ã¯ã™ã¹ã¦ Core ã®ä¸Šã«ç©ã‚“ã åˆ¶å¾¡å±¤ã¨ã—ã¦å®šç¾©ã™ã‚‹ã€‚

---

## 0. Execution Scopeï¼ˆå½¢å¼å®šç¾©ï¼‰

**Execution Scope** ã¨ã¯ã€**ãƒˆãƒƒãƒ—ãƒ¬ãƒ™ãƒ« StructuralNode ã® execute ã® 1 å›ã®å‘¼ã³å‡ºã—ã®ãƒ©ã‚¤ãƒ•ã‚¿ã‚¤ãƒ **ï¼ˆé€šå¸¸ã¯ PipelineNodeï¼›LoopNode ã‚’ãƒˆãƒƒãƒ—ãƒ¬ãƒ™ãƒ«ã¨ã—ã¦ kick ã™ã‚‹ã“ã¨ã‚‚å¯èƒ½ã§ã‚ã‚‹ï¼›ãã®å‘¼ã³å‡ºã—ã«å«ã¾ã‚Œã‚‹ã™ã¹ã¦ã®ãƒã‚¹ãƒˆã—ãŸ StructuralNode ã®å®Ÿè¡Œã‚’å«ã‚€ï¼‰ã‚’æŒ‡ã™ã€‚

```
Execution Scope :=
    the lifetime of a single top-level StructuralNode.execute call
    (typically PipelineNode), including all nested StructuralNodes.

Within one Execution Scope:
- Node instances are reused
- Context is preserved
- revision comparison is valid

Outside this scope:
- revision comparison is undefined
- Node state is discarded
```

åˆ†æ•£å®Ÿè¡Œè¨­è¨ˆã§ã¯ã€Execution Scope ã‚’è¶…ãˆãŸ revision ã®æ¯”è¼ƒã‚’æƒ³å®šã—ãªã„ã“ã¨ã€‚

**ç©º dict `{}` ã®æ‰±ã„ï¼ˆä¿å­˜ã—ãªã„ï¼‰**

If `execute()` returns an empty dictionary (`{}`), the Runner MUST NOT update latest_output for that node.

StructuralNode MUST return `{}` if the final node returns `{}`. No implicit substitution or fallback is allowed.

---

# 1. è¨­è¨ˆåŸå‰‡

## 1.1 åŸºæœ¬æ€æƒ³

æœ¬ä»•æ§˜ã¯ **2 å±¤æ§‹é€ **ã‚’æ¡ç”¨ã™ã‚‹ï¼š(1) **Core Model**ï¼ˆPart Iï¼‰(2) **Execution Layer v1.2**ï¼ˆPart IIï¼‰ã€‚ä»¥ä¸‹ã¯ Execution Layer ã®è¨­è¨ˆåŸå‰‡ã§ã‚ã‚‹ã€‚

**Execution Layer ã§ã¯ã€å®Ÿéš›ã® Node å®Ÿè£…ãŒæ±ºå®šçš„ã§ã‚ã‚‹ä¿è¨¼ã¯ãªã„ã€‚**ï¼ˆLLMNode ç­‰ã¯éæ±ºå®šçš„ã§ã‚‚ã‚ˆã„ã€‚Core ã® determinism ã¯æŠ½è±¡ãƒ¢ãƒ‡ãƒ«ã®å‰æã§ã‚ã‚Šã€å®Ÿè£…å±¤ã®å¥‘ç´„ã§ã¯ãªã„ã€‚ï¼‰

* Everything is a Node
* PipelineNode ã¯ Graph ã‚’ 1-shot å®Ÿè¡Œã™ã‚‹ Nodeã€‚LoopNode ã¯ Graph ã‚’åå¾©å®Ÿè¡Œã™ã‚‹ Nodeã€‚
* **Loop ã‚‚ Node**ï¼ˆLoopNode ã¨ã—ã¦è¡¨ç¾ï¼‰
* Runner is dumb
* ã‚°ãƒ­ãƒ¼ãƒãƒ« Context ã¯å»ƒæ­¢
* ãƒ‡ãƒ¼ã‚¿ã¯ input / output ã®ã¿ã§æµã‚Œã‚‹
* å¾ªç’°ã¯è¨±å¯
* çµ‚äº†ã¯ final ãƒãƒ¼ãƒ‰ï¼ˆgraph ã§æ˜ç¤ºæŒ‡å®šï¼‰ã«ã‚ˆã‚‹
* ä¾‹å¤–ã¯ Node ãŒå¸åã™ã‚‹
* Retry / åˆ†å² / Loop ã‚‚é€šå¸¸ Node ã§è¡¨ç¾ã™ã‚‹
* **revision ã¯ I/O å¥‘ç´„**ï¼ˆNode é–“ã®å¥‘ç´„ã§ã‚ã‚Šã€Runner ã¯è§£é‡ˆã—ãªã„ï¼‰
* **çŠ¶æ…‹ã¯ Node å†…éƒ¨ã«æŒã¤**
* **graceful stop ã‚’åŸºæœ¬ã¨ã™ã‚‹**
* **kill / interrupt ã¯æŒãŸãªã„**

---

## 1.2 å…¨ä½“åƒ

æœ¬ä»•æ§˜ã®æ§‹æˆã¯æ¬¡ã®é †åºã¨ã™ã‚‹ã€‚

* **Part I â€” Core Model**ï¼šæ§‹æ–‡ãƒ»æ„å‘³è«–ï¼ˆNode / Graph / âŸ¦Â·âŸ§ / Loopï¼‰ã€‚å®Ÿè¡Œæˆ¦ç•¥ãƒ»Scheduler ã¯å®šç¾©ã—ãªã„ã€‚
* **Part II â€” NodeFlow Execution Layer v1.2**ï¼šè¨­è¨ˆåŸå‰‡ã€Nodeï¼ˆExecutionï¼‰ã€å…¥å‡ºåŠ›ã€Paramã€Revisionã€BaseNodeã€Runnerã€å¾ªç’°ã€ä¾‹å¤–ã€ã‚¹ã‚³ãƒ¼ãƒ—ã€å®šç¾©ãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆÂ§1ã€œÂ§11ï¼‰
* **Part III â€” Concrete Nodes**ï¼šå„ç¨® DataNodeãƒ»StructuralNodeï¼ˆÂ§12ï¼‰
* **Part IV â€” Invariants**ï¼šä¸å¤‰æ¡ä»¶ï¼ˆÂ§14ï¼‰

ã¾ãš Part I ã§ Core ã‚’æŠŠæ¡ã—ã€Part II ã§ Execution Layer ã®è©³ç´°ã«é€²ã‚€ã€‚**ä¸å¤‰æ¡ä»¶ã¯ Â§14 ã«ã¾ã¨ã‚ã‚‹ã€‚å…ˆã« Â§14 ã‚’ä¸€èª­ã™ã‚‹ã“ã¨ã‚’æ¨å¥¨ã™ã‚‹ã€‚**

---

## 1.3 Node åˆ†é¡ã¨ã‚¯ãƒ©ã‚¹éšå±¤

Node ã¯ **DataNode** ã¨ **StructuralNode** ã«åˆ†é¡ã™ã‚‹ã€‚æ›–æ˜§ã•ã®æ’é™¤ãƒ»å®Ÿè£…ãƒ–ãƒ¬é˜²æ­¢ãƒ»å°†æ¥æ‹¡å¼µã®ãŸã‚ã€ã‚¯ãƒ©ã‚¹éšå±¤ã‚’æ˜ç¤ºã™ã‚‹ã€‚

```text
Node (abstract)
 â”œâ”€â”€ DataNode (abstract)
 â”‚       â”œâ”€â”€ LLMNode
 â”‚       â”œâ”€â”€ ScriptNode
 â”‚       â””â”€â”€ ...
 â”‚
 â””â”€â”€ StructuralNode (abstract)
         â”œâ”€â”€ PipelineNode
         â””â”€â”€ LoopNode
```

| åˆ†é¡ | å½¹å‰² | è©³ç´° |
|------|------|------|
| **DataNode** | run() å®Ÿè£…ã€usage æ›´æ–°ã€limit pre/postã€status è¨­å®šï¼ˆrevision ã¯ BaseNode ãŒ content-hash ã§ä»˜ä¸ï¼‰ | Â§2, Â§6, Â§12 ã®ã€ŒBaseNode ã‚’ç¶™æ‰¿ã™ã‚‹å˜ä½“ Nodeã€ã«ç›¸å½“ã€‚LLMNodeã€ScriptNode ãªã© |
| **StructuralNode** | children ç®¡ç†ã€usage é›†ç´„ã€status é›†ç´„ã€termination åˆ¤å®š | PipelineNodeã€LoopNodeã€‚å­ã‚°ãƒ©ãƒ•ã‚’æŒã¡ã€å­ã®çŠ¶æ…‹ã‚’é›†ç´„ã™ã‚‹ |

å…±é€šã® execute ãƒ¢ãƒ‡ãƒ«ãƒ»statusãƒ»å…¥å‡ºåŠ›ã¯ Â§2ã€œÂ§4 ã«ã€DataNode å›ºæœ‰ã¯ Â§6 ã¨ Â§12.1 å„ç¨® Leaf Node ã«ã€StructuralNode å›ºæœ‰ã¯ Â§12.2 å„ç¨® StructuralNodeï¼ˆÂ§12.2.1 PipelineNodeã€Â§12.2.2 LoopNodeï¼‰ã«è¨˜è¿°ã™ã‚‹ã€‚

---

# 2. Nodeï¼ˆãƒãƒ¼ãƒ‰ãã®ã‚‚ã®ï¼‰

## 2.1 å®Ÿè¡Œã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹

ã™ã¹ã¦ã® Node ã¯ä»¥ä¸‹ã‚’å…¬é–‹ã™ã‚‹ï¼š

```python
execute(inputs: dict, params: dict) -> dict
```

* inputs: ä»–ãƒãƒ¼ãƒ‰ã‹ã‚‰æ¸¡ã•ã‚ŒãŸ JSON ãƒ‡ãƒ¼ã‚¿
* params: é™çš„å®Ÿè¡Œè¨­å®šï¼ˆimmutableï¼‰
* return: å¿…ãš dictï¼ˆJSONï¼‰

**execute ã®æˆ»ã‚Šå€¤å¥‘ç´„ã¯æœ¬ç¯€ã«é›†ç´„ã™ã‚‹ã€‚** ä»–ç¯€ã§ã¯ã€ŒÂ§2.1 å‚ç…§ã€ã¨ã—ã€é‡è¤‡èª¬æ˜ã‚’é¿ã‘ã‚‹ã€‚

**execute ã¯å¸¸ã« dict ã‚’è¿”ã•ãªã‘ã‚Œã°ãªã‚‰ãªã„ã€‚** None ã‚„é dict å‹ã¯ä»•æ§˜é•åã¨ã™ã‚‹ã€‚ã“ã®åˆ¶ç´„ã«ã‚ˆã‚Šã‚¨ãƒ³ã‚¸ãƒ³ã®å®‰å®šæ€§ãŒä¸ŠãŒã‚‹ã€‚æˆåŠŸæ™‚ã¯ output port ã‚’æŒã¤ dictã€åœæ­¢ç³»ã§ã¯ `{}` å¯ï¼ˆè©³ç´°ã¯ Â§2.2, Â§6.4ï¼‰ã€‚

**é‡è¦**ï¼šæˆåŠŸæ™‚ã¯ output port ã‚’æŒã¤ dict ã‚’è¿”ã™ã€‚åœæ­¢ç³»ï¼ˆlimit pre / PauseSignal / fatalã€ãŠã‚ˆã³ limit post ã§ run ãŒæˆåŠŸã—ã¦ã„ãªã„å ´åˆï¼‰ã§ã¯ã€execute ã¯ç©º dict `{}` ã‚’è¿”ã—ã¦ã‚ˆã„ï¼ˆÂ§2.2.1, Â§2.2.2ï¼‰ã€‚limit post ã§ run ãŒæˆåŠŸã—ã¦ã„ã‚‹å ´åˆã¯ã€ãã®å‡ºåŠ›ã‚’è¿”ã™ï¼ˆÂ§2.2.2ï¼‰ã€‚

---

## 2.2 execute / run åˆ†é›¢

### 2.2.1 æˆåŠŸæ™‚

run ãŒæ­£å¸¸çµ‚äº†ã—ãŸå ´åˆï¼š

* dict ã‚’è¿”ã™ï¼ˆå„ output port ã‚’æŒã¤ï¼‰
* å„ output port ã« `_meta.revision` ã‚’ä»˜ä¸ï¼ˆBaseNode ãŒè‡ªå‹•è£œå®Œï¼‰
* status = done

### 2.2.2 åœæ­¢ç³»

ä»¥ä¸‹ã®ã‚±ãƒ¼ã‚¹ã§ã¯ **execute ã¯ç©º dict `{}` ã‚’è¿”ã—ã¦ã‚ˆã„**ï¼š

* limitï¼ˆlimit post ä»¥å¤–ã€‚limit post ã®æ‰±ã„ã¯æ¬¡é …ï¼‰
* PauseSignal
* fatal
* limit postï¼ˆ**run ãŒæˆåŠŸã—ã¦ã„ãªã„å ´åˆã®ã¿** `{}`ã€‚run ãŒæˆåŠŸã—ã¦ã„ã‚‹å ´åˆã¯ãã®å‡ºåŠ›ã‚’è¿”ã™ï¼‰

**limit post ã®æ˜ç¢ºåŒ–**ï¼šlimit post ã«ã¯ (1) run æˆåŠŸå¾Œã® limit è¶…é ã¨ (2) run æœªå®Ÿè¡Œã§ã® limit è¶…é ãŒã‚ã‚‹ã€‚run ãŒæˆåŠŸã—ã¦ã„ã‚‹å ´åˆã¯ã€ãã®å‡ºåŠ›ã‚’è¿”ã™ã€‚run ãŒæˆåŠŸã—ã¦ã„ãªã„å ´åˆã®ã¿ `{}` ã‚’è¿”ã—ã¦ã‚ˆã„ã€‚**StructuralNode ã«ãŠã‘ã‚‹ã€Œrun ãŒæˆåŠŸã—ãŸã€ã®å®šç¾©ã¯ Â§6.7 ã«è¨˜è¼‰ã™ã‚‹ã€‚**

```python
return {}
```

status ã¯ãã‚Œãã‚Œï¼š

* limit
* pause
* fatal

ã«è¨­å®šã•ã‚Œã‚‹ã€‚ã„ãšã‚Œã®åœæ­¢ç³»ã§ã‚‚ execute ã®è¿”ã‚Šå€¤ã¯ `{}` ã§ã‚ˆã„ã€‚

**execute å…±é€šä»•æ§˜**ï¼šexecute ã¯ **ready ã¾ãŸã¯ done ã®ã¨ãã«é€šå¸¸çµŒè·¯ã§å‘¼ã¹ã‚‹**ï¼ˆdone ã® Node ã¯å†å®Ÿè¡Œå¯èƒ½ã€‚pause ã¯ resume çµŒç”±ã®ã¿ã€‚Â§2.3.2ï¼‰ã€‚å…±é€šå‡¦ç†ã®æµã‚Œã¯ã€Œready â†’ executing â†’ _execute_impl() ç›¸å½“ï¼ˆrun å‘¼ã³å‡ºã—ï¼‹limit pre/postï¼‰â†’ ä¾‹å¤–ã‚’ status ã«å¤‰æ› â†’ dict ã‚’è¿”ã™ã€ã€‚

**ä¾‹å¤– â†’ status å¤‰æ›**ï¼ˆrun å†…ã®ä¾‹å¤–ãŠã‚ˆã³ BaseNode ã® limit æ¤œå‡ºï¼‰ï¼š

| åŸå›  | status |
|------|--------|
| PauseSignal | pause |
| LimitSignalï¼ˆrun å†…ã‹ã‚‰ raiseï¼‰ã¾ãŸã¯ limit pre/post æ¤œå‡º | limit |
| ãã®ä»– Exception | fatal |

execute ã¯å¸¸ã« dict ã‚’è¿”ã™ã€‚LimitSignal ã¯ BaseNode ãŒæä¾›ã™ã‚‹çµ„ã¿è¾¼ã¿ä¾‹å¤–ã€‚run å†…ã‹ã‚‰ raise ã™ã‚‹ã“ã¨ã§ limit ã‚’å®£è¨€ã§ãã‚‹ï¼ˆlimit pre/post ã§æ¤œå‡ºã™ã‚‹å¾“æ¥æ–¹å¼ã¨ä½µç”¨å¯èƒ½ï¼‰ã€‚è©³ç´°ã¯ Â§6.3ã€‚

---

BaseNode ã¯ execute ã‚’å…±é€šå®Ÿè£…ã—ã€ã‚µãƒ–ã‚¯ãƒ©ã‚¹ã¯ run ã®ã¿å®Ÿè£…ã™ã‚‹ï¼ˆè©³ç´°ã¯ Â§6ï¼‰ã€‚**execute ã®æµã‚Œãƒ»ãƒ•ãƒ­ãƒ¼å›³ã¯æœ¬ç¯€ï¼ˆÂ§2.2ï¼‰ã«å®Œå…¨ã«é›†ç´„ã™ã‚‹ã€‚** Â§6.3 ã¯ BaseNode å®Ÿè£…ä¸Šã®è£œè¶³ã®ã¿ã¨ã™ã‚‹ã€‚

**å®Ÿè¡Œã®æµã‚Œ**

1. æœ€åˆã« **status = executing** ã«ã™ã‚‹ã€‚
2. **å®Ÿè¡Œä¸­**ã€æ¬¡ã®ã„ãšã‚Œã‹ã§çµ‚äº†ã™ã‚‹ï¼š
   * **å•é¡Œï¼ˆä¾‹å¤–ï¼‰** â†’ status ã‚’ **fatal** ã«ã—ã¦çµ‚äº†ï¼ˆè¿”ã‚Šå€¤ã¯ `{}` å¯ï¼‰
   * **limit pre ã§ã²ã£ã‹ã‹ã£ãŸ** â†’ status ã‚’ **limit** ã«ã—ã¦çµ‚äº†ï¼ˆè¿”ã‚Šå€¤ã¯ `{}` å¯ï¼‰
   * **limit post ã§ã²ã£ã‹ã‹ã£ãŸ** â†’ status ã‚’ **limit** ã«ã—ã¦çµ‚äº†ï¼ˆrun æˆåŠŸæ™‚ã¯ãã® dict ã‚’è¿”ã™ã€run æœªæˆåŠŸæ™‚ã¯ `{}` å¯ï¼‰
   * **run ãŒ PauseSignal ã‚’ raise ã—ãŸ** â†’ status ã‚’ **pause** ã«ã—ã¦çµ‚äº†ï¼ˆè¿”ã‚Šå€¤ã¯ `{}` å¯ï¼‰
   * **run ãŒ LimitSignal ã‚’ raise ã—ãŸ** â†’ status ã‚’ **limit** ã«ã—ã¦çµ‚äº†ï¼ˆè¿”ã‚Šå€¤ã¯ `{}` å¯ï¼‰
   * **æœ€å¾Œã¾ã§å•é¡Œãªãå‹•ã„ãŸ** â†’ status ã‚’ **done** ã«ã—ã¦çµ‚äº†ï¼ˆdict ã‚’è¿”ã™ï¼‰
3. status ã¯ **read_status()** ã§èª­ã‚€ã ã‘ï¼ˆåˆ¶å¾¡ã§ã¯ãªã„ï¼‰ã€‚execute ã®è¿”ã‚Šå€¤ã«ã¯å«ã‚ãªã„ã€‚

**PauseSignal**ï¼šBaseNode ãŒæä¾›ã™ã‚‹çµ„ã¿è¾¼ã¿ä¾‹å¤–ã€‚run å†…ã‹ã‚‰ raise ã™ã‚‹ã“ã¨ã§ pause ã‚’å®£è¨€ã™ã‚‹ã€‚PauseSignal ä»¥å¤–ã®ä¾‹å¤–ã¯ã™ã¹ã¦ fatal ã¨ã—ã¦æ‰±ã†ã€‚run ã®æˆ»ã‚Šå€¤ã«ã‚ˆã‚‹ pause è¡¨ç¾ã¯æ¡ç”¨ã—ãªã„ï¼ˆæˆ»ã‚Šå€¤ã¯å¸¸ã« dictï¼‰ã€‚

**pause ã®æ€§è³ª**

* Node ã¯å†…éƒ¨çŠ¶æ…‹ï¼ˆLLM ã‚»ãƒƒã‚·ãƒ§ãƒ³å±¥æ­´ãªã©ï¼‰ã‚’ä¿æŒã—ãŸã¾ã¾åœæ­¢ã™ã‚‹ã€‚pause ã¯ã€Œå®Ÿè¡Œæœªå®Œäº†ã€ã§ã¯ãªã**ä¸­æ–­çŠ¶æ…‹ã§å®‰å®šã—ã¦ã„ã‚‹**çŠ¶æ…‹ã§ã‚ã‚‹ã€‚
* execute ã®è¿”ã‚Šå€¤ã¯ `{}`
* Runner ã¯ãã®ãƒãƒ¼ãƒ‰ã‚’å†ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã—ãªã„
* å†é–‹ã¯å¤–éƒ¨ã‹ã‚‰ PipelineNode ã® `resume()` ã‚’å‘¼ã¶ã“ã¨ã§ã®ã¿è¡Œã†ï¼ˆÂ§12.2.1.5ï¼‰ã€‚resume_inputs_schema ã¯å¤–éƒ¨ã«ã€Œä½•ã‚’æ¸¡ã›ã°ã‚ˆã„ã‹ã€ã‚’ä¼ãˆã‚‹å‚è€ƒæƒ…å ±ã§ã‚ã‚Šã€ã‚¨ãƒ³ã‚¸ãƒ³ã¯è§£é‡ˆã—ãªã„ã€‚

```python
# BaseNode ãŒæä¾›ã™ã‚‹çµ„ã¿è¾¼ã¿ä¾‹å¤–
class PauseSignal(Exception):
    """
    run() å†…ã‹ã‚‰ raise ã™ã‚‹ã“ã¨ã§ pause ã‚’å®£è¨€ã™ã‚‹ã€‚
    Node ã¯å†…éƒ¨çŠ¶æ…‹ã‚’ä¿æŒã—ãŸã¾ã¾åœæ­¢ã™ã‚‹ã€‚
    resume_inputs_schema ã¯å¤–éƒ¨ã«ã€Œä½•ã‚’æ¸¡ã›ã°ã‚ˆã„ã‹ã€ã‚’ä¼ãˆã‚‹å‚è€ƒæƒ…å ±ã€‚
    ã‚¨ãƒ³ã‚¸ãƒ³ã¯ã“ã‚Œã‚’è§£é‡ˆã—ãªã„ã€‚
    """
    def __init__(self, reason: str = "", resume_inputs_schema: dict = None):
        self.reason = reason
        self.resume_inputs_schema = resume_inputs_schema or {}

class LimitSignal(Exception):
    """run() å†…ã‹ã‚‰ raise ã™ã‚‹ã“ã¨ã§ limit ã‚’å®£è¨€ã™ã‚‹ã€‚limit pre/post ã«ã‚ˆã‚‹æ¤œå‡ºã¨ä½µç”¨å¯èƒ½ã€‚"""
    def __init__(self, reason: str = ""):
        self.reason = reason
```

```
execute(inputs, params)
  â”œ params = _freeze(params)   # shallow freezeï¼ˆÂ§4.4ï¼‰
  â”œ status = executing
  â”œ limit pre          â†’ è¶…éãªã‚‰ status = limit, return {} å¯
  â”œ run(inputs, params)
  â”‚   â”œ PauseSignal   â†’ status = pause, return {} å¯
  â”‚   â”œ LimitSignal   â†’ status = limit, return {} å¯ï¼ˆrevision è£œå®Œãƒ»limit post ã‚’ã‚¹ã‚­ãƒƒãƒ—ã€‚Â§6.3 â‘¡ï¼‰
  â”‚   â”œ ãã®ä»–ä¾‹å¤–    â†’ status = fatal, return {} å¯
  â”‚   â”” dict è¿”å´    â†’ æ­£å¸¸ç¶™ç¶š
  â”œ revision è£œå®Œ
  â”œ limit post         â†’ è¶…éãªã‚‰ status = limit; run æˆåŠŸæ™‚ã¯ revision è£œå®Œæ¸ˆã¿ dict ã‚’è¿”å´, run æœªæˆåŠŸæ™‚ã¯ return {} å¯
  â”œ status = done
  â”” return dict
```

* limit pre: å®Ÿè¡Œå‰ã® limit ãƒã‚§ãƒƒã‚¯ã€‚è¶…éæ™‚ã¯ run ã‚’å‘¼ã°ãš status = limitã€return `{}` å¯ã€‚
* limit post: å®Ÿè¡Œå¾Œã® limit ãƒã‚§ãƒƒã‚¯ã€‚è©³ç´°ã¯ Â§6.3 â‘£ å‚ç…§ã€‚
* run: ãƒãƒ¼ãƒ‰å›ºæœ‰å‡¦ç†ã€‚PauseSignal ã‚’ raise ã™ã‚Œã° status = pauseã€‚LimitSignal ã‚’ raise ã™ã‚Œã° status = limitï¼ˆrevision è£œå®Œãƒ»limit post ã¯ã‚¹ã‚­ãƒƒãƒ—ï¼‰ã€‚ãã®ä»–ã®ä¾‹å¤–ã¯ execute ãŒå¸åã— status = fatalã€‚
* revision è£œå®Œ: æ¬ è½æ™‚ã¯ BaseNode ãŒè‡ªå‹•ä»˜ä¸ã€‚

Runner ã¯ execute ã®ã¿å‘¼ã¶ã€‚

---

## 2.3 Node çŠ¶æ…‹ãƒ¢ãƒ‡ãƒ«ï¼ˆç¢ºå®šï¼‰

### 2.3.1 Node ãŒæŒã¤çŠ¶æ…‹

Node ã¯å†…éƒ¨ã« **status**ï¼ˆäºˆç´„ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã§ã¯ãªã„ã€‚å†…éƒ¨çŠ¶æ…‹ï¼‰ã‚’æŒã¤ã€‚çŠ¶æ…‹é›†åˆã¯ **ready, executing, done, pause, limit, fatal** ã® 6 å€¤ã¨ã™ã‚‹ã€‚**å†…éƒ¨å®Ÿè£…ã§ã¯ Enum ã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨ã‚’æ¨å¥¨ã™ã‚‹ã€‚** å¤–éƒ¨ APIï¼ˆread_status() ã®æˆ»ã‚Šå€¤ãªã©ï¼‰ã¯ string ã¨ã—ã€"done" / "Done" / "completed" ãªã©ã®è¡¨è¨˜ã‚†ã‚Œã‚’é˜²ãã€‚

**çŠ¶æ…‹é·ç§»ï¼ˆFSMï¼‰**

**DataNode**ï¼ˆå˜ä½“ Nodeï¼‰ï¼š

```
ready â†’ executing
executing â†’ done
executing â†’ pause
executing â†’ limit
executing â†’ fatal
pause â†’ executingï¼ˆresume çµŒç”±ã®ã¿ã€‚Â§12.2.1.5ï¼‰
```

**StructuralNode**ï¼šåŒæ§˜ã ãŒã€done ã¯å­ã®çŠ¶æ…‹é›†ç´„ã§æ±ºå®šã™ã‚‹ï¼ˆÂ§6.7ï¼‰ã€‚

```
ready â†’ executing â†’ done
                     â†˜ fatal
                     â†˜ pause â†’ executingï¼ˆresume çµŒç”±ã€‚Â§12.2.1.5ï¼‰
                     â†˜ limit
```

| status    | æ„å‘³                   |
| --------- | ---------------------- |
| ready     | å®Ÿè¡Œå¾…ã¡               |
| executing | å®Ÿè¡Œä¸­                 |
| done      | å®Ÿè¡Œå®Œäº†ï¼ˆå†å®Ÿè¡Œå¯èƒ½ï¼‰ |
| pause     | ä¸€æ™‚åœæ­¢è¦æ±‚           |
| limit     | limit åˆ°é”             |
| fatal     | ç•°å¸¸çµ‚äº†               |

**status ã®åˆ¶ç´„**

* status ã¯ Node è‡ªèº«ã®ã¿ãŒå¤‰æ›´å¯èƒ½
* StructuralNode ã¯å­ã® status ã‚’ç›´æ¥å¤‰æ›´ã—ã¦ã¯ãªã‚‰ãªã„ï¼ˆå­ã¯ black-boxï¼‰
* done / limit / fatal â†’ ready ã®é·ç§»ã¯ç¦æ­¢ï¼ˆreset ã—ãªã„ï¼‰
* pause â†’ executing ã¯ resume çµŒç”±ã®ã¿

### 2.3.2 é‡è¦ãªæ€§è³ª

* **done ã¯çµ‚ç«¯çŠ¶æ…‹ã§ã¯ãªã„** â€” execute ã¯ **readyãƒ»doneãƒ»pauseï¼ˆresume çµŒç”±ã®ã¿ã€‚Â§12.2.1.5ï¼‰** ã®ã¨ãã«å‘¼ã¹ã‚‹ã€‚**é€šå¸¸ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒªãƒ³ã‚°ã§ã¯ ready / done ã®ã¿ãŒ execute ã•ã‚Œã‚‹ã€‚pause ã¯ resume çµŒç”±ã®ã¿ã€‚**
* execute å‘¼ã³å‡ºã—æ™‚ã« status ã¯ executing ã«ãªã‚‹
* **reset ã¯ä¸è¦**
* **execution_id ã¯ä¸è¦**
* Node ã¯å†å®Ÿè¡Œå¯èƒ½ã§ã‚ã‚Šã€done ã¯å†å®Ÿè¡Œå¯èƒ½ãªçŠ¶æ…‹ã§ã‚ã‚‹

**Re-execution Semantics**ï¼š`execute(node, inputs, params)` ã¯ã€inputs ãŒåŒä¸€ã§ã‚‚**å†…éƒ¨çŠ¶æ…‹ã«å¿œã˜ã¦ç•°ãªã‚‹å‡ºåŠ›**ã‚’è¿”ã—å¾—ã‚‹ã€‚Core Model ã¯ referential transparency ã‚’ä¿è¨¼ã—ãªã„ã€‚

### 2.3.3 read_status()

* status ã¯å‡ºåŠ›ã§ã¯ãªã„ â€” execute ã®æˆ»ã‚Šå€¤ã«ã¯å«ã¾ã‚Œãšã€å†…éƒ¨çŠ¶æ…‹ã§ã‚ã‚‹
* read_status() ã§èª­ã‚€ã ã‘ï¼ˆåˆ¶å¾¡ã§ã¯ãªã„ã€‚å˜ã« status ã‚’å–å¾—ã™ã‚‹ APIï¼‰
* çŠ¶æ…‹ã¯ã‚¤ãƒ™ãƒ³ãƒˆã§ã¯ãªãã€ŒçŠ¶æ…‹ã€ã¨ã—ã¦ä¿æŒã•ã‚Œã‚‹

Runner ã¯ read_status() ã§ status ã‚’èª­ã‚€ã€‚åˆ¶å¾¡ã¯ StructuralNodeï¼ˆÂ§6.7ï¼‰ãŒè¡Œã†ã€‚

---

# 3. å…¥å‡ºåŠ›ãƒ¢ãƒ‡ãƒ«

## 3.1 inputs

Graph å®šç¾©ï¼ˆgraph / node_pipeline.yamlï¼‰ã§ãƒã‚¤ãƒ³ãƒ‡ã‚£ãƒ³ã‚°ã•ã‚Œã‚‹ã€‚

```yaml
inputs:
  key: ${node_id.port}
```

å‚ç…§å½¢å¼ï¼š

* `${node_id.port}` â€” ä»–ãƒãƒ¼ãƒ‰ã® output port ã‚’å‚ç…§
* `${inputs.port}` â€” è¦ª StructuralNodeï¼ˆã¾ãŸã¯å¤–éƒ¨ã‹ã‚‰æ¸¡ã•ã‚ŒãŸï¼‰inputs ã® port ã‚’å‚ç…§ï¼ˆÂ§10.2ï¼‰
* `${params.<param_name>}` â€” è¦ª StructuralNodeï¼ˆPipelineNode / LoopNodeï¼‰ã® params ã‚’å‚ç…§ï¼ˆÂ§4, Â§12.2.1.2ï¼‰

åˆ¶ç´„ï¼š

* port çœç•¥ç¦æ­¢
* **æœªå®šç¾©å‚ç…§ã¯ä¾‹å¤–ã‚’æŠ•ã’ãªã„ã€‚å½“è©²ãƒãƒ¼ãƒ‰ã¯ã€Œå®Ÿè¡Œä¸èƒ½ã€ã¨ã—ã¦æ‰±ã†ã€‚fatal ã¨ã¯ã—ãªã„ã€‚**ï¼ˆRunner ã¯ä¾‹å¤–å‡¦ç†ã‚’ã—ãªã„ãŸã‚ã€‚max_idle_sec ã‚„ limit ã«å§”ã­ã‚‹ã€‚Â§7.5ï¼‰
* Node ã¯ inputs / params ä»¥å¤–ã‚’å‚ç…§ã—ã¦ã¯ãªã‚‰ãªã„ï¼ˆè©³ç´°ã¯ Â§10 ã‚¹ã‚³ãƒ¼ãƒ—ãƒ«ãƒ¼ãƒ«ï¼‰

---

## 3.2 outputs

Node ã¯å¿…ãš dict ã‚’è¿”ã™ï¼ˆÂ§2.1ï¼‰ã€‚

å„ key ãŒ output port ã§ã‚ã‚‹ã€‚

å„ port ã®å€¤ã¯ `_meta.revision` ã‚’å†…éƒ¨ã«æŒã¤ã€‚

ä¾‹ï¼š

```json
{
  "artifact": {
    "_meta": { "revision": 1 },
    "data": {...}
  }
}
```

ä»•æ§˜ï¼š

* ã™ã¹ã¦ã® output port ã¯ `_meta.revision` ã‚’æŒã¤ï¼ˆBaseNode ãŒ content-hash ã§è‡ªå‹•ä»˜ä¸ã€‚Â§5.7ï¼‰
* `_meta` ã¯äºˆç´„ã‚­ãƒ¼
* `_meta.revision` ã¯ content-hashï¼ˆSHA-256 ã® hex æ–‡å­—åˆ—ã€64 æ–‡å­—ã€‚Â§5.10ï¼‰
* revision ã¯åŒä¸€å†…å®¹â†’åŒä¸€å€¤ï¼ˆé †åºãƒ»å˜èª¿å¢—åŠ ã¯è¡¨ã•ãªã„ã€‚Â§5.1.1ï¼‰

---

## 3.3 å‡ºåŠ›ä¿æŒãƒ«ãƒ¼ãƒ«

Runner ã¯ï¼š

* å„ node ã®æœ€æ–°å‡ºåŠ›ã®ã¿ä¿æŒ
* å±¥æ­´ã¯ä¿æŒã—ãªã„

**Runner ã®å‡ºåŠ›ä¿å­˜ãƒ«ãƒ¼ãƒ«ï¼ˆç¢ºå®šï¼‰**

Runner ã¯ node.execute() ã®è¿”ã‚Šå€¤ã‚’å—ã‘å–ã‚‹ãŒï¼š

### ğŸ”´ ç©º dict ã¯ä¿å­˜ã—ãªã„

```python
output = node.execute(...)
if output != {}:
    latest_output[node_id] = output
```

**æ„å‘³**

* `{}` ã¯ã€Œå‡ºåŠ›ãªã—ã€ã‚’æ„å‘³ã™ã‚‹
* æ—¢å­˜ã® latest_output ã‚’ä¸Šæ›¸ãã—ãªã„
* å‡ºåŠ›ã¯æ¶ˆãˆãªã„

**ä»•æ§˜ã¨ã—ã¦ã®ä¸€æ–‡**

> BaseNode.execute ãŒç©º dict `{}` ã‚’è¿”ã—ãŸå ´åˆã€Runner ã¯å½“è©²ãƒãƒ¼ãƒ‰ã®æœ€æ–°å‡ºåŠ›ã‚’æ›´æ–°ã—ãªã„ã€‚

**limit post ã§å‡ºåŠ›ãŒè¿”ã£ã¦ããŸå ´åˆ**ï¼šRunner ã¯ãã®å‡ºåŠ›ã‚’é€šå¸¸ã©ãŠã‚Šä¿å­˜ã™ã‚‹ã€‚limit pre / limit post ã®æ‰±ã„ã®è©³ç´°ã¯ Â§6.3 â‘£ å‚ç…§ã€‚

å±¥æ­´ãŒå¿…è¦ãªå ´åˆï¼š

* Node è‡ªèº«ãŒå‡ºåŠ›ã™ã‚‹
* ãƒãƒƒãƒ•ã‚¡å°‚ç”¨ Node ã‚’ç”¨ã„ã‚‹

---

## 3.4 å‡ºåŠ›æ›´æ–°ã®æ„å‘³ã¨ã€Œå‡ºåŠ›ãŒãªã„ã€çŠ¶æ…‹

**å‡ºåŠ›ãŒæ›´æ–°ã•ã‚Œã‚‹ã®ã¯**ï¼šrun ãŒæˆåŠŸã—ã€æ–°ã—ã„ output port ãŒç”Ÿæˆã•ã‚ŒãŸå ´åˆã®ã¿ã€‚åœæ­¢çŠ¶æ…‹ï¼ˆpause / limit / fatalï¼‰ã¯å‡ºåŠ›ã®æ›´æ–°ã‚’ä¼´ã‚ãªã„åˆ¶å¾¡çŠ¶æ…‹ã§ã‚ã‚‹ã€‚

**`{}` ã®æ„å‘³**ï¼šæ–°ã—ã„å‡ºåŠ›ãŒç”Ÿæˆã•ã‚Œãªã‹ã£ãŸã“ã¨ã‚’è¡¨ã™ã€‚ãƒ‡ãƒ¼ã‚¿å‰Šé™¤ã§ã¯ãªã„ã€‚no-op ã¨åŒç¾©ã€‚**ç©º dict ã®ä¿å­˜ãƒ«ãƒ¼ãƒ«ã¯ Â§3.3 å‚ç…§ã€‚**

---

## 3.5 status ã¨ Flow åˆ¶å¾¡

status ã®å®šç¾©ãƒ»kind ã®æ„å‘³ãƒ»çŠ¶æ…‹é·ç§»ã¯ **Â§2.3 Node çŠ¶æ…‹ãƒ¢ãƒ‡ãƒ«** ã«ã¾ã¨ã‚ã‚‹ã€‚status ã¯äºˆç´„ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã§ã¯ãªãã€Node ã®å†…éƒ¨çŠ¶æ…‹ã§ã‚ã‚‹ã€‚read_status() ã§èª­ã‚€ã€‚execute ã®è¿”ã‚Šå€¤ã§ã¯ãªã„ã€‚

* **Runner ã¯ status ã®æ„å‘³ï¼ˆåˆ¶å¾¡ï¼‰ã¯è§£é‡ˆã—ãªã„ã€‚** ãŸã ã—å®Ÿè¡Œå¯èƒ½åˆ¤å®šã®ãŸã‚ã€çŠ¶æ…‹å€¤ã¯å‚ç…§ã™ã‚‹ã€‚åˆ¶å¾¡ã¯ StructuralNode ãŒ read_status() ã§ status ã‚’èª­ã¿è¡Œã†ï¼ˆÂ§6.7, Â§7.3ï¼‰ã€‚

è¨­è¨ˆä¸Šã®åŠ¹æœï¼šå‡ºåŠ›ï¼ˆoutput portï¼‰ã¨åˆ†é›¢ã—ã€revision ãƒ¢ãƒ‡ãƒ«ã‚’æ±šã•ãšã€error ã¨ control ã‚’çµ±ä¸€çš„ã«æ‰±ãˆã‚‹ã€‚

---

## 3.6 åˆ¶å¾¡ã¨ãƒ‡ãƒ¼ã‚¿ã®å®Œå…¨åˆ†é›¢ï¼ˆã“ã®è¨­è¨ˆã®æ€§è³ªï¼‰

âœ… last_output ã‚’ Node ãŒæŒãŸãªã„  
âœ… å‡ºåŠ›æ¶ˆå¤±ãŒèµ·ããªã„  
âœ… revision å¥‘ç´„ã‚’ç ´ã‚‰ãªã„  
âœ… Loop ã® condition ã¨è¡çªã—ãªã„  
âœ… Runner ã¯ dumb ã®ã¾ã¾  
âœ… çŠ¶æ…‹ã¨ãƒ‡ãƒ¼ã‚¿ãŒå®Œå…¨åˆ†é›¢  

| ç¨®é¡     | è¡¨ç¾                   |
| -------- | ---------------------- |
| ãƒ‡ãƒ¼ã‚¿   | execute ã®æˆ»ã‚Š dict    |
| åˆ¶å¾¡     | read_status()          |
| åœæ­¢     | status                 |
| å‡ºåŠ›æ›´æ–° | output != {} ã®ã¨ãã®ã¿ |

ã“ã‚Œã«ã‚ˆã‚Š v1.2 ã¯ **ä¸€è²«ã—ãŸ I/O ãƒ¢ãƒ‡ãƒ«** ã¨ãªã‚‹ã€‚

---

## 3.7 usage ä»•æ§˜

**usage ã®å®šç¾©ãƒ»æ‰€æœ‰è€…ãƒ»èª­ã¿æ›¸ãä¸»ä½“ãƒ»ç´¯ç©ãƒ«ãƒ¼ãƒ«ã¯ Â§3.9.2 ã«ã¾ã¨ã‚ã‚‹ã€‚** æœ¬ç¯€ã¯ API ã¨é›†ç´„ãƒ«ãƒ¼ãƒ«ã®ã¿ã¨ã™ã‚‹ã€‚

**å‹ï¼ˆå‚è€ƒï¼‰**ï¼š

```python
class Usage:
    add(metric, value)
    merge(other)
    snapshot()
```

**æ›´æ–°ç²’åº¦**ï¼šrun å˜ä½ã€ã¾ãŸã¯ãã‚Œä»¥ä¸‹ã®ç²’åº¦ã€‚æ¶ˆè²»æ™‚ç‚¹ã§åŠ ç®—ã€‚execute å˜ä½ã§ã¯ãªã„ã€‚

**ç´¯ç©**ï¼šusage ã¯ç´¯ç©å€¤ã€‚reset ã—ãªã„ã€‚iteration å˜ä½ã®å€¤ã¯ snapshot å·®åˆ†ã§å–å¾—ã™ã‚‹ã€‚

**merge ã®æ„å‘³è«–**ï¼š`Usage.merge(other)` ã¯ä»¥ä¸‹ã®è¦å‰‡ã§é›†ç´„ã™ã‚‹ã€‚åŒä¸€ metric ãŒä¸¡æ–¹ã«å­˜åœ¨ã™ã‚‹å ´åˆã¯åŠ ç®—ã™ã‚‹ã€‚ç‰‡æ–¹ã«ã—ã‹å­˜åœ¨ã—ãªã„ metric ã¯ãã®ã¾ã¾å¼•ãç¶™ãã€‚metric åã¯æ–‡å­—åˆ—ã§è­˜åˆ¥ã™ã‚‹ã€‚

**é›†ç´„**ï¼šStructuralNode ã¯ `child.read_usage()` ã‚’é›†ç´„ã™ã‚‹ã€‚Runner ã¯ usage ã‚’è§¦ã‚‰ãªã„ï¼ˆÂ§7.2ï¼‰ã€‚**state / usage / Context ã®å³å¯†ãªå®šç¾©ã¯ Â§3.9 å®Ÿè¡ŒçŠ¶æ…‹ãƒ¢ãƒ‡ãƒ«ã«ã¾ã¨ã‚ã‚‹ã€‚**

---

## 3.8 node_calls ã®å®šç¾©

**node_calls** ã¨ã¯ã€`BaseNode.execute()` ãŒå‘¼ã³å‡ºã•ã‚ŒãŸå›æ•°ã‚’æŒ‡ã™ã€‚

å®šç¾©ï¼š

```
node_calls := number of times BaseNode.execute() is invoked,
              across all Nodes within the Execution Scope.
```

**ã‚«ã‚¦ãƒ³ãƒˆã®è¦å‰‡**

* **ã‚¤ãƒ³ã‚¯ãƒªãƒ¡ãƒ³ãƒˆã‚¿ã‚¤ãƒŸãƒ³ã‚°**ï¼šnode_calls ã¯ execute() ã®**å…¥å ´æ™‚**ï¼ˆlimit pre è©•ä¾¡ã®å‰ï¼‰ã« 1 åŠ ç®—ã™ã‚‹ã€‚ã“ã®ãŸã‚ limit pre ã§å³ `{}` ã‚’è¿”ã—ãŸå ´åˆã‚‚ 1 call ã¨ã—ã¦ã‚«ã‚¦ãƒ³ãƒˆã•ã‚Œã€max_total_node_calls ã«ã‚ˆã‚‹ä¿è­·ãŒæ­£ç¢ºã«æ©Ÿèƒ½ã™ã‚‹ã€‚
* DataNode ã® execute() å‘¼ã³å‡ºã— 1 å› = 1 call
* StructuralNode ã® execute() å‘¼ã³å‡ºã— 1 å› = 1 callï¼ˆå†…éƒ¨ã®å­ Node ã® call ã¨ã¯åˆ¥ã«ã‚«ã‚¦ãƒ³ãƒˆï¼‰
* resume() çµŒç”±ã§å‘¼ã°ã‚ŒãŸ execute() ã‚‚ã‚«ã‚¦ãƒ³ãƒˆå¯¾è±¡
* limit pre ã§å³ `{}` ã‚’è¿”ã—ãŸ execute() ã‚‚ã‚«ã‚¦ãƒ³ãƒˆå¯¾è±¡ï¼ˆexecute ãŒå‘¼ã°ã‚ŒãŸäº‹å®Ÿã‚’ã‚«ã‚¦ãƒ³ãƒˆã™ã‚‹ï¼‰

**é›†ç´„**

StructuralNode ã¯é…ä¸‹ã®å…¨ Nodeï¼ˆè‡ªèº«ã‚’å«ã‚€ï¼‰ã® node_calls ã‚’é›†ç´„ã™ã‚‹ã€‚é›†ç´„ã¯ `child.read_node_calls()` ã«ã‚ˆã‚Šè¡Œã†ã€‚Runner ã¯ node_calls ã‚’ç®¡ç†ã—ãªã„ã€‚

**`max_total_node_calls`**ï¼ˆÂ§12.2.1.9ï¼‰ã¯ã€å½“è©² Execution Scope å†…ã®é›†ç´„ node_calls ãŒã“ã®å€¤ã«é”ã—ãŸæ™‚ç‚¹ã§ status = limit ã¨ã™ã‚‹ã€‚

---

## 3.9 å®Ÿè¡ŒçŠ¶æ…‹ãƒ¢ãƒ‡ãƒ«ï¼ˆState / Usage / Contextï¼‰

NodeFlow v1.2 ã§ã¯ã€å®Ÿè¡Œä¸­ã®å¯å¤‰æƒ…å ±ã‚’ **state / usage / Context** ã® 3 ç¨®é¡ã«åˆ†é¡ã™ã‚‹ã€‚ãã‚Œãã‚Œã®è²¬å‹™ãƒ»æ‰€æœ‰è€…ãƒ»å¯è¦–ç¯„å›²ã‚’å³å¯†ã«åˆ†é›¢ã™ã‚‹ã€‚

> **è¦ç´„**ï¼šstate ã¯å› æœæƒ…å ±ã€usage ã¯è¦³æ¸¬æƒ…å ±ã€Context ã¯å®Ÿè¡Œç’°å¢ƒæƒ…å ±ã§ã‚ã‚‹ã€‚

---

### 3.9.1 stateï¼ˆNode å†…éƒ¨çŠ¶æ…‹ï¼‰

**å®šç¾©**

state ã¨ã¯ã€**Node ã®å®Ÿè¡Œãƒ­ã‚¸ãƒƒã‚¯ã«å½±éŸ¿ã™ã‚‹å†…éƒ¨å¯å¤‰çŠ¶æ…‹**ã‚’æŒ‡ã™ã€‚

ä¾‹ï¼šLLM ã‚»ãƒƒã‚·ãƒ§ãƒ³å±¥æ­´ã€å‰å›å‡¦ç†ã—ãŸ revisionã€iteration ã‚«ã‚¦ãƒ³ã‚¿ã€human review å¾…æ©Ÿãƒ•ãƒ©ã‚°ã€ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã€‚

state ã«ã¯ã€å®Ÿè¡Œãƒ­ã‚¸ãƒƒã‚¯ã«å½±éŸ¿ã™ã‚‹å¯å¤‰çŠ¶æ…‹ã®ã»ã‹ã€**è¨ºæ–­ç›®çš„ã®å®Ÿè¡Œçµæœæƒ…å ±ï¼ˆfatal åŸå› ä¾‹å¤–ç­‰ï¼‰**ã‚’å«ã‚ã¦ã‚ˆã„ã€‚è¨ºæ–­æƒ…å ±ã¯å®Ÿè¡Œãƒ­ã‚¸ãƒƒã‚¯ã‚’å¤‰æ›´ã—ãªã„ãŒã€Node ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã®ãƒ©ã‚¤ãƒ•ã‚¿ã‚¤ãƒ ã¨åŒä¸€ã®ã‚¹ã‚³ãƒ¼ãƒ—ã§ä¿æŒã•ã‚Œã‚‹ç‚¹ã§ state ã¨åŒä¸€ã®æ€§è³ªã‚’æŒã¤ã€‚å¤–éƒ¨ã‹ã‚‰ã®èª­ã¿å–ã‚Šã¯ `read_status()` ãŠã‚ˆã³ `read_error()` ã¨ã„ã†èª­ã¿å–ã‚Šå°‚ç”¨ API ã«é™ã‚‹ï¼ˆÂ§9.1ï¼‰ã€‚

| è¦³ç‚¹ | å†…å®¹ |
|------|------|
| **æ‰€æœ‰è€…** | Node ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ |
| **æ›¸ãè¾¼ã¿ä¸»ä½“** | Node è‡ªèº«ã®ã¿ï¼ˆrun() å†…ï¼‰ |
| **èª­ã¿å–ã‚Šä¸»ä½“** | Node è‡ªèº«ã€‚å¤–éƒ¨ã¯ `read_status()` ãŠã‚ˆã³ `read_error()` ã§å‚ç…§å¯èƒ½ï¼ˆstatus ãŠã‚ˆã³ fatal åŸå› ã¯ state ã®ä¸€éƒ¨ï¼‰ |
| **ãƒ©ã‚¤ãƒ•ã‚¿ã‚¤ãƒ ** | Node ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã¨åŒä¸€ã€‚Loop iteration é–“ã§ä¿æŒã•ã‚Œã‚‹ã€‚å½“è©²å®Ÿè¡Œçµ‚äº†æ™‚ã«ç ´æ£„ã•ã‚Œã‚‹ |

**ç¦æ­¢äº‹é …**

* ä»– Node ãŒ state ã‚’å‚ç…§ã—ã¦ã¯ãªã‚‰ãªã„
* StructuralNode ã¯å­ Node ã® state ã‚’ç›´æ¥å¤‰æ›´ã—ã¦ã¯ãªã‚‰ãªã„
* state ã‚’ Context ã«æ ¼ç´ã—ã¦ã¯ãªã‚‰ãªã„

---

### 3.9.2 usageï¼ˆå®Ÿè¡Œãƒ¡ãƒˆãƒªã‚¯ã‚¹ï¼‰

**å®šç¾©**

usage ã¨ã¯ã€**å®Ÿè¡Œã‚³ã‚¹ãƒˆã‚„æ¶ˆè²»é‡ã‚’è¡¨ã™è¦³æ¸¬ãƒ¡ãƒˆãƒªã‚¯ã‚¹**ã‚’æŒ‡ã™ã€‚

ä¾‹ï¼šprompt_tokensã€completion_tokensã€api_callsã€tool_callsã€‚

**ç‰¹å¾´**ï¼šusage ã¯ãƒ­ã‚¸ãƒƒã‚¯ã®æŒ¯ã‚‹èˆã„ã‚’æ±ºå®šã—ãªã„ã€‚usage ã¯ revision åˆ¶å¾¡ã«é–¢ä¸ã—ãªã„ã€‚**usage ã¯ state ã®ä¸€éƒ¨ã§ã¯ãªã„ã€‚state ã¨ usage ã¯æ„å‘³è«–çš„ã«ç•°ãªã‚‹å±¤ã§ã‚ã‚‹ã€‚** ä¾‹å¤–ã¨ã—ã¦ã€usage ã‚’ limit åˆ¤å®šã«ä½¿ã†å ´åˆãŒã‚ã‚‹ï¼ˆÂ§6.3 â‘£ limit postï¼‰ã€‚ãŸã ã—ã“ã‚Œã¯ BaseNode ãŒè¡Œã†ã®ã§ã‚ã‚Šã€run() ãŒ usage ã‚’ç›´æ¥å‚ç…§ã—ã¦ãƒ­ã‚¸ãƒƒã‚¯ã®åˆ†å²ã«ä½¿ã£ã¦ã¯ãªã‚‰ãªã„ã€‚**run å†…ã§ usage ã‚’å‚ç…§ã—ã¦ LimitSignal ã‚’ raise ã™ã‚‹ã“ã¨ã¯è¨±å¯ã•ã‚Œã‚‹ãŒã€å‡ºåŠ›ãƒ­ã‚¸ãƒƒã‚¯ã‚’ usage ã«ä¾å­˜ã•ã›ã¦ã¯ãªã‚‰ãªã„ã€‚**

| è¦³ç‚¹ | å†…å®¹ |
|------|------|
| **æ‰€æœ‰è€…** | Node |
| **æ›¸ãè¾¼ã¿ä¸»ä½“** | Node è‡ªèº«ï¼ˆæ¶ˆè²»æ™‚ç‚¹ã§ addï¼‰ |
| **èª­ã¿å–ã‚Šä¸»ä½“** | StructuralNodeï¼ˆé›†ç´„ã®ãŸã‚ï¼‰ã€å¤–éƒ¨ç›£è¦–æ©Ÿæ§‹ï¼ˆsnapshot çµŒç”±ï¼‰ã€‚**Runner ã¯ usage ã‚’å‚ç…§ã—ãªã„ã€‚** |
| **ç´¯ç©ãƒ«ãƒ¼ãƒ«** | usage ã¯ç´¯ç©å€¤ã€‚reset ã—ãªã„ã€‚iteration å˜ä½ã®å€¤ã¯ snapshot å·®åˆ†ã§å–å¾—ã™ã‚‹ï¼ˆÂ§3.7ï¼‰ |

---

### 3.9.3 Contextï¼ˆå®Ÿè¡Œã‚¹ã‚³ãƒ¼ãƒ—ç®¡ç†æƒ…å ±ï¼‰

**å®šç¾©**

Context ã¨ã¯ã€**Execution Scope å†…ã®ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ­ãƒ¼çŠ¶æ…‹ç®¡ç†æƒ…å ±**ã‚’æŒ‡ã™ã€‚ã‚°ãƒ­ãƒ¼ãƒãƒ« Context ã¯å»ƒæ­¢ï¼ˆÂ§1.1ï¼‰ã€‚é…ç½®ãƒ»å½¹å‰²ã¯æœ¬ç¯€ã§å®šç¾©ã™ã‚‹ã€‚

**å«ã‚€ã‚‚ã®**ï¼šlatest_outputã€å…¥åŠ›è§£æ±ºçµæœã€binding çŠ¶æ…‹ã€graph å®Ÿè¡Œç®¡ç†æƒ…å ±ã€‚

**å«ã¾ãªã„ã‚‚ã®**ï¼šNode stateã€usageã€revision åˆ¶å¾¡ãƒ­ã‚¸ãƒƒã‚¯ã€‚

| è¦³ç‚¹ | å†…å®¹ |
|------|------|
| **æ‰€æœ‰è€…** | StructuralNodeï¼ˆPipelineNodeï¼‰ |
| **æ›¸ãè¾¼ã¿ä¸»ä½“** | Runnerã€PipelineNode |
| **èª­ã¿å–ã‚Šä¸»ä½“** | Runnerï¼ˆinputs è§£æ±ºï¼‰ã€StructuralNodeï¼ˆçµ‚äº†åˆ¤å®šã€‚Â§6.7ï¼‰ã€‚**Node ã¯ Context ã‚’ç›´æ¥å‚ç…§ã—ã¦ã¯ãªã‚‰ãªã„ã€‚** |
| **ã‚¹ã‚³ãƒ¼ãƒ—** | ã‚°ãƒ­ãƒ¼ãƒãƒ«ã§ã¯ãªã„ã€‚Execution Scope å˜ä½ã€‚ç‹¬ç«‹ 1-shot ã®å ´åˆã¯å®Ÿè¡Œçµ‚äº†æ™‚ã«ç ´æ£„ã•ã‚Œã‚‹ã€‚LoopNode å†…ã§ PipelineNode ãŒå†å®Ÿè¡Œã•ã‚Œã‚‹å ´åˆã¯ iteration é–“ã§ä¿æŒã•ã‚Œã‚‹ï¼ˆÂ§12.2.1.4ï¼‰ã€‚|

---

### 3.9.4 3è€…ã®åˆ†é›¢åŸå‰‡ï¼ˆä¸å¤‰æ¡ä»¶ï¼‰

ä»¥ä¸‹ã‚’å¸¸ã«æº€ãŸã•ãªã‘ã‚Œã°ãªã‚‰ãªã„ã€‚

1. **state ã¯ Node ã®ã¿ãŒå¤‰æ›´å¯èƒ½ã€‚** å¤–éƒ¨ã‹ã‚‰ã®èª­ã¿å–ã‚Šã¯ `read_status()` ãŠã‚ˆã³ `read_error()` ã«é™ã‚‹ï¼ˆÂ§3.9.1ï¼‰ã€‚
2. **usage ã¯ Node ãŒè¨˜éŒ²ã—ã€StructuralNode ãŒé›†ç´„ã™ã‚‹**
3. **Context ã¯ StructuralNode ãŒç®¡ç†ã—ã€Node ã¯ç›´æ¥å‚ç…§ã—ãªã„**
4. state ã‚’ Context ã«ç§»ã—ã¦ã¯ãªã‚‰ãªã„
5. usage ã‚’ Context ã«ç§»ã—ã¦ã¯ãªã‚‰ãªã„
6. Context ã‚’ Node ã‹ã‚‰å‚ç…§ã—ã¦ã¯ãªã‚‰ãªã„

---

# 4. Param ãƒ¢ãƒ‡ãƒ«

## 4.1 params ã®å½¹å‰²

params ã¯ï¼š

> Node ã®é™çš„å®Ÿè¡Œè¨­å®š

ã§ã‚ã‚‹ã€‚

* ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ­ãƒ¼ã¨ã¯ç‹¬ç«‹
* å®Ÿè¡Œä¸­ã«å¤‰åŒ–ã—ãªã„
* shallow immutable ã§ååˆ†

---

## 4.2 limit ã¯ params ã®ä¸€éƒ¨

limit ã¯ params å†…ã«å«ã¾ã‚Œã‚‹ã€‚

```yaml
params:
  limit:
    max_calls: 10
    max_wall_time_sec: 30
```

ä»•æ§˜ï¼š

* limit ã‚­ãƒ¼ã¯ v1.2 ã§ã¯å›ºå®šã—ãªã„
* Node ã”ã¨ã«è‡ªç”±ã«å®šç¾©ã—ã¦ã‚ˆã„
* BaseNode ã¯è§£é‡ˆã§ãã‚‹ã‚­ãƒ¼ã®ã¿è§£é‡ˆã™ã‚‹
* Runner ã¯ limit ã‚’è§£é‡ˆã—ãªã„

---

## 4.3 Paramä¼æ¬

* Param ç¶™æ‰¿ãƒ«ãƒ¼ãƒ«ã¯ä»•æ§˜ã§å›ºå®šã—ãªã„
* Param ä¼æ¬ã¯ PipelineNode ã®è²¬å‹™
* æš—é»™ç¶™æ‰¿ã¯ç¦æ­¢
* å¿…è¦ãªå ´åˆã¯ PipelineNode ãŒæ˜ç¤ºçš„ã«ãƒãƒƒãƒ”ãƒ³ã‚°ã™ã‚‹

---

## 4.4 params ã¯ immutable

**params ã¯å®Ÿè£…è€…ãŒå¤‰æ›´ã—ã¦ã¯ãªã‚‰ãªã„ï¼ˆä»•æ§˜ä¸Šã®åˆ¶ç´„ï¼‰ã€‚**

BaseNode.execute ã¯ params ã‚’ **shallow freeze** ã—ã¦ã‹ã‚‰ run ã«æ¸¡ã™ã€‚`_freeze` ã®å®Ÿè£…ã¯ `types.MappingProxyType(params)` ãªã©å‡¦ç†ç³»ä¾å­˜ã§ã‚ˆã„ã€‚æ·±ã„ãƒã‚¹ãƒˆã® freeze ã¯ v1.2 ã§ã¯è¡Œã‚ãªã„ï¼ˆÂ§4.4 ã®ã€Œä»•æ§˜ä¸Šã®åˆ¶ç´„ã§è¶³ã‚Šã‚‹ã€æ–¹é‡ã‚’ç¶­æŒï¼‰ã€‚run å†…ã§ `params["key"] = value` ã®ã‚ˆã†ãªç›´æ¥ä»£å…¥ã‚’è©¦ã¿ãŸå ´åˆã¯ TypeError ãŒç™ºç”Ÿã™ã‚‹ã€‚

---

# 5. Revision ãƒ¢ãƒ‡ãƒ«

revision ã¯ **Core Model ã«ã¯å­˜åœ¨ã—ãªã„æ¦‚å¿µ**ã§ã‚ã‚‹ã€‚Execution Layer ã«ãŠã‘ã‚‹**å†…å®¹è­˜åˆ¥å­ï¼ˆcontent-based identifierï¼‰**ã¨ã—ã¦å®šç¾©ã™ã‚‹ã€‚

## 5.1 å®šç¾©

revision ã¯ï¼š

> å‡ºåŠ›å†…å®¹ã® **å†…å®¹è­˜åˆ¥å­ï¼ˆcontent-based identifierï¼‰**

ã§ã‚ã‚‹ã€‚

```text
revision = HASH( CanonicalJSON(output_without_meta) )
```

* **revision ã¯ port ã«å±ã™ã‚‹** â€” `_meta.revision` ã«æ ¼ç´
* Node é–“ã® I/O å¥‘ç´„
* Runner ã¯è§£é‡ˆã—ãªã„
* **BaseNode ãŒè‡ªå‹•ç”Ÿæˆã™ã‚‹**ï¼ˆÂ§5.7ï¼‰ã€‚Node å®Ÿè£…è€…ã¯ revision ã‚’ç”Ÿæˆã—ã¦ã¯ãªã‚‰ãªã„

### 5.1.1 æ€§è³ª

âœ” revision ã¯ opaque identifier  
âœ” revision ã¯ deterministic  
âœ” åŒä¸€å†…å®¹ â†’ åŒä¸€ revisionï¼ˆãŸã ã— `_meta.hash_skip: true` ãŒæŒ‡å®šã•ã‚ŒãŸå ´åˆã¯ã“ã®é™ã‚Šã§ã¯ãªã„ã€‚Â§12.4.3ï¼‰  
âœ” ç•°ãªã‚‹å†…å®¹ â†’ ç•°ãªã‚‹ revisionï¼ˆãƒãƒƒã‚·ãƒ¥è¡çªãŒç™ºç”Ÿã—ãŸå ´åˆã®æŒ™å‹•ã¯æœªå®šç¾©ã€‚Execution Layer ã¯ SHA-256 ã®è¡çªè€æ€§ã‚’å‰æã¨ã™ã‚‹ï¼‰  
âœ” revision ã¯ Node state ã§ã¯ãªã„  
âœ” revision ã¯ BaseNode ãŒè‡ªå‹•ç”Ÿæˆã™ã‚‹  
âœ” Node å®Ÿè£…è€…ã¯ revision ã‚’ç”Ÿæˆã—ã¦ã¯ãªã‚‰ãªã„  
âœ” **revision ã¯ Execution Scope å†…ã§ã®ã¿æ„å‘³ã‚’æŒã¤è­˜åˆ¥å­ã§ã‚ã‚‹**ï¼ˆåˆ¥ Execution Scopeãƒ»åˆ¥ Runnerãƒ»åˆ¥ç’°å¢ƒã§ã¯ revision ã®æ¯”è¼ƒã¯ä¿è¨¼ã•ã‚Œãªã„ï¼‰  
âœ” **revision ã¯ã‚°ãƒ­ãƒ¼ãƒãƒ«ä¸€æ„æ€§ã‚’ä¿è¨¼ã—ãªã„**ï¼ˆSHA-256 ã®è¡çªå¯èƒ½æ€§ã¯ç†è«–ä¸Šå­˜åœ¨ã™ã‚‹ï¼‰  
âœ” **revision ã¯ ID ã§ã¯ãªãå†…å®¹è­˜åˆ¥å­ï¼ˆcontent-based identifierï¼‰ã§ã‚ã‚‹**  

revision ã¯ **é †åºã‚„å›æ•°ã‚’è¡¨ã•ãªã„**ã€‚

**é‡è¦**ï¼š**revision ã¯ã‚°ãƒ­ãƒ¼ãƒãƒ« ID ã§ã¯ãªã„ã€‚** revision ã¯åŒä¸€ Execution Scope å†…ã§ deterministic ã§ã‚ã‚‹ã“ã¨ã‚’å‰æã¨ã™ã‚‹ã€‚ç•°ãªã‚‹ Execution Scope é–“ã§ã® revision ä¸€è‡´ã¯ä¿è¨¼ã—ãªã„ã€‚Execution Scope å†…ã§ã®ã¿æ„å‘³ã‚’æŒã¡ã€åˆ†æ•£å®Ÿè¡Œè¨­è¨ˆã§ã¯ã“ã®ã‚¹ã‚³ãƒ¼ãƒ—ã‚’è¶…ãˆãŸ revision ã®æ¯”è¼ƒã‚’æƒ³å®šã—ãªã„ã“ã¨ã€‚ã‚°ãƒ­ãƒ¼ãƒãƒ« ID ã¨èª¤è§£ã™ã‚‹ã¨åˆ†æ•£å®Ÿè¡Œã§äº‹æ•…ã®åŸå› ã¨ãªã‚‹ã€‚

**è£œè¶³**ï¼šrevision ã¯å†…å®¹ãƒ™ãƒ¼ã‚¹ã®ã¿ã§ã‚ã‚‹ã€‚Node ã®å‡ºåŠ›ãŒå†…éƒ¨çŠ¶æ…‹ã«ä¾å­˜ã™ã‚‹å ´åˆã§ã‚‚ã€revision ãŒåæ˜ ã™ã‚‹ã®ã¯**ç”Ÿæˆã•ã‚ŒãŸå‡ºåŠ›å†…å®¹ã®ã¿**ã§ã‚ã‚Šã€å› æœå±¥æ­´ã§ã¯ãªã„ã€‚åŒä¸€ã®å‡ºåŠ› JSON ã‚’è¿”ã™ 2 å›ã®å®Ÿè¡Œã¯ã€å†…éƒ¨çŠ¶æ…‹ãŒç•°ãªã£ã¦ã„ã¦ã‚‚**åŒä¸€ã® revision ã‚’ç”Ÿæˆã™ã‚‹**ã€‚

---

## 5.2 å‡ºåŠ›å´è²¬å‹™

**Node ã¯ revision ã‚’ç”Ÿæˆã—ãªã„ã€‚** Node ã¯å˜ã« output port ã®å†…å®¹ã‚’è¿”ã™ã€‚

BaseNode ãŒä»¥ä¸‹ã‚’è¡Œã†ï¼ˆÂ§5.7ï¼‰ï¼š

1. `_meta` ã‚’é™¤ã„ãŸå‡ºåŠ›ã‚’ canonical åŒ–ï¼ˆÂ§5.9ï¼‰
2. ãƒãƒƒã‚·ãƒ¥ã‚’è¨ˆç®—ï¼ˆÂ§5.10ï¼‰
3. `_meta.revision` ã«æ ¼ç´

---

## 5.3 å…¥åŠ›å´è²¬å‹™

**å…¥åŠ›å´ã® revision ç¢ºèªã¯ä»»æ„ã¨ã™ã‚‹ã€‚** Node ãŒ revision ã‚’å‚ç…§ã™ã‚‹å ´åˆã€è¨±å¯ã•ã‚Œã‚‹ã®ã¯ç­‰ä¾¡æ¯”è¼ƒã®ã¿ã§ã‚ã‚‹ã€‚

```python
if current_revision == last_revision:
    no_op()
```

**é †åºæ¯”è¼ƒã¯ç¦æ­¢**ï¼ˆrevision ã¯ content-hash ã§ã‚ã‚Šé †åºã‚’æŒãŸãªã„ï¼‰ã€‚

| ç¢ºèªã™ã‚‹ | ç¢ºèªã—ãªã„ |
|----------|-------------|
| å‰å›ã¨ revision ãŒåŒã˜ãªã‚‰ no-op å¯èƒ½ | å¸¸ã«å®Ÿè¡Œã•ã‚Œã‚‹å‰æã§è¨­è¨ˆã™ã‚‹ |
| ä¸è¦ãªå†å®Ÿè¡Œã‚’æ¸›ã‚‰ã›ã‚‹ | å®Ÿè£…ãŒã‚·ãƒ³ãƒ—ãƒ«ã«ãªã‚‹ |

**Loop ã®çµ‚äº†ã¯ revision ã«ä¾å­˜ã—ãªã„ã€‚** Loop ã¯ condition ã®ã¿ã§çµ‚äº†åˆ¤å®šã™ã‚‹ï¼ˆÂ§12.2ï¼‰ã€‚

**no-op ã‚’å®Ÿè£…ã™ã‚‹ Node ã¯ã€å‰å›å‡¦ç†ã—ãŸ revision ã‚’å†…éƒ¨çŠ¶æ…‹ã¨ã—ã¦ä¿æŒã™ã‚‹è²¬å‹™ã‚’è² ã†ã€‚** Runner ã¯ã“ã®ä¿æŒã‚’ç®¡ç†ã—ãªã„ã€‚

---

## 5.4 å‹•ä½œä¾‹ï¼ˆrevision ã®æµã‚Œï¼‰

implement â†’ review ã®ä¾‹ï¼šimplement ãŒå‡ºåŠ› A ã‚’è¿”ã™ â†’ BaseNode ãŒ content-hash ã‚’è¨ˆç®—ã— `_meta.revision` ã«æ ¼ç´ â†’ review ãŒå‡¦ç†ã€‚implement ã®å‡ºåŠ›ãŒåŒã˜å†…å®¹ãªã‚‰åŒä¸€ revisionã€å†…å®¹ãŒå¤‰ã‚ã‚Œã°ç•°ãªã‚‹ revision ã¨ãªã‚‹ã€‚review ãŒ revision ã‚’ç¢ºèªã™ã‚‹å ´åˆã€åŒä¸€ revision ãªã‚‰ no-op å¯èƒ½ã€‚revision ã¯ Node é–“ã® I/O å¥‘ç´„ã§ã‚ã‚Šã€**Loop åˆ¶å¾¡ã¨ã¯ç„¡é–¢ä¿‚**ï¼ˆÂ§12.2ï¼‰ã€‚

---

## 5.5 Revision ã¨å¾ªç’°

revision ã¯å†å®Ÿè¡Œæœ€é©åŒ–ã®ãŸã‚ã® I/O å¥‘ç´„ï¼ˆcontent-hash ã«ã‚ˆã‚ŠåŒä¸€å‡ºåŠ›ã¯åŒä¸€ revisionï¼‰ã€‚å¾ªç’°ã‚°ãƒ©ãƒ•å†…ã§ã¯ã€å¤‰åŒ–ãŒä¼æ’­ã—ãŸã¨ãã®ã¿å†å®Ÿè¡ŒãŒç™ºç”Ÿã—ã€ä¸å¿…è¦ãªå†å®Ÿè¡ŒãŒæ¸›ã‚‹ã€‚**Loop ã®çµ‚äº†æ¡ä»¶ã«ã¯é–¢ä¸ã—ãªã„**ï¼ˆÂ§12.2ï¼‰ã€‚

---

## 5.6 revision ã®è¨­è¨ˆåŸå‰‡

âœ” revision ã¯ port å˜ä½  
âœ” ã™ã¹ã¦ã® Nodeï¼ˆoutput portï¼‰ãŒ revision ã‚’æŒã¤  
âœ” revision ã¯ Node å‡ºåŠ›ã®ä¸€éƒ¨ï¼ˆBaseNode ãŒä»˜ä¸ï¼‰  
âœ” Runner ã¯è§£é‡ˆã—ãªã„  
âœ” revision ã¯å®Ÿè¡Œåˆ¶å¾¡ã®è£œåŠ©æƒ…å ±ï¼ˆç­‰ä¾¡æ¯”è¼ƒã®ã¿ï¼‰  
âœ” revision ã¯ Node é–“ã®å¥‘ç´„  
âœ” revision ã¯å†…å®¹ã‹ã‚‰æ±ºå®šçš„ã«è¨ˆç®—ã•ã‚Œã‚‹ï¼ˆcontent-hashï¼‰  

---

## 5.7 revision è‡ªå‹•ç”Ÿæˆ

**BaseNode.execute** ã¯ run() ã®æˆ»ã‚Šå€¤ã«å¯¾ã—ã€å„ output port ã”ã¨ã«ä»¥ä¸‹ã‚’å®Ÿè¡Œã™ã‚‹ï¼š

1. å½“è©² port ã®å€¤ã‹ã‚‰ `_meta` ã‚’é™¤ã
2. Canonical JSON ã«æ­£è¦åŒ–ã™ã‚‹ï¼ˆÂ§5.9ï¼‰
3. SHA-256 ã§ãƒãƒƒã‚·ãƒ¥ã‚’è¨ˆç®—ã™ã‚‹ï¼ˆÂ§5.10ï¼‰
4. `port_value["_meta"]["revision"]` ã«æ ¼ç´ã™ã‚‹

```text
canonical = CanonicalJSON(port_value_without_meta)
revision = SHA256(canonical)
port_value["_meta"]["revision"] = revision  # hex string, 64 chars
```

**æ³¨æ„**ï¼šstatus ã¯ output ã§ã¯ãªã„ã®ã§ revision ã‚’ä»˜ä¸ã—ãªã„ã€‚revision ã¯ output port ã®ã¿ã€‚`{}` ã‚’è¿”ã—ãŸå ´åˆã¯ revision ã¯å­˜åœ¨ã—ãªã„ï¼ˆÂ§5.8ï¼‰ã€‚

**hash_skip**ï¼šå·¨å¤§å‡ºåŠ›ç­‰ã®ä¾‹å¤–çš„ã‚±ãƒ¼ã‚¹ã§ã¯ `_meta.hash_skip: true` ã‚’æŒ‡å®šã—ã€revision ã‚’ UUID ç­‰ã§ä»£æ›¿ã§ãã‚‹ï¼ˆÂ§12.4.3ï¼‰ã€‚

---

## 5.8 revision å¥‘ç´„ã¨åœæ­¢æ™‚ã®æ•´åˆ

* revision ã¯ output port ã®ã¿ã«å­˜åœ¨ã™ã‚‹
* execute ãŒ `{}` ã‚’è¿”ã—ãŸå ´åˆã€revision ã¯å­˜åœ¨ã—ãªã„ï¼ˆå‡ºåŠ›ãŒãªã„ãŸã‚ï¼‰
* revision å¥‘ç´„ã¯ã€Œå‡ºåŠ›ãŒã‚ã‚‹ã¨ãã®ã¿ã€é©ç”¨ã•ã‚Œã‚‹
* Runner ã® revisionãƒ»ç©º dict ã®æ‰±ã„ã¯ Â§5.1, Â§3.3 å‚ç…§

---

## 5.9 Canonical JSONï¼ˆrevision è¨ˆç®—ç”¨ï¼‰

revision è¨ˆç®—ã«ä½¿ç”¨ã™ã‚‹ **Canonical JSON** ã¯ä»¥ä¸‹ã‚’æº€ãŸã™ã€‚**Canonical JSON ã¯ JSON äº’æ›å‹ï¼ˆobject, array, string, number, boolean, nullï¼‰ã®ã¿ã‚’å¯¾è±¡ã¨ã™ã‚‹ã€‚**

**RFC 8785 æº–æ‹ **ï¼šCanonical JSON ã¯ **RFC 8785 (JSON Canonicalization Scheme)** ã«æº–æ‹ ã—ãªã‘ã‚Œã°ãªã‚‰ãªã„ï¼ˆMUSTï¼‰ã€‚å®Ÿè£…ã¯ RFC 8785 æº–æ‹ ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨ã€‚åˆ†æ•£ç’°å¢ƒã§ã® revision ä¸€è‡´ã‚’ä¿è¨¼ã™ã‚‹ãŸã‚ã€ç‹¬è‡ªå®Ÿè£…ã™ã‚‹å ´åˆã¯åŒä¸€å‡ºåŠ›ãŒ cross-language ã§åŒä¸€ãƒãƒƒã‚·ãƒ¥ã«ãªã‚‹ã“ã¨ã‚’ä¿è¨¼ã—ãªã‘ã‚Œã°ãªã‚‰ãªã„ã€‚

### 5.9.1 åŸºæœ¬è¦å‰‡

1. UTF-8 ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰
2. ã‚­ãƒ¼ã¯è¾æ›¸é †ï¼ˆsort_keys=Trueï¼‰
3. separators=(',', ':')
4. ensure_ascii=False
5. ä¸è¦ãªç©ºç™½ã‚’å«ã¾ãªã„
6. list ã®é †åºã¯ä¿æŒã™ã‚‹

**é JSON å‹ã®æ‰±ã„ï¼ˆç¢ºå®šï¼‰**

Canonical JSON åŒ–ã®å¯¾è±¡ã« JSON éäº’æ›å‹ï¼ˆ`datetime`ã€`bytes`ã€ã‚«ã‚¹ã‚¿ãƒ ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆç­‰ï¼‰ãŒå«ã¾ã‚Œã¦ã„ãŸå ´åˆã€BaseNode ã¯ **TypeError ã‚’ raise ã—ã€å½“è©² Node ã® status ã‚’ fatal ã¨ã™ã‚‹**ã€‚

æš—é»™ã®å‹å¤‰æ›ï¼ˆ`str()`ã€`repr()` ç­‰ï¼‰ã¯ **ç¦æ­¢**ã™ã‚‹ã€‚æš—é»™å¤‰æ›ã‚’è¨±å¯ã™ã‚‹ã¨ã€å¤‰æ›çµæœãŒå‡¦ç†ç³»ãƒ»ãƒãƒ¼ã‚¸ãƒ§ãƒ³ä¾å­˜ã«ãªã‚Šã€revision ã®æ±ºå®šæ€§ãŒç ´å£Šã•ã‚Œã‚‹ã€‚

Node å®Ÿè£…è€…ã¯ run() ã®æˆ»ã‚Šå€¤ãŒ JSON äº’æ›å‹ã®ã¿ã§æ§‹æˆã•ã‚Œã‚‹ã“ã¨ã‚’ä¿è¨¼ã™ã‚‹è²¬ä»»ã‚’è² ã†ã€‚

### 5.9.2 æµ®å‹•å°æ•°ç‚¹ã®æ‰±ã„

æµ®å‹•å°æ•°ç‚¹ã®æ­£è¦åŒ–ã¯ **RFC 8785** ã«å¾“ã†ã€‚**NaN / Infinity ã¯ç¦æ­¢**ï¼ˆfatalï¼‰ã€‚ãã®ä»–ã®ç´°å‰‡ã¯ RFC 8785 ãŠã‚ˆã³ Â§5.9.1 ã«å§”ã­ã‚‹ã€‚

### 5.9.3 null / boolean / int

æ¨™æº– JSON è¡¨ç¾ã«å¾“ã†ã€‚

### 5.9.4 _meta ã®æ‰±ã„

revision è¨ˆç®—æ™‚ã€**ã™ã¹ã¦ã®éšå±¤ã«ãŠã‘ã‚‹ `_meta` ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã¯é™¤å¤–ã™ã‚‹**ï¼ˆå†å¸°çš„é™¤å¤–ï¼‰ã€‚ã“ã‚Œã¯å‡ºåŠ› JSON ã®ã„ã‹ãªã‚‹ãƒã‚¹ãƒˆæ·±åº¦ã«ãŠã„ã¦ã‚‚ `_meta` ã‚­ãƒ¼ã‚’æŒã¤ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‹ã‚‰ `_meta` ã‚’å–ã‚Šé™¤ã„ãŸä¸Šã§ãƒãƒƒã‚·ãƒ¥è¨ˆç®—ã‚’è¡Œã†ã“ã¨ã‚’æ„å‘³ã™ã‚‹ã€‚

å½¢å¼çš„ã«ã¯ï¼š

```
strip_meta(value):
  if value is object:
    return { k: strip_meta(v) for k, v in value.items() if k != "_meta" }
  if value is array:
    return [ strip_meta(v) for v in value ]
  return value

canonical = CanonicalJSON(strip_meta(port_value))
revision  = SHA256(canonical)
```

**ç†ç”±**ï¼šãƒã‚¹ãƒˆå†…ã® `_meta.revision` ã¯åˆ¥ãƒãƒ¼ãƒ‰ã®å‡ºåŠ›ãŒåŸ‹ã‚è¾¼ã¾ã‚ŒãŸå ´åˆã«ç™ºç”Ÿã—å¾—ã‚‹ã€‚ãã‚Œã‚’ revision è¨ˆç®—ã«å«ã‚ã‚‹ã¨ã€å†…å®¹ãŒå¤‰ã‚ã£ã¦ã„ãªã„ã®ã«å‚ç…§å…ˆã® revision å¤‰æ›´ã«ã‚ˆã£ã¦è‡ªèº«ã® revision ãŒå¤‰ã‚ã‚‹ã¨ã„ã†ã€Œrevision ã®é€£é–ä¼æ’­ã€ãŒç™ºç”Ÿã—ã€æ±ºå®šæ€§ãŒæãªã‚ã‚Œã‚‹ã€‚_meta å†…ã®ä»–ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ï¼ˆå°†æ¥æ‹¡å¼µï¼‰ã‚‚ revision è¨ˆç®—ã«ã¯å«ã‚ãªã„ã€‚

---

## 5.10 ãƒãƒƒã‚·ãƒ¥ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ 

ä½¿ç”¨ã™ã‚‹ãƒãƒƒã‚·ãƒ¥é–¢æ•°ï¼š**SHA-256**ã€‚

å‡ºåŠ›å½¢å¼ï¼š**hex stringï¼ˆ64 æ–‡å­—ï¼‰**ã€‚

ä¾‹ï¼š`"e3b0c44298fc1c149afbf4c8996fb924..."`

---

# 6. BaseNode

## 6.1 å½¹å‰²

BaseNode ã¯ï¼š

> ã™ã¹ã¦ã® Node ãŒç¶™æ‰¿ã™ã‚‹åŸºåº•ã‚¯ãƒ©ã‚¹ï¼ˆCore Node ã®å®Ÿè£…ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆï¼‰

ã§ã‚ã‚‹ã€‚

BaseNode ã¯ NodeFlow ã®å®Ÿè¡Œå¥‘ç´„ã‚’å¼·åˆ¶ã™ã‚‹ã€‚**å¤–éƒ¨ I/O ã‚’å«ã‚€ Node ã¯ timeout ã‚’å®Ÿè£…ã—ãªã‘ã‚Œã°ãªã‚‰ãªã„ï¼ˆMUSTï¼‰ã€‚** ã“ã‚Œã«é•åã™ã‚‹ã¨ executing ä¸­ã®ãƒãƒ¼ãƒ‰ãŒæ°¸ä¹…å¾…æ©Ÿã¨ãªã‚Šã€max_idle_sec ç­‰ã® limit ãŒæ©Ÿèƒ½ã—ãªã„ï¼ˆÂ§7.4ï¼‰ã€‚

**Runner ã¯é€šå¸¸ã®ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒªãƒ³ã‚°ã§ `node.execute()` ã®ã¿ã‚’å‘¼ã¶ã€‚** pause å†é–‹æ™‚ã¯ StructuralNode ãŒç›´æ¥ execute ã‚’å‘¼ã¶ï¼ˆÂ§12.2.1.5ï¼‰ã€‚

---

## 6.2 å…¬é–‹ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹

```python
execute(inputs: dict, params: dict) -> dict
```

ã™ã¹ã¦ã® Node ã¯ã“ã®ã‚·ã‚°ãƒãƒãƒ£ã‚’æŒã¤ã€‚

ã‚µãƒ–ã‚¯ãƒ©ã‚¹ã¯ `run()` ã®ã¿ã‚’å®Ÿè£…ã™ã‚‹ã€‚

---

## 6.3 execute ã®è²¬å‹™

**execute ã®æµã‚Œãƒ»ãƒ•ãƒ­ãƒ¼å›³ã¯ Â§2.2 ã«å®Œå…¨ã«é›†ç´„ã™ã‚‹ã€‚** æœ¬ç¯€ã¯ BaseNode å®Ÿè£…ä¸Šã®è£œè¶³ï¼ˆlimit pre / run / revision è£œå®Œ / limit post / ä¾‹å¤–å¸åï¼‰ã®ã¿ã¨ã™ã‚‹ã€‚

---

#### â‘  limit pre

* `params.limit` ã‚’å‚ç…§ã—ã€è§£é‡ˆå¯èƒ½ãª limit ã‚’ãƒã‚§ãƒƒã‚¯
* **è¶…éæ™‚ã¯ run ã‚’å‘¼ã°ãšã€status = limit ã«ã—ã¦ return**

**å½¢å¼ä»•æ§˜**ï¼šIf limit is exceeded before run(), the node MUST return `{}`. No output is produced.

---

#### â‘¡ run å‘¼ã³å‡ºã—

```python
def run(self, inputs, params) -> dict:
```

* ãƒãƒ¼ãƒ‰å›ºæœ‰å‡¦ç†
* dict ã‚’è¿”ã™ã“ã¨
* **PauseSignal ã‚’ raise ã—ãŸå ´åˆ**ã€BaseNode ã¯ status = pause ã«ã—ã¦ return ã™ã‚‹ã€‚**LimitSignal ã‚’ raise ã—ãŸå ´åˆ**ã€BaseNode ã¯ status = limit ã«ã—ã¦ return ã™ã‚‹ã€‚ä¸Šè¨˜ä»¥å¤–ã®ä¾‹å¤–ã¯ã™ã¹ã¦ fatal ã¨ã—ã¦æ‰±ã†ã€‚run ã®æˆ»ã‚Šå€¤ã«ã‚ˆã‚‹ pause/limit è¡¨ç¾ã¯æ¡ç”¨ã—ãªã„ï¼ˆæˆ»ã‚Šå€¤ã¯å¸¸ã« dictï¼‰ã€‚

**LimitSignal ã‚’ raise ã—ãŸå ´åˆ**ã€revision è£œå®ŒãŠã‚ˆã³ limit post ã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¦ status = limitã€`{}` ã‚’è¿”ã™ã€‚ï¼ˆlimit post ã§æ¤œå‡ºã•ã‚Œã‚‹ limit ã¯ â‘£ å‚ç…§ã€‚ï¼‰

---

#### â‘¢ revision è‡ªå‹•è£œå®Œ

run ã®æˆ»ã‚Šå€¤ã«å¯¾ã—ã¦ã€å„ output port ã”ã¨ã«ï¼š

* `_meta` ã‚’é™¤ã„ãŸ port å€¤ã‚’ Canonical JSON åŒ–ï¼ˆÂ§5.9ï¼‰
* SHA-256 ã§ãƒãƒƒã‚·ãƒ¥ã‚’è¨ˆç®—ã— `_meta.revision` ã«æ ¼ç´ï¼ˆÂ§5.7, Â§5.10ï¼‰
* statusï¼ˆread_status() ã§èª­ã‚€ã‚‚ã®ï¼‰ã«ã¯ä»˜ä¸ã—ãªã„

`_meta.hash_skip` ãŒ true ã®å ´åˆã¯ UUID ç­‰ã®ä¸€æ„å€¤ã‚’ç”¨ã„ã‚‹ï¼ˆÂ§12.4.3ï¼‰ã€‚ã“ã‚Œã«ã‚ˆã‚Š revision å¥‘ç´„ã‚’ä¿è¨¼ã™ã‚‹ï¼ˆÂ§5.7ï¼‰ã€‚

---

#### â‘£ limit post

* å‘¼ã³å‡ºã—å›æ•°ãªã©ã®æ›´æ–°ã€‚**è¶…éã—ãŸã‚‰ status = limit ã«ã—ã¦ return**
* **limit post ãŒç™ºç”Ÿã—ã¦ã‚‚ã€run ãŒæˆåŠŸã—ã¦ã„ã‚‹å ´åˆã¯ revision è£œå®Œæ¸ˆã¿å‡ºåŠ›ã‚’è¿”ã™ã€‚** run ãŒæˆåŠŸã—ã¦ã„ãªã„å ´åˆã®ã¿ `{}` ã‚’è¿”ã—ã¦ã‚ˆã„ã€‚
* å¿…è¦ã«å¿œã˜ã¦å†…éƒ¨çŠ¶æ…‹æ›´æ–°

**å½¢å¼ä»•æ§˜**ï¼šIf limit is exceeded after run(), the node MUST:
- Preserve and return the output of run()
- Set status = limit
- Prevent further scheduling in the current StructuralNode

---

#### â‘¤ ä¾‹å¤–å¸å

run ãŒä¾‹å¤–ã‚’æŠ•ã’ãŸå ´åˆã€Â§2.2 ã®ä¾‹å¤–â†’status å¤‰æ›ã«å¾“ã†ã€‚PauseSignal â†’ pauseã€LimitSignal â†’ limitã€ãã®ä»– â†’ fatalã€‚Runner ã¯ä¾‹å¤–ã‚’æ‰±ã‚ãªã„ã€‚

---

## 6.4 å‡ºåŠ›åˆ¶ç´„

BaseNode ã¯ä»¥ä¸‹ã‚’ä¿è¨¼ã™ã‚‹ï¼ˆæˆ»ã‚Šå€¤å¥‘ç´„ã¯ Â§2.1 å‚ç…§ï¼‰ï¼š

* å¿…ãš dict ã‚’è¿”ã™ï¼ˆæˆåŠŸæ™‚ã¯ output port ã‚’æŒã¤ dictã€åœæ­¢ç³»ã§ã¯ `{}` ã‚’è¿”ã—ã¦ã‚ˆã„ï¼‰
* execute ã®è¿”ã‚Šå€¤ã¯ output port ã® dict ã®ã¿ã€‚status ã¯å«ã¾ãªã„ã€‚
* **æˆåŠŸæ™‚**ã® output port ã«ã¯ `_meta.revision` ãŒå­˜åœ¨ã™ã‚‹ï¼ˆ`{}` ã‚’è¿”ã—ãŸå ´åˆã¯ revision ã¯å­˜åœ¨ã—ãªã„ã€‚Â§5.8ï¼‰

---

## 6.5 çŠ¶æ…‹ï¼ˆstateï¼‰

Node ã¯å†…éƒ¨çŠ¶æ…‹ã‚’ä¿æŒã—ã¦ã‚ˆã„ã€‚**state ã®å®šç¾©ãƒ»æ‰€æœ‰è€…ãƒ»èª­ã¿æ›¸ãä¸»ä½“ãƒ»ç¦æ­¢äº‹é …ã¯ Â§3.9.1 ã«ã¾ã¨ã‚ã‚‹ã€‚**

* çŠ¶æ…‹ä¿æŒã¯è¨±å¯ã•ã‚Œã‚‹
* ãŸã ã—å†å®Ÿè¡Œæ™‚ã«åˆæœŸåŒ–å¯èƒ½ã§ã‚ã‚‹ã“ã¨ãŒæœ›ã¾ã—ã„
* NodeFlow v1.2 ã¯ deterministic å®Ÿè¡Œã‚’ä¿è¨¼ã—ãªã„

---

## 6.6 DataNode ã®è²¬ä»»ï¼ˆÂ§1.3 åˆ†é¡ã¨ã®å¯¾å¿œï¼‰

DataNodeï¼ˆLLMNodeã€ScriptNode ãªã©ã€å˜ä½“ã§ run ã‚’å®Ÿè£…ã™ã‚‹ Nodeï¼‰ã®è²¬ä»»ã¯ä»¥ä¸‹ã¨ã™ã‚‹ã€‚

* run() ã®å®Ÿè£…
* revision ã®ä»˜ä¸ï¼ˆå‡ºåŠ›ç”Ÿæˆæ™‚ã®ã¿å­˜åœ¨ã™ã‚‹ã€‚BaseNode ãŒ content-hash ã§ä»˜ä¸ã€‚Â§5.2ï¼‰
* usage ã®æ›´æ–°ï¼ˆÂ§3.7ï¼‰
* limit pre / limit post ã®æ‰±ã„ï¼ˆÂ§6.3 â‘ â‘£ï¼‰
* status ã®è¨­å®šï¼ˆdone / limit / pause / fatalï¼‰

**revision**ï¼šDataNode ã¯ revision ã‚’ç”Ÿæˆã—ãªã„ã€‚BaseNode ãŒ content-hash ã§è‡ªå‹•ä»˜ä¸ã™ã‚‹ï¼ˆÂ§5.7ï¼‰ã€‚StructuralNode ã® revision æ‰±ã„ã¯ Â§6.7 ã«å¾“ã†ã€‚

---

## 6.7 StructuralNode ã®è²¬ä»»ï¼ˆÂ§1.3 åˆ†é¡ã¨ã®å¯¾å¿œï¼‰

**StructuralNode ã¯ Graph ã‚’å†…éƒ¨ã«ä¿æŒã™ã‚‹ Node ã§ã‚ã‚‹ã€‚** StructuralNode ã¯ Graph æ§‹é€ ãã®ã‚‚ã®ã§ã¯ãªã„ã€‚Graph ã¯å®£è¨€çš„æ§‹é€ ã§ã‚ã‚Šã€StructuralNode ã¯ãã®å®Ÿè¡Œçš„å®Ÿä½“ã§ã‚ã‚‹ã€‚StructuralNode.execute ã¯ Core ã«ãŠã‘ã‚‹ âŸ¦GâŸ§ ã®å…·ä½“åŒ–ã§ã‚ã‚‹ã€‚

BaseNode.execute ã‚’å®Œå…¨ã«å…±æœ‰ã—ã€run() ã®ä¸­ã§ subgraphï¼ˆå†…éƒ¨ Graphï¼‰ã‚’å®Ÿè¡Œã™ã‚‹ã€‚Core ã¯ Graph ã¨ãã®æ„å‘³è«– âŸ¦Â·âŸ§ ã‚’å®šç¾©ã™ã‚‹ï¼ˆPart I Â§3ï¼‰ã€‚StructuralNode ã® execute å‘¼ã³å‡ºã—ã«ã‚ˆã£ã¦ã€ãã® Graph æ§‹é€ ãŒå‹•ä½œã™ã‚‹ã€‚ã“ã‚Œã«ã‚ˆã‚Š limit pre/postã€PauseSignalã€LimitSignalã€fatalã€revision è£œå®ŒãŒ DataNode ã¨åŒä¸€ã®ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã§æ‰±ã‚ã‚Œã€è¨­è¨ˆãŒçµ±ä¸€ã•ã‚Œã‚‹ã€‚

**StructuralNode.run ã®ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ **ï¼šStructuralNode ã¯å…±é€šã§ **subgraph ã‚’ 1-shot å®Ÿè¡Œã™ã‚‹**æŠ½è±¡æ“ä½œã‚’æŒã¤ã€‚ã“ã‚Œã‚’ä»•æ§˜ä¸Š `_execute_subgraph()` ã¨è¡¨ã™ã€‚PipelineNode ã¯ã“ã‚Œã‚’ 1 å›å‘¼ã³å‡ºã—ã¦çµ‚äº†ã™ã‚‹ã€‚LoopNode ã¯ condition ãŒ true ã«ãªã‚‹ã¾ã§åå¾©ã—ã¦å‘¼ã³å‡ºã™ã€‚å®Ÿè£…ã®è‡ªç”±åº¦ã‚’çµã‚‹ãŸã‚ã€ä»¥ä¸‹ã®ç–‘ä¼¼ã‚³ãƒ¼ãƒ‰ã§ run ã®éª¨æ ¼ã‚’è¦å®šã™ã‚‹ã€‚

**PipelineNode.run ã®ç–‘ä¼¼ã‚³ãƒ¼ãƒ‰**ï¼ˆÂ§12.2.1 ã®å®Ÿä½“ï¼‰ï¼š

```python
def run(self, inputs, params):
    self._init_context_if_needed()
    while True:
        progressed = self._runner.step()  # å®Ÿè¡Œå¯èƒ½ãƒãƒ¼ãƒ‰ã‚’ 1 ã¤ä»¥ä¸Š execute
        if not progressed:
            break
        if self._check_limit():
            raise LimitSignal()
        if self._should_terminate():  # final_node.status == done ç­‰
            break
    return self._get_final_output()
```

**LoopNode.run ã®ç–‘ä¼¼ã‚³ãƒ¼ãƒ‰**ï¼ˆÂ§12.2.2 ã®å®Ÿä½“ï¼‰ï¼š

```python
def run(self, inputs, params):
    while True:
        self._execute_subgraph()  # subgraph ã‚’ 1-shot å®Ÿè¡Œï¼ˆå†…éƒ¨ã§ Runner ç›¸å½“ã®ãƒ«ãƒ¼ãƒ—ï¼‰
        if self._check_limit():
            raise LimitSignal()
        if final_node.status != "done":
            break  # pause / fatal / limit ç­‰ã‚’ä¼æ’­
        if self._evaluate_condition():  # final_node.status == done ã®ã¨ãã®ã¿è©•ä¾¡ï¼ˆÂ§12.2.2.5ï¼‰
            break
    return self._get_final_output()
```

PipelineNode ã§ã¯ `_execute_subgraph()` ã«ç›¸å½“ã™ã‚‹ 1-shot å®Ÿè¡ŒãŒ run å†…ã® while + _runner.step() ã§å®Ÿç¾ã•ã‚Œã¦ã„ã‚‹ã€‚LoopNode ã¯ã€Œ`_execute_subgraph()` ã‚’åå¾©ã—ã€å„åå¾©å¾Œã« condition ã‚’è©•ä¾¡ã™ã‚‹ã€æ§‹é€ ã§ã‚ã‚‹ã€‚

StructuralNodeï¼ˆPipelineNodeã€LoopNodeï¼‰ã®è²¬ä»»ã¯ä»¥ä¸‹ã¨ã™ã‚‹ã€‚

* childrenï¼ˆå­ã‚°ãƒ©ãƒ•ï¼‰ã®ç®¡ç†
* usage ã®é›†ç´„ï¼ˆÂ§3.7ï¼‰
* status ã®é›†ç´„ï¼ˆå­ã®çŠ¶æ…‹ã‹ã‚‰è‡ªèº«ã® done / limit / pause / fatal ã‚’æ±ºå®šï¼‰
* scope limitï¼ˆparams.limit ã®è§£é‡ˆï¼‰
* termination åˆ¤å®šï¼ˆfinal ãƒãƒ¼ãƒ‰ã® done ç¢ºå®šæ¡ä»¶ï¼‰

**çµ‚äº†åˆ¤å®š**ï¼šStructuralNode ã¯å¿…ãš 1 ã¤ã® **final ãƒãƒ¼ãƒ‰**ã‚’æŒã¤ã€‚graph ã§æ˜ç¤ºçš„ã«æŒ‡å®šã™ã‚‹ï¼ˆÂ§12.2.1.2, Â§12.2.2.2ï¼‰ã€‚

çµ‚äº†æ¡ä»¶ã¯æ¬¡ã®ã¨ãŠã‚Šã§ã‚ã‚‹ã€‚

* **done ã§çµ‚äº†ã™ã‚‹å ´åˆ**ï¼šfinal ãƒãƒ¼ãƒ‰ã® status ãŒ done ã§ã‚ã‚Šã€ã‹ã¤ **ä»–ã® sub ãƒãƒ¼ãƒ‰ã« fatal / limit / pause ãŒ 1 ã¤ã‚‚ã„ãªã„**ã“ã¨ã€‚ã•ã‚‰ã« **executing ã® sub ãƒãƒ¼ãƒ‰ãŒ 1 ã¤ã‚‚ã„ãªã„**ã“ã¨ã€‚executing ãŒ 1 ã¤ã§ã‚‚ã„ã‚‹ã¨ãã¯ StructuralNode ã¯ executing ã®ã¾ã¾ç¶™ç¶šã™ã‚‹ã€‚
* **fatal / limit / pause ã§çµ‚äº†ã™ã‚‹å ´åˆ**ï¼šã„ãšã‚Œã‹ã® sub ãƒãƒ¼ãƒ‰ãŒ fatal, limit, pause ã«ãªã£ãŸã‚‰ã€StructuralNode ã® status ã‚‚ãã®å„ªå…ˆé †ä½ã§é›†ç´„ã—çµ‚äº†ã™ã‚‹ã€‚å„ªå…ˆé †ä½ï¼š**fatal > limit > pause**ã€‚

StructuralNode.status ã¯**å­ãƒãƒ¼ãƒ‰ status ã®å„ªå…ˆé †ä½ä»˜ãé›†ç´„**ã§ã‚ã‚‹ã€‚å„ªå…ˆé †ä½ï¼ˆPriority orderï¼‰ï¼š**fatal > limit > pause > executing > done > ready**ã€‚ã™ãªã‚ã¡ã€å­ã®ã„ãšã‚Œã‹ãŒ executing ã®ã‚ã„ã ã¯é›†ç´„çµæœã‚‚ executingï¼ˆdone ã‚ˆã‚Š executing ã‚’å„ªå…ˆï¼‰ã€‚å½¢å¼çš„ã«ï¼š

```
StructuralNode.status := argmax_priority(child_statuses âˆª {final_status})
```

**StructuralNode ã®æœ€çµ‚ status ã¯ã€å­ãƒãƒ¼ãƒ‰ status ã®å„ªå…ˆé †ä½ä»˜ãé›†ç´„çµæœã«ç­‰ã—ã„ã€‚** **Single source of truth**ï¼šBaseNode ãŒæŒã¤ status ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã¯ **local**ï¼ˆå®Ÿè¡Œä¸­ã¯ executing ç­‰ã®è¡¨ç¤ºç”¨ï¼‰ã§ã‚ã‚‹ã€‚**çµ‚äº†æ™‚ã«ã¯å¿…ãšå­ã®é›†ç´„çµæœã§ä¸Šæ›¸ãã™ã‚‹ã€‚** é›†ç´„ã¯ self.status ã‚’æ›´æ–°ã™ã‚‹ãŸã‚ã®å†…éƒ¨è¨ˆç®—ã§ã‚ã‚Šã€**read_status() ã¯å¸¸ã« self.status ã‚’è¿”ã™**ï¼ˆé›†ç´„çµæœãã®ã‚‚ã®ã‚’è¿”ã™é–¢æ•°ã§ã¯ãªã„ï¼‰ã€‚å®Ÿè£…ã§ã¯ã€Œlocal ã®ä¸€æ™‚çŠ¶æ…‹ã€ã¨ã€Œé›†ç´„ã§æ›´æ–°ã•ã‚ŒãŸ statusã€ã‚’æ··åŒã›ãšã€çµ‚äº†åˆ¤å®šãƒ»ä¼æ’­ã«ã¯å¸¸ã«é›†ç´„çµæœã‚’ç”¨ã„ã‚‹ã€‚

**StructuralNode.read_status()**ï¼šself.status ã‚’è¿”ã™ã€‚self.status ã¯ä¸Šè¨˜ã®ã¨ãŠã‚Šé›†ç´„çµæœã§æ›´æ–°ã•ã‚Œã‚‹ã€‚è¿”ã—ã†ã‚‹å€¤ã¯ä¸Šè¨˜å„ªå…ˆé †ä½ã§æ±ºã¾ã‚‹ã€‚**çµ‚äº†åˆ¤å®šï¼ˆç¶™ç¶šã™ã‚‹ã‹ãƒ»æ­¢ã‚ã‚‹ã‹ï¼‰ã§ã¯**ã€read_status() ã®æˆ»ã‚Šå€¤ã§ã¯ãªã **é›†ç´„çµæœï¼ˆargmax_priority(child_statuses)ï¼‰ã‚’ç›´æ¥å‚ç…§ã™ã‚‹ã“ã¨**ã€‚ã“ã‚Œã«ã‚ˆã‚Šã€Œå­ãŒ done ãªã®ã« self.status ãŒã¾ã  executing ã®ã¾ã¾ã€ã®ã‚ˆã†ãªæ›´æ–°é…ã‚Œã§çµ‚äº†ãŒé…ã‚Œã‚‹ãƒã‚°ã‚’é˜²ãã€‚ç–‘ä¼¼ã‚³ãƒ¼ãƒ‰ï¼š

```python
def read_status():
    return self.status  # é›†ç´„ã¯ self.status ã‚’æ›´æ–°ã™ã‚‹ãŸã‚ã®å†…éƒ¨è¨ˆç®—ã€‚å¤–éƒ¨ã¯ read_status() ã®ã¿å‚ç…§ã™ã‚‹ã€‚
# self.status ã®æ›´æ–°ï¼šå®Ÿè¡Œä¸­ã¯ "executing"ã€ãã‚Œä»¥å¤–ã¯ argmax_priority(child_statuses) ã§ä¸Šæ›¸ãã™ã‚‹ã€‚
```

çµ‚äº†æ™‚ã« StructuralNode è‡ªèº«ã® status ã‚’ä¸Šè¨˜å„ªå…ˆé †ä½ã«å¾“ã£ã¦è¨­å®šã™ã‚‹ã€‚**graceful stop**ï¼špause / limit / fatal æ™‚ã¯ **å®Ÿè¡Œå¯èƒ½åˆ¤å®šã‚’ç„¡åŠ¹åŒ–ã—ã€executing ä¸­ã®ãƒãƒ¼ãƒ‰ã®å®Œäº†å¾…ã¡ã®ã¿è¡Œã†ã€‚** æ–°è¦ execute ã‚’é–‹å§‹ã—ã¦ã¯ãªã‚‰ãªã„ã€‚åŒæœŸï¼éåŒæœŸã®å®Ÿè£…æˆ¦ç•¥ã¯è‡ªç”±ã ãŒã€ã“ã®åˆ¶ç´„ã¯æº€ãŸã™ã“ã¨ã€‚ãã®æ™‚ç‚¹ã® latest_output ã¯ä¿æŒã•ã‚Œã‚‹ï¼ˆÂ§3.3ï¼‰ã€‚

**çµ‚äº†åˆ¤å®šã®ç–‘ä¼¼ã‚³ãƒ¼ãƒ‰**ï¼ˆPipelineNode / LoopNode ç­‰ã§å…±é€šåˆ©ç”¨ï¼‰ï¼š

```python
# çµ‚äº†åˆ¤å®šã¯å…¨å­ãƒãƒ¼ãƒ‰ã® status ã‚’å„ªå…ˆé †ä½ã§é›†ç´„ã—ãŸçµæœã«åŸºã¥ãã€‚
# ã„ãšã‚Œã‹ãŒ fatal/limit/pause ãªã‚‰ãã®å„ªå…ˆé †ä½ã§çµ‚äº†ã€‚ã„ãšã‚Œã‹ãŒ executing ãªã‚‰ executing ã®ã¾ã¾ç¶™ç¶šã€‚
# done ã§çµ‚äº†ã™ã‚‹ã®ã¯ã€å…¨å­ãŒ doneï¼ˆã¾ãŸã¯ readyï¼‰ã§ final ãŒ done ã®ã¨ãã®ã¿ã€‚
status = argmax_priority([c.read_status() for c in children])
if status == "fatal":
    return "fatal"
if status == "limit":
    return "limit"
if status == "pause":
    return "pause"
if status == "done":
    return "done"
# executing / ready ã®å ´åˆã¯ç¶™ç¶š
return None
```

**status æ›´æ–°ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã®è¦å‰‡ï¼ˆç¢ºå®šï¼‰**

StructuralNode ã¯ä»¥ä¸‹ã®ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã§ `self.status` ã‚’é›†ç´„çµæœã§æ›´æ–°ã—ãªã‘ã‚Œã°ãªã‚‰ãªã„ã€‚

1. **å„å­ Node ã® execute() å®Œäº†ç›´å¾Œã€çµ‚äº†åˆ¤å®šã®è©•ä¾¡å‰**ï¼ˆåŒæœŸãƒ»éåŒæœŸã„ãšã‚Œã‚‚ã€‚MUST be updated immediately after each child execute completes, before termination checks are evaluated).
2. **resume() å®Œäº†å¾Œ**

ã€Œwhile ãƒ«ãƒ¼ãƒ—æœ«å°¾ã§ã¾ã¨ã‚ã¦æ›´æ–°ã™ã‚‹ã€å®Ÿè£…ã¯è¨±å¯ã—ãªã„ã€‚ã“ã‚Œã«ã‚ˆã‚Šã€å¤–éƒ¨ã‹ã‚‰ read_status() ã‚’å‘¼ã‚“ã æ™‚ç‚¹ã§ã®å€¤ã¯ã€Œç›´è¿‘ã®å­ execute å®Œäº†æ™‚ç‚¹ã§ã®é›†ç´„çµæœã€ã‚’åæ˜ ã™ã‚‹ã€‚

å½¢å¼çš„ã«ã¯ï¼š

```
after each child_node.execute() returns:
    self.status = argmax_priority([c.read_status() for c in children])
```

ãŸã ã—ã€å®Ÿè¡Œä¸­ï¼ˆexecuting ä¸­ã®å­ãŒå­˜åœ¨ã™ã‚‹ï¼‰ã¯ `argmax_priority` ã®çµæœãŒ executing ã‚’è¿”ã™ãŸã‚ã€`self.status` ã¯ executing ã®ã¾ã¾ã«ãªã‚‹ï¼ˆæ„å›³çš„ï¼‰ã€‚

**æ³¨æ„**ï¼šä¸Šè¨˜ç–‘ä¼¼ã‚³ãƒ¼ãƒ‰ã®ã¨ãŠã‚Šã€StructuralNode ã¯å…¨å­ãƒãƒ¼ãƒ‰ã® status ã‚’ **fatal > limit > pause > executing > done > ready** ã®å„ªå…ˆé †ä½ã§é›†ç´„ã—ã€ãã®çµæœã§è‡ªèº«ã® status ã‚’æ±ºå®šã™ã‚‹ã€‚ä¾‹ï¼šfinal ãƒãƒ¼ãƒ‰ãŒ done ã§ã‚‚ä»–ã®å­ãƒãƒ¼ãƒ‰ãŒ fatal ãªã‚‰ StructuralNode ã¯ fatalã€‚ã„ãšã‚Œã‹ã®å­ãŒ executing ãªã‚‰ StructuralNode ã¯ executing ã®ã¾ã¾ï¼ˆdone ã¨ã¯ãªã‚‰ãªã„ï¼‰ã€‚

**StructuralNode.execute ã®æˆ»ã‚Šå€¤**ï¼šÂ§2.1 ã®å¥‘ç´„ã«å¾“ã†ã€‚**done æ™‚ã¯ final ãƒãƒ¼ãƒ‰ã®å‡ºåŠ›ã‚’ãã®ã¾ã¾è¿”ã™**ï¼ˆrevision å«ã‚ Â§6.7 ã«å¾“ã†ï¼‰ã€‚åœæ­¢ç³»ã§ã¯ä¸‹è¡¨ã®ã¨ãŠã‚Šã€‚

| çµ‚äº†ç†ç”±                | execute ã®æˆ»ã‚Šå€¤           |
|-------------------------|----------------------------|
| done                    | final ãƒãƒ¼ãƒ‰ã®å‡ºåŠ›ï¼ˆãã®ã¾ã¾ï¼‰ |
| limit postï¼ˆrun æˆåŠŸï¼‰  | ãã®å‡ºåŠ› dict              |
| limit postï¼ˆrun æœªæˆåŠŸï¼‰| `{}`                       |
| limit pre / pause / fatal | `{}`                     |

**StructuralNode ã«ãŠã‘ã‚‹ã€Œrun ãŒæˆåŠŸã—ãŸã€**ï¼š**subgraph å®Ÿè¡Œã«ã‚ˆã‚Š final ãƒãƒ¼ãƒ‰ã®å‡ºåŠ› dict ãŒç”Ÿæˆã•ã‚ŒãŸã“ã¨**ã‚’æŒ‡ã™ã€‚status ãŒ done ã§ã‚ã‚‹ã“ã¨ã¨ã¯ç‹¬ç«‹ã§ã‚ã‚‹ã€‚run æˆåŠŸ + status=limitï¼ˆlimit postï¼‰ã‚„ run æˆåŠŸ + status=done ã¯ã„ãšã‚Œã‚‚ã‚ã‚Šå¾—ã‚‹ã€‚limit post ã§ã€Œå‡ºåŠ›ã‚’è¿”ã™ã€ã¨ã¯ã€run ãŒå‡ºåŠ›ã‚’ç”Ÿæˆã—ãŸãŒãã®å¾Œã« limit ã«é”ã—ãŸå ´åˆã«ã€ãã®å‡ºåŠ›ã‚’è¿”ã—ã¤ã¤ status=limit ã§çµ‚äº†ã™ã‚‹ã“ã¨ã‚’æ„å‘³ã™ã‚‹ã€‚

**å­ã® status ã«å¯¾ã™ã‚‹æŒ™å‹•**ï¼šready / executing â†’ ç¶™ç¶šã€‚done â†’ çµ‚äº†åˆ¤å®šã¸ï¼ˆPipelineNode ã¯çµ‚äº†ã€LoopNode ã¯ condition è©•ä¾¡ï¼‰ã€‚fatal / limit / pause â†’ åœæ­¢ï¼ˆgraceful stopï¼‰ã€‚

**å­ãŒ limit ã«ãªã£ãŸã¨ãã® StructuralNode ã®ç¾©å‹™**ï¼šIf any child node enters status = limit, StructuralNode MUST:
- Set its own status = limit
- Stop scheduling further nodes
- Return the final node output only if the final node produced output

**pre/post limit**ï¼šStructuralNode ã‚‚ limit ã‚’æŒã¤ã€‚**limit ãƒã‚§ãƒƒã‚¯ã®ã‚¿ã‚¤ãƒŸãƒ³ã‚°**ã¯ (1) execute é–‹å§‹ç›´å¾Œ (2) å„å­ãƒãƒ¼ãƒ‰ã® execute å®Œäº†ç›´å¾Œã® 2 ã¤ã®ã¿ã€‚çµ‚äº†ã¯ (2) ã® limit ãƒã‚§ãƒƒã‚¯ã®å¾Œã«è¡Œã†ã€‚è¶…éæ™‚ã¯ status = limit ã§ graceful stopã€‚çµ‚äº†åˆ¤å®šã§ã¯ limit ãŒ done ã‚ˆã‚Šå„ªå…ˆã•ã‚Œã‚‹ã€‚

**revision**ï¼šStructuralNode ã¯ revision ã‚’å¤‰æ›´ã—ãªã„ã€‚final ãƒãƒ¼ãƒ‰ã®å‡ºåŠ›ã‚’ãã®ã¾ã¾è¿”ã—ã€revision ã¯ final ãƒãƒ¼ãƒ‰ãŒç”Ÿæˆã—ãŸå€¤ã‚’ä¿æŒã™ã‚‹ã€‚StructuralNode ã¯ãƒ‡ãƒ¼ã‚¿ã‚’ç”Ÿæˆãƒ»å¤‰æ›ã—ãªã„åˆ¶å¾¡ãƒãƒ¼ãƒ‰ã§ã‚ã‚Šã€revision å¥‘ç´„ã«ã¯é–¢ä¸ã—ãªã„ã€‚ï¼ˆæœ¬æ®µè½ãŒ StructuralNode ã® revision ã®æ­£ã®å®šç¾©ã€‚ï¼‰

**resume ã®å…±é€šä»•æ§˜**ï¼š**API** ã¯ `resume(resume_inputs: dict) -> dict`ã€‚PipelineNode ã¨ LoopNode ã§åŒä¸€ã§ã‚ã‚‹ã€‚**node_id ã®æ–¹é‡**ï¼šresume ã®**å‘¼ã³å‡ºã—å¼•æ•°**ï¼ˆã©ã® node ã‚’ resume ã™ã‚‹ã‹ã®æŒ‡å®šï¼‰ã«ã¯ node_id ã‚’ä½¿ã‚ãªã„ã€‚å†…éƒ¨æ§‹é€ ã‚’ API ã«æ¼ã‚‰ã•ãªã„ã¨ã„ã†æ„å‘³ã§ã¯ã€Œå¯¾è±¡æŒ‡å®šã« node_id ã‚’ç”¨ã„ãªã„ã€ã§ã‚ã‚‹ã€‚æˆ»ã‚Šå€¤ã« node_id ã‚’å«ã‚ã‚‹ã“ã¨ã¯è¨±å®¹ã—ã€å®Ÿè£…ãƒ»ç›£è¦–ã®ä¾¿å®œã«ä¾›ã™ã‚‹ã€‚

**å‘¼ã³å‡ºã—æ¡ä»¶**ï¼šStructuralNode ã® status ãŒ `pause` ã®ã¨ãã®ã¿å‘¼ã¹ã‚‹ã€‚pause ãƒãƒ¼ãƒ‰ãŒ 1 ã¤ä»¥ä¸Šå­˜åœ¨ã™ã‚‹ã“ã¨ã€‚é•åæ™‚ã¯ **InvalidStateError** ã‚’ raise ã™ã‚‹ã€‚StructuralNode ãŒ pause ã«ãªã‚‹ã®ã¯ã€å­ãƒãƒ¼ãƒ‰ã®ã„ãšã‚Œã‹ãŒ pause ã«ãªã£ãŸå ´åˆã®ã¿ã§ã‚ã‚‹ï¼ˆÂ§6.7 å­ã® status é›†ç´„ï¼‰ã€‚ã—ãŸãŒã£ã¦ StructuralNode.status == pause ã®å ´åˆã€å¸¸ã« 1 ã¤ä»¥ä¸Šã® pause å­ãƒãƒ¼ãƒ‰ãŒå­˜åœ¨ã™ã‚‹ã€‚

**å‹•ä½œ**ï¼š(1) pause çŠ¶æ…‹ã®ãƒãƒ¼ãƒ‰ã‚’ã™ã¹ã¦åˆ—æŒ™ã™ã‚‹ã€‚åˆ—æŒ™é †ã¯ graph.nodes ã®è¨˜è¿°é †ã«å¾“ã†ï¼ˆÂ§7.1.1 ã¨åŒä¸€ã®æ±ºå®šæ€§ãƒ«ãƒ¼ãƒ«ï¼‰ã€‚(2) å„ãƒãƒ¼ãƒ‰ã« `execute(resume_inputs, params)` ã‚’å‘¼ã¶ï¼ˆparams ã¯é€šå¸¸ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒªãƒ³ã‚°æ™‚ã¨åŒä¸€ã€‚StructuralNode ãŒ graph å®šç¾©ã‹ã‚‰è§£æ±ºã™ã‚‹ï¼‰ã€‚(3) å‡ºåŠ›ãŒ `{}` ã§ãªã‘ã‚Œã°ä¿å­˜ã™ã‚‹ï¼ˆÂ§3.3ï¼‰ã€‚(4) **resume å‘¼ã³å‡ºã—ä¸­ã« fatal ãŒç™ºç”Ÿã—ãŸå ´åˆã¯ã€ãã‚Œä»¥é™ã® resume ã¯å®Ÿè¡Œã›ãšå³åº§ã«åœæ­¢ã™ã‚‹ã€‚** (5) ã™ã¹ã¦ã® resume å‘¼ã³å‡ºã—å®Œäº†å¾Œã€é€šå¸¸ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒªãƒ³ã‚°ã«æˆ»ã‚Šã€termination åˆ¤å®šã‚’å†è©•ä¾¡ã™ã‚‹ã€‚StructuralNode ã¯ä¸€æ™‚çš„ã« status ã‚’ executing ã«æˆ»ã—ã€çµ‚äº†åˆ¤å®šã«å¾“ã£ã¦æœ€çµ‚ status ã‚’å†è¨­å®šã™ã‚‹ã€‚

**resume æ™‚ã®å…¥åŠ›**ï¼šresume æ™‚ã«ã¯ **resume_inputs ã®ã¿**ãŒ pause ãƒãƒ¼ãƒ‰ã«æ¸¡ã•ã‚Œã‚‹ã€‚é€šå¸¸ã® inputs ã¯å†è§£æ±ºã—ãªã„ã€‚å¿…è¦ãªçŠ¶æ…‹ã¯ Node ãŒå†…éƒ¨ã§ä¿æŒã™ã‚‹è²¬ä»»ãŒã‚ã‚‹ã€‚

**ãƒã‚¹ãƒˆæ§‹é€ ã§ã® resume**ï¼šStructuralNode å†…ã®å­ãƒãƒ¼ãƒ‰ãŒ StructuralNodeï¼ˆPipelineNode / LoopNodeï¼‰ã§ã‚ã‚‹å ´åˆã€ãã®å­ StructuralNode ãŒ pause çŠ¶æ…‹ã§ã‚ã‚Œã°ã€è¦ªã¯å­ StructuralNode ã® `resume()` ã‚’å‘¼ã¶ã€‚è¦ªãŒå­«ãƒãƒ¼ãƒ‰ä»¥ä¸‹ã‚’ç›´æ¥ resume ã™ã‚‹ã“ã¨ã¯ç¦æ­¢ã™ã‚‹ã€‚resume ã¯ãƒã‚¹ãƒˆã®å¤–å´ã‹ã‚‰é †ã«å‘¼ã³å‡ºã•ã‚Œã‚‹ã€‚ä¾‹ï¼šå¤–å´ PipelineNode â†’ å†…å´ LoopNode ãŒ pause ã®å ´åˆã€`outer_pipeline.resume(inputs)` ã«ãŠã„ã¦ outer ã¯ `inner_loop.resume(inputs)` ã‚’å‘¼ã³ã€inner_loop ã¯ pause ä¸­ã®å­ãƒãƒ¼ãƒ‰ã« execute ã‚’å‘¼ã¶ã€‚å¤–å´ã‹ã‚‰ç›´æ¥ inner_loop å†…ã®å­ãƒãƒ¼ãƒ‰ã‚’ resume ã™ã‚‹ã“ã¨ã¯ãªã„ã€‚

**æˆ»ã‚Šå€¤**ï¼š`{"resumed": [node_id, ...], "statuses": { node_id: "done" | "pause" | "limit" | "fatal" }}`ã€‚resume ã—ãŸãƒãƒ¼ãƒ‰ ID ã®ãƒªã‚¹ãƒˆã¨ã€å„ãƒãƒ¼ãƒ‰ã® resume å¾Œã® status ã‚’è¿”ã™ï¼ˆnode_id ã¯æˆ»ã‚Šå€¤ã«ã¯å«ã‚ã¦ã‚ˆã„ã€‚ä¸Šè¨˜ã€Œnode_id ã®æ–¹é‡ã€å‚ç…§ï¼‰ã€‚å‘¼ã³å‡ºã—å…ƒãŒå¾Œç¶šå‡¦ç†ã‚’åˆ¤æ–­ã§ãã‚‹ã€‚æˆ»ã‚Šå€¤ã¯ resume å‘¼ã³å‡ºã—ä¸­ã®å„ Node ã®ç›´å¾ŒçŠ¶æ…‹ã‚’ç¤ºã™ã‚‚ã®ã§ã‚ã‚Šã€æœ€çµ‚çš„ãª StructuralNode.status ã¯åˆ¥é€” read_status() ã«ã‚ˆã‚Šç¢ºèªã™ã‚‹ã“ã¨ã€‚

**resume_inputs**ï¼šå˜ä¸€ã® dict ã‚’å…¨ pause ãƒãƒ¼ãƒ‰ã«æ¸¡ã™ã€‚å„ Node ã¯è‡ªåˆ†ãŒå¿…è¦ãªã‚­ãƒ¼ã ã‘èª­ã‚€ï¼ˆä»–ã¯ç„¡è¦–ï¼‰ã€‚Node ã¯ black-box ã§ã‚ã‚Šã€å†…éƒ¨æ§‹é€ ã‚’ API ã«æ¼ã‚‰ã•ãªã„ã€‚resume_inputs_schema ã¯å¤–éƒ¨ã«ã€Œä½•ã‚’æ¸¡ã›ã°ã‚ˆã„ã‹ã€ã‚’ä¼ãˆã‚‹å‚è€ƒæƒ…å ±ã§ã‚ã‚Šã€ã‚¨ãƒ³ã‚¸ãƒ³ã¯è§£é‡ˆã—ãªã„ã€‚**resume_inputs ã®ã‚­ãƒ¼è¡çªã¯æœªå®šç¾©å‹•ä½œã§ã‚ã‚Šã€ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³è¨­è¨ˆè€…ã®è²¬ä»»ã¨ã™ã‚‹ã€‚** é™çš„è¨ºæ–­ãƒ„ãƒ¼ãƒ«ã¯ã€åŒä¸€ Graph å†…ã§è¤‡æ•° Node ãŒ pause ã«ãªã‚Šå¾—ã‚‹å ´åˆã« resume_inputs_schema ã®ã‚­ãƒ¼ãŒè¡çªã—ã¦ã„ãªã„ã‹ã‚’è­¦å‘Šã™ã‚‹ã“ã¨ãŒæ¨å¥¨ã•ã‚Œã‚‹ï¼ˆSHOULD warnï¼‰ã€‚

**å®Ÿè¡Œä¸èƒ½çŠ¶æ…‹**ï¼šÂ§7.5 ã«å¾“ã†ã€‚**çŠ¶æ…‹ä¿æŒ**ï¼šStructuralNode ã‚‚å†…éƒ¨çŠ¶æ…‹ã‚’æŒã£ã¦ã‚ˆã„ã€‚**limit ã®ä¾‹**ï¼šparams.limit ã§ max_total_node_calls / max_idle_sec / max_iterations ç­‰ã‚’æŒ‡å®šã™ã‚‹ã€‚è©³ç´°ã¯å„ Nodeï¼ˆÂ§12.2.1.9, Â§12.2.2.10ï¼‰å‚ç…§ã€‚

**StructuralNode.run ã®è²¬å‹™å¢ƒç•Œï¼ˆMUST / MUST NOTï¼‰**

StructuralNode.run **MUST NOT**ï¼š

* å­ãƒãƒ¼ãƒ‰ã®çŠ¶æ…‹ã‚’ç›´æ¥å¤‰æ›´ã™ã‚‹
* BaseNode.execute ã®æµã‚Œã‚’ãƒã‚¤ãƒ‘ã‚¹ã™ã‚‹ï¼ˆå­ã®å®Ÿè¡Œã¯å¿…ãš `child_node.execute()` çµŒç”±ï¼‰
* revision ã‚’å¤‰æ›´ã™ã‚‹
* fatal ã‚’ status ä¼æ’­ã›ãšã«æ¡ã‚Šã¤ã¶ã™

StructuralNode.run **MUST**ï¼š

* å­ã®å®Ÿè¡Œã« `child_node.execute()` ã‚’ç”¨ã„ã‚‹
* å­ã® status ã‚’é›†ç´„ã™ã‚‹
* çµ‚äº†åˆ¤å®šã‚’ final ãƒãƒ¼ãƒ‰ãŠã‚ˆã³å­ã® status ã®ã¿ã«åŸºã¥ã„ã¦è¡Œã†
* BaseNode ã® limit pre/post ã®æ„å‘³è«–ã‚’å°Šé‡ã™ã‚‹

---

# 7. StructuralNode ã¨ Runnerï¼ˆExecution Mechanismï¼‰

**FlowRunner ã¨ã„ã†æ¦‚å¿µã¯å­˜åœ¨ã—ãªã„ã€‚** å®Ÿè¡Œä¸»ä½“ã¯ StructuralNode ã§ã‚ã‚Šã€Runner ã¯ãã®å†…éƒ¨æ©Ÿæ§‹ã§ã‚ã‚‹ã€‚

**Runner ã®å®šç¾©**ï¼šRunner ã¯ StructuralNode å†…éƒ¨ã§ã€Graph æ§‹é€ ã«å¾“ã„å­ Node ã® execute ã‚’å‘¼ã³å‡ºã™è£œåŠ©æ©Ÿæ§‹ã§ã‚ã‚‹ã€‚Graph ã®æ„å‘³è«–ã‚’å®Ÿç¾ã™ã‚‹ä¸»ä½“ã¯ StructuralNode ã§ã‚ã‚‹ã€‚Runner ã¯ inputs è§£æ±ºãƒ»å®Ÿè¡Œå¯èƒ½åˆ¤å®šãƒ»execute å‘¼ã³å‡ºã—ãƒ»æœ€æ–°å‡ºåŠ›ä¿å­˜ã‚’è¡Œã†ã€‚**Runner ã¯ dumb**ï¼ˆè©³ç´°ã¯ Â§7.2ï¼‰ã€‚

**å®Ÿè¡Œé–‹å§‹**ï¼šãƒˆãƒƒãƒ—ãƒ¬ãƒ™ãƒ« StructuralNode ã® execute å‘¼ã³å‡ºã—ã«ã‚ˆã£ã¦ã€å†…éƒ¨ Graph ã®æ„å‘³è«–ãŒå…·ä½“å®Ÿè¡Œã•ã‚Œã‚‹ã€‚é€šå¸¸ã®å®Ÿè£…ã§ã¯ãƒˆãƒƒãƒ—ãƒ¬ãƒ™ãƒ«ã¯ PipelineNode ã§ã‚ã‚‹ãŒã€ã“ã‚Œã¯ StructuralNode ã®ä¸€ç¨®ã§ã‚ã‚‹ã€‚

**Kick** ã¨ã¯ã€å½“è©²å®Ÿè¡Œã‚’é–‹å§‹ã™ã‚‹ã“ã¨ã‚’æŒ‡ã™ã€‚å®šç¾©ï¼šãƒˆãƒƒãƒ—ãƒ¬ãƒ™ãƒ« StructuralNode ã® `execute(inputs, params)` ãŒ kick ã§ã‚ã‚‹ï¼ˆé€šå¸¸ã¯ PipelineNodeï¼‰ã€‚

**Runner ã®ä½ç½®ã¥ã‘**ï¼šGraph ã‚’å†…éƒ¨ã«ä¿æŒã™ã‚‹ StructuralNodeï¼ˆPipelineNodeã€LoopNodeï¼‰ã¯ Runner ã‚’ä¿æŒã—ã€å­ãƒãƒ¼ãƒ‰ã® execute ã‚’ç®¡ç†ã™ã‚‹ã€‚Runner ã¯å¤–éƒ¨ API ã§ã¯ãªã„ã€‚è²¬å‹™ã¯å®Ÿè¡Œå¯èƒ½åˆ¤å®šãƒ»inputs è§£æ±ºãƒ»node.execute å‘¼ã³å‡ºã—ãƒ»latest_output ç®¡ç†ã§ã‚ã‚‹ã€‚Core ã® Graph ã¯æŠ½è±¡æ§‹é€ ã§ã‚ã‚Šã€StructuralNode ã‚„ Runner ã¨åŒä¸€ã§ã¯ãªã„ã€‚

## 7.1 Pullå‹ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ©

**Input port requirements**ï¼šInput port ã® required ã¯ **node.yaml** ã«å®šç¾©ã•ã‚Œã‚‹ã€‚`required` ã‚’çœç•¥ã—ãŸå ´åˆã¯ **true** ã¨ã™ã‚‹ã€‚Runner ã¯å®Ÿè¡Œå¯èƒ½æ€§ã‚’ã€required ãª port ãŒã™ã¹ã¦è§£æ±ºå¯èƒ½ã‹ã©ã†ã‹ã®ã¿ã§åˆ¤å®šã™ã‚‹ã€‚æœªè§£æ±ºã® input ã¯ fatal ã«ã¯ãªã‚‰ãªã„ã€‚

**å®Ÿè¡Œå¯èƒ½æ¡ä»¶**ï¼šãƒãƒ¼ãƒ‰ã¯ **required:true ã® input port ãŒã™ã¹ã¦è§£æ±ºã§ããŸå ´åˆ**ã«å®Ÿè¡Œå¯èƒ½ã§ã‚ã‚‹ã€‚ã“ã®æ¡ä»¶ã‚’å½¢å¼å®šç¾©ã§ã¯ **RequiredInputsResolved(n, t)** ã¨è¡¨ã™ï¼ˆÂ§12.2.1.9 ã® max_idle_sec å½¢å¼å®šç¾©å‚ç…§ï¼‰ã€‚Â§7.1 ã®æœ¬é …ã¨åŒç¾©ã§ã‚ã‚Šã€å®Ÿè£…æ™‚ã«ç‹¬è‡ªã«æ‹¡å¼µè§£é‡ˆã—ã¦ã¯ãªã‚‰ãªã„ã€‚

**ã€Œè§£æ±ºã§ããŸã€ã¨ã¯**ã€ãƒã‚¤ãƒ³ãƒ‡ã‚£ãƒ³ã‚°å…ˆãƒãƒ¼ãƒ‰ã® latest_output ã«å½“è©² port ã®å€¤ãŒå­˜åœ¨ã™ã‚‹ã“ã¨ã‚’æŒ‡ã™ã€‚ãƒã‚¤ãƒ³ãƒ‡ã‚£ãƒ³ã‚°å…ˆãƒãƒ¼ãƒ‰ã® status ã¯å•ã‚ãªã„ã€‚fatal / limit ãƒãƒ¼ãƒ‰ã®å‡ºåŠ›ãŒ latest_output ã«å­˜åœ¨ã™ã‚‹å ´åˆã€ãã‚Œã‚’æœ‰åŠ¹ãªå…¥åŠ›ã¨ã—ã¦æ‰±ã†ã€‚ã“ã‚Œã¯æ„å›³çš„ãªè¨­è¨ˆã§ã‚ã‚Šã€åœæ­¢ã—ãŸ Node ã®å‡ºåŠ›ã‚’å¾Œç¶š Node ãŒå‚ç…§ã§ãã‚‹ã“ã¨ã‚’ä¿è¨¼ã™ã‚‹ã€‚

* required:false ã® port ã¯è§£æ±ºã§ããªãã¦ã‚‚å®Ÿè¡Œå¯èƒ½
* å¾ªç’°åˆæœŸå€¤ã‚„ optional port ã¨ã®æ•´åˆã®ãŸã‚ã€ã€Œã™ã¹ã¦ã® inputs ãŒå­˜åœ¨ã™ã‚‹ã€ã§ã¯ãªãã€Œrequired:true ã® inputs ãŒã™ã¹ã¦è§£æ±ºã§ãã‚‹ã€ã§åˆ¤å®šã™ã‚‹

---

## 7.1.1 å®Ÿè¡Œé †åºã®æ±ºå®šæ€§ï¼ˆç¢ºå®šä»•æ§˜ï¼‰

Runner ã¯ **graph.nodes ã®è¨˜è¿°é †ã«ãƒãƒ¼ãƒ‰ã‚’èµ°æŸ»ã—ã€å®Ÿè¡Œå¯èƒ½ãƒãƒ¼ãƒ‰ã‚’åˆ¤å®šã™ã‚‹**ã€‚

ä¸¦åˆ—å®Ÿè¡Œã‚’è¡Œã†å ´åˆã‚‚ã€è«–ç†é †åºã¯ nodes é…åˆ—é †ã«å¾“ã†ã€‚

* å†ç¾æ€§ç¢ºä¿
* ãƒ‡ãƒãƒƒã‚°å®¹æ˜“
* determinism ã‚’æ‹…ä¿
* ä¸¦åˆ—æœ€é©åŒ–ã®ä½™åœ°ã¯æ®‹ã™

---

## 7.2 Runner ã®è²¬å‹™

Runner ã¯ï¼š

* inputs è§£æ±º
* å®Ÿè¡Œå¯èƒ½åˆ¤å®š
* node.execute å‘¼ã³å‡ºã—
* æœ€æ–°å‡ºåŠ›ä¿å­˜ï¼ˆÂ§3.3ã€‚ä¿å­˜ã¯ Runner ã® API ã§è¡Œã„ã€resume ã‹ã‚‰ã‚‚åŒ API ã‚’ä»‹ã™ã‚‹ã€‚`save_output` ã¯ `{}` ã‚’ã‚¹ã‚­ãƒƒãƒ—ã™ã‚‹ï¼‰ã€‚

Runner ã¯ï¼š

* **READY ãƒãƒ¼ãƒ‰ã‚’ execute ã™ã‚‹**ï¼ˆÂ§7.3ï¼‰ã€‚å®Ÿè¡Œå¯èƒ½åˆ¤å®šã« status ã‚’å‚ç…§ã™ã‚‹ãŒã€Runner ã¯ status ã®æ„å‘³ã‚’è§£é‡ˆã—ãªã„ï¼ˆåœæ­¢åˆ¶å¾¡ã¯ StructuralNodeï¼ˆÂ§6.7ï¼‰ã®è²¬å‹™ï¼‰
* **usage ã‚’è§¦ã‚‰ãªã„**ï¼ˆÂ§3.7ï¼‰
* **limit ã‚’è©•ä¾¡ã—ãªã„**ï¼ˆlimit ã¯ Node / StructuralNode ã®è²¬å‹™ï¼‰
* limit ç®¡ç†ã‚’ã—ãªã„
* retry ç®¡ç†ã‚’ã—ãªã„
* revision ã‚’è§£é‡ˆã—ãªã„ï¼ˆÂ§5.1ï¼‰
* ä¾‹å¤–å‡¦ç†ã‚’ã—ãªã„
* **kill ã—ãªã„**
* **interrupt ã—ãªã„**

**Runner ã¯ status ã®æ„å‘³ï¼ˆåœæ­¢åˆ¶å¾¡ï¼‰ã‚’è§£é‡ˆã—ãªã„ãŒã€å®Ÿè¡Œå¯èƒ½åˆ¤å®šã®ãŸã‚ã«å€¤ã¯å‚ç…§ã™ã‚‹ã€‚** åˆ¶å¾¡ã¯ StructuralNodeï¼ˆÂ§6.7ï¼‰ã®è²¬å‹™ã§ã‚ã‚‹ã€‚Runner ã¯ status ã‚’**å®Ÿè¡Œå¯èƒ½åˆ¤å®šã®ãŸã‚ã®ãƒ•ã‚£ãƒ«ã‚¿è¿°èª**ã¨ã—ã¦ã®ã¿ç”¨ã„ã‚‹ã€‚Runner **MUST NOT**ï¼šfatal ã‚’ä¼æ’­ã™ã‚‹ã€å®Ÿè¡Œãƒ«ãƒ¼ãƒ—ã‚’åœæ­¢ã™ã‚‹ã€çµ‚äº†æ¡ä»¶ã‚’è©•ä¾¡ã™ã‚‹ã€pause ã®æ„å‘³ã‚’è§£é‡ˆã™ã‚‹ã€‚ã“ã‚Œã‚‰ã¯ã™ã¹ã¦ StructuralNodeï¼ˆÂ§6.7ï¼‰ã®è²¬å‹™ã§ã‚ã‚‹ã€‚

---

## 7.3 å®Ÿè¡Œåˆ¶å¾¡ï¼ˆåŸºæœ¬å‹•ä½œï¼‰

**Runner ã¯ status ãŒ ready ã¾ãŸã¯ done ã®ãƒãƒ¼ãƒ‰ã®ã¿ execute ã™ã‚‹ã€‚** executing / pause / limit / fatal ã®ãƒãƒ¼ãƒ‰ã¯å®Ÿè¡Œã—ãªã„ã€‚ï¼ˆasync ãƒãƒ¼ãƒ‰ãŒå†…éƒ¨ã§ await ã—ã¦ã„ã‚‹é–“ã‚‚ status ã¯ executing ã®ãŸã‚ã€Runner ã¯å½“è©²ãƒãƒ¼ãƒ‰ã‚’å†åº¦ execute ã—ãªã„ã€‚ï¼‰**pause çŠ¶æ…‹ã®ãƒãƒ¼ãƒ‰ã¸ã® execute ã¯ã€StructuralNode ã® `resume()` çµŒç”±ã§ã®ã¿è¡Œã‚ã‚Œã‚‹ï¼ˆÂ§6.7ï¼‰ã€‚** Runner ã¯ pause ãƒãƒ¼ãƒ‰ã‚’è‡ªç™ºçš„ã«ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã—ãªã„ã€‚å­ãƒãƒ¼ãƒ‰ã® status ã‚’èª­ã‚“ã§åˆ¶å¾¡ã™ã‚‹ã®ã¯ StructuralNode ã®è²¬å‹™ï¼ˆÂ§6.7ã€‚Â§2.3.3 å‚ç…§ï¼‰ã€‚

**Atomicity requirement for parallel execution**  
When parallel execution is enabled (Â§7.6), the Runner MUST ensure that the check of a Node's status and the invocation of execute() are performed atomically with respect to other Runner threads or coroutines operating on the same Node. Concretely:

* A Node whose status transitions to `executing` MUST NOT be scheduled for execution again until its status leaves `executing`.
* The mechanism for ensuring this atomicity (lock, async guard, etc.) is implementation-defined, but the invariant MUST be preserved.

Violation of this invariant results in undefined behavior of Node.state.

---

## 7.4 çµ‚äº†åˆ¤å®šãƒ»graceful stop

**çµ‚äº†åˆ¤å®šãŠã‚ˆã³ pause / limit / fatal æ™‚ã®æŒ¯ã‚‹èˆã„ï¼ˆgraceful stopï¼‰ã¯ Â§6.7 ã«å®Œå…¨ã«å±ã™ã‚‹ã€‚** Runner ã¯å®Ÿè¡Œå¯èƒ½åˆ¤å®šã¨ execute å‘¼ã³å‡ºã—ã®ã¿è¡Œã†ã€‚åˆ¶å¾¡ã¯ StructuralNodeï¼ˆÂ§6.7ï¼‰ã®è²¬å‹™ã§ã‚ã‚‹ã€‚

**graceful stop ä¸­ã®åˆ¶ç´„**ï¼šStructuralNode ãŒ graceful stop ã«å…¥ã£ãŸå¾Œã¯ã€**å®Ÿè¡Œå¯èƒ½åˆ¤å®šã‚’ç„¡åŠ¹åŒ–ã—ã€executing ä¸­ã®ãƒãƒ¼ãƒ‰ã®å®Œäº†å¾…ã¡ã®ã¿è¡Œã†ã€‚** æ–°è¦ã« execute ã‚’é–‹å§‹ã—ã¦ã¯ãªã‚‰ãªã„ï¼ˆpolling ã§ã‚‚ await ã§ã‚‚ã€ã€Œå¾…ã¤ã€ã®å®Ÿè£…ã¯è‡ªç”±ã ãŒç¦æ­¢äº‹é …ã¯å®ˆã‚‹ã“ã¨ï¼‰ã€‚

**æ³¨æ„**ï¼šv1.2 ã§ã¯ kill ã‚’æŒãŸãªã„ãŸã‚ã€**å¤–éƒ¨ I/O ã‚’å«ã‚€ Node ã¯ timeout ã‚’å†…éƒ¨ã§å®Ÿè£…ã—ãªã‘ã‚Œã°ãªã‚‰ãªã„ï¼ˆMUSTï¼‰**ã€‚ãã†ã§ãªã„å ´åˆã€executing ä¸­ã®ãƒãƒ¼ãƒ‰å®Œäº†å¾…ã¡ã§æ°¸ä¹…å¾…æ©Ÿã¨ãªã‚Šã€max_idle_sec ç­‰ãŒæ©Ÿèƒ½ã—ãªã„ï¼ˆÂ§6.1, Â§6.7 graceful stopï¼‰ã€‚

---

## 7.5 å®Ÿè¡Œä¸èƒ½çŠ¶æ…‹ï¼ˆdeadlockï¼‰

**deadlock ã‚’æ§‹é€ çš„ã«ã¯æ¤œå‡ºã—ãªã„ã€‚** é™çš„è¨ºæ–­ãƒ„ãƒ¼ãƒ«ã§æ‰±ã†ã€‚**ãŸã ã—é€²æ—ãŒãªã„çŠ¶æ…‹ã¯ limitï¼ˆmax_idle_sec ç­‰ï¼‰ã«ã‚ˆã£ã¦åœæ­¢ã§ãã‚‹ã€‚**ï¼ˆÂ§12.2.1.9ï¼‰

* deadlock ã¯ **fatal ã«ãªã‚‰ãªã„**ï¼ˆStructuralNode ãŒ runtime ã§ fatal ã¨ã—ã¦æ‰±ã†ã“ã¨ã¯ãªã„ï¼‰
* æ¤œå‡ºã¯ limit ã‚„é™çš„è¨ºæ–­ãƒ„ãƒ¼ãƒ«ã«å§”ã­ã‚‹

---

## 7.6 ä¸¦åˆ—å®Ÿè¡Œ

* å®Ÿè¡Œå¯èƒ½ãƒãƒ¼ãƒ‰ã¯ä¸¦åˆ—å®Ÿè¡Œå¯èƒ½
* LLM å¾…æ©Ÿä¸­ã«ä»–ãƒãƒ¼ãƒ‰ã‚’å®Ÿè¡Œå¯èƒ½
* åˆæœŸå®Ÿè£…ã¯æœ€å°é™ï¼ˆä¾‹ï¼šasyncï¼‰ã§ã‚ˆã„

---

## 7.7 çŠ¶æ…‹ã¨ãƒ«ãƒ¼ãƒ—ã®æ•´åˆæ€§

* Node ã¯å†å®Ÿè¡Œå¯èƒ½
* done ã¯å†å®Ÿè¡Œå¯èƒ½ãªçŠ¶æ…‹
* reset ã¯ä¸è¦
* execution_id ã¯ä¸è¦
* LoopNode ã¯ Node ã‚’å† execute ã™ã‚‹ã ã‘

è¨­è¨ˆã¯æ•´åˆã—ã¦ã„ã‚‹ã€‚

---

## 7.8 éåŒæœŸã¨ã®æ•´åˆ

* Node ã¯ executing ä¸­ã« await å¯èƒ½
* Runner ã¯ kill ã—ãªã„
* graceful stop ãŒåŸºæœ¬
* ãƒªã‚½ãƒ¼ã‚¹ãƒªãƒ¼ã‚¯ã‚’é¿ã‘ã‚‹

---

# 8. å¾ªç’°ã‚°ãƒ©ãƒ•

* å¾ªç’°ã¯è¨±å¯
* **åˆæœŸå€¤ã®ãªã„å¾ªç’°**ï¼šRunner ãŒ inputs ã‚’è§£æ±ºã—ã‚ˆã†ã¨ã—ãŸéš›ã€å¾ªç’°ä¾å­˜ã«ã‚ˆã‚Šå‚ç…§å…ˆã®å‡ºåŠ›ãŒå­˜åœ¨ã—ãªã„å ´åˆã€è©²å½“ãƒãƒ¼ãƒ‰ã¯ã€Œå®Ÿè¡Œä¸èƒ½ã€ã¨ã—ã¦æ‰±ã†ã€‚**åˆæœŸå€¤ã®ãªã„å¾ªç’°ã¯ runtime ã§ã¯ fatal ã«ã—ãªã„ã€‚** è©²å½“ãƒãƒ¼ãƒ‰ã¯å®Ÿè¡Œä¸èƒ½ã¨ãªã‚Šã€çµæœã¨ã—ã¦é€²æ—ã®ãªã„çŠ¶æ…‹ã«ãªã‚‹ã€‚ã“ã®çŠ¶æ…‹ã¯ `max_idle_sec` ã«ã‚ˆã‚Šåœæ­¢å¯èƒ½ã§ã‚ã‚‹ï¼ˆÂ§12.2.1.9ï¼‰ã€‚**é™çš„è¨ºæ–­ãƒ„ãƒ¼ãƒ«ã§äº‹å‰æ¤œå‡ºã™ã‚‹ã“ã¨ã‚’å¼·ãæ¨å¥¨ã™ã‚‹ã€‚**
* **åˆæœŸå€¤ã®ä¸ãˆæ–¹**ï¼š(1) Flow ã® inputs ã¨ã—ã¦å¤–éƒ¨ã‹ã‚‰æ³¨å…¥ã™ã‚‹ (2) å¾ªç’°ä¸Šã®ã„ãšã‚Œã‹ã®ãƒãƒ¼ãƒ‰ãŒ params ã‹ã‚‰åˆæœŸå€¤ã‚’ç”Ÿæˆã—ã€inputs ãªã—ã§å®Ÿè¡Œã§ãã‚‹ã‚ˆã†è¨­è¨ˆã™ã‚‹ï¼ˆ`required: false` ã® port ã‚’æŒã¤ï¼‰ã€‚ã©ã¡ã‚‰ã‚‚è¡Œã‚ã‚Œãªã„å¾ªç’°ã¯é™çš„è¨ºæ–­ãƒ„ãƒ¼ãƒ«ãŒæ¤œå‡ºã™ã¹ãã‚¨ãƒ©ãƒ¼ã¨ã™ã‚‹ã€‚
* åæŸã¯ final ãƒãƒ¼ãƒ‰ï¼ˆgraph ã§æŒ‡å®šï¼‰ã® done ã¾ãŸã¯ limit ã«ã‚ˆã‚‹

**ç©º dict ã¨å¾ªç’°ã®æ•´åˆ**

Â§3.3 ã®ãŸã‚ï¼š

* limit / pause / fatal æ™‚ã‚‚æ—¢å­˜å‡ºåŠ›ã¯æ¶ˆãˆãªã„
* å¾ªç’°å‚ç…§ã¯å£Šã‚Œãªã„
* å‰å›å‡ºåŠ›ã¯ä¿æŒã•ã‚Œã‚‹

---

# 9. ä¾‹å¤–å‡¦ç†ãƒ¢ãƒ‡ãƒ«

## 9.1 Node ãŒå¸å

BaseNode.execute å†…ã§ä¾‹å¤–ã‚’æ•æ‰ã—ã€status ã‚’ fatal ã«ã™ã‚‹ã€‚execute ã®è¿”ã‚Šå€¤ã«ã¯ status ã‚’å«ã‚ãªã„ï¼ˆÂ§2.2, Â§2.3.3ï¼‰ã€‚

* PipelineNode ã¯ read_status() ã§ status ã‚’èª­ã¿ã€fatal ãªã‚‰åˆ¶å¾¡ã™ã‚‹
* Retry ã¯é€šå¸¸ Node ã§å®Ÿè£…ã™ã‚‹

### Node ã® fatal æƒ…å ±ã‚¢ã‚¯ã‚»ã‚¹

BaseNode ã¯ fatal ç™ºç”Ÿæ™‚ã€ãã®åŸå› ä¾‹å¤–ã‚’ **state** ã¨ã—ã¦ä¿æŒã—ãªã‘ã‚Œã°ãªã‚‰ãªã„ï¼ˆMUSTï¼‰ã€‚state ã®å®šç¾©ãŠã‚ˆã³ã€Œè¨ºæ–­ç›®çš„ã®å®Ÿè¡Œçµæœæƒ…å ±ã€ã®æ‰±ã„ã¯ Â§3.9.1 ã«å¾“ã†ã€‚

```python
def read_error(self) -> Exception | None:
    """
    status == fatal ã®ã¨ãã€åŸå› ä¾‹å¤–ã‚’è¿”ã™ã€‚
    fatal ã§ãªã„å ´åˆã¯ None ã‚’è¿”ã™ã€‚
    """
```

**ä»•æ§˜**

* status ãŒ fatal ã®ã¨ãã®ã¿ä¾‹å¤–ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’è¿”ã™
* fatal ã§ãªã„å ´åˆã¯ None ã‚’è¿”ã™
* read_error() ã¯ read-only ã§ã‚ã‚‹ï¼ˆNode å¤–éƒ¨ã‹ã‚‰ã®å¤‰æ›´ã¯ç¦æ­¢ï¼‰
* StructuralNode ã¯å­ Node ã® read_error() ã‚’é›†ç´„ã—ã¦ä¸Šä½ã«ä¼é”ã—ã¦ã‚ˆã„
* Runner ã¯ read_error() ã‚’å‚ç…§ã—ãªã„ï¼ˆRunner is dumb ã‚’ç¶­æŒï¼‰

**PauseSignal / LimitSignal**  
PauseSignalãƒ»LimitSignal ã¯ fatal ã§ã¯ãªã„ãŸã‚ read_error() ã¯ None ã‚’è¿”ã™ã€‚

**StructuralNode ã® read_error()**  
StructuralNode ã¯é…ä¸‹ã®**å…¨å­å­«** Node ã® fatal åŸå› ã‚’é›†ç´„ã—ã€`read_error()` ã§**ã™ã¹ã¦**ã®ä¾‹å¤–ã‚’è¿”ã•ãªã‘ã‚Œã°ãªã‚‰ãªã„ï¼ˆMUSTï¼‰ã€‚è¿”å´å½¢å¼ã¯é…ä¸‹ã®å…¨å­å­«ã® fatal ä¾‹å¤–ã®ãƒªã‚¹ãƒˆï¼ˆ`list[Exception]`ï¼‰ã¨ã™ã‚‹ã€‚è‡ªèº«ãŒ fatal ã®å ´åˆã¯è‡ªèº«ã®åŸå› ã‚‚å«ã‚ã‚‹ã€‚

---

# 10. ã‚¹ã‚³ãƒ¼ãƒ—ãƒ«ãƒ¼ãƒ«

## 10.1 Node ãŒå‚ç…§ã§ãã‚‹ã‚‚ã®ï¼ˆå®Ÿè£…ã®è¦–ç‚¹ï¼‰

Node ã®å®Ÿè£…ãŒå‚ç…§ã§ãã‚‹ã®ã¯ **å¸¸ã«æ¬¡ã®ã¿** ã§ã‚ã‚‹ï¼š

* è‡ªèº«ã® `inputs`
* è‡ªèº«ã® `params`

Node ã¯ Graph ã‚„ä»–ãƒãƒ¼ãƒ‰ã®å­˜åœ¨ã‚’çŸ¥ã‚‰ãªã„ã€‚å¤–å´ã®ä¸–ç•Œï¼ˆåŒä¸€ Graph å†…ã®ä»–ãƒãƒ¼ãƒ‰å‡ºåŠ›ã‚„è¦ª StructuralNode ã® inputsï¼‰ã‚’ç›´æ¥å‚ç…§ã™ã‚‹ã“ã¨ã¯ãªã„ã€‚

---

## 10.2 å…¥åŠ›ãƒã‚¤ãƒ³ãƒ‡ã‚£ãƒ³ã‚°ã®ã‚½ãƒ¼ã‚¹ï¼ˆGraph å®šç¾©ã®è¦–ç‚¹ï¼‰

Graph å®šç¾©ï¼ˆnode_pipeline.yamlï¼‰ã§ã€ã‚ã‚‹ãƒãƒ¼ãƒ‰ã® `inputs` ã« **ãƒã‚¤ãƒ³ãƒ‰ã—ã¦ã‚ˆã„å€¤ã®å‡ºæ‰€** ã¯æ¬¡ã®ã„ãšã‚Œã‹ã§ã‚ã‚‹ã€‚ã“ã‚Œã‚‰ã¯ Runnerï¼ˆStructuralNode å†…éƒ¨ï¼‰ãŒ `${node_id.port}` ãªã©ã‚’è§£æ±ºã™ã‚‹ã¨ãã«å‚ç…§ã™ã‚‹ã‚½ãƒ¼ã‚¹ã§ã‚ã‚Šã€Node å®Ÿè£…ãŒç›´æ¥ã€Œè¦‹ã‚‹ã€ã‚‚ã®ã§ã¯ãªã„ã€‚

* **åŒä¸€ Graph å†…ã®ä»–ãƒãƒ¼ãƒ‰ã®å‡ºåŠ›** â€” `${node_id.port}` ã§å‚ç…§
* **è¦ª StructuralNode ã® inputs** â€” ãƒã‚¹ãƒˆã—ãŸ Graph å†…ã®ãƒãƒ¼ãƒ‰ã«å¯¾ã—ã¦ã€è¦ªãŒå—ã‘å–ã£ãŸ inputs ã‚’æ¸¡ã™å ´åˆï¼ˆä¾‹ï¼š`${inputs.port}` ãªã©ï¼‰
* **è¦ª StructuralNode ã® params** â€” `${params.<param_name>}` ã§å‚ç…§ï¼ˆÂ§4, Â§12.2.1.2ï¼‰

Runner ãŒã“ã‚Œã‚‰ã®ã‚½ãƒ¼ã‚¹ã‹ã‚‰å€¤ã‚’å–ã‚Šã€è©²å½“ãƒãƒ¼ãƒ‰ã® `inputs` ã«è©°ã‚ã¦ã‹ã‚‰ `execute(inputs, params)` ã‚’å‘¼ã¶ã€‚ã—ãŸãŒã£ã¦ Node ã‹ã‚‰è¦‹ã‚Œã°ã€å¸¸ã«ã€Œè‡ªèº«ã® inputs ã¨ params ã ã‘ã€ã§ã‚ã‚‹ã€‚

---

# 11. å®šç¾©ãƒ•ã‚¡ã‚¤ãƒ«

## 11.1 node.yaml

Node å‹å®šç¾©ã€‚

```yaml
version: "1.2"

name: string
description: string

inputs:
  <port>: <schema>

outputs:
  <port>: <schema>

params:
  <param>: <schema>
```

**Schema æœ€å°ã‚µãƒ–ã‚»ãƒƒãƒˆ**ï¼štype, description, required, properties, items, additionalProperties, default ã‚’è¨±å¯ã€‚

**å®Ÿè¡Œæ™‚æ¤œè¨¼ï¼ˆv1.2ï¼‰**ï¼šnode å­˜åœ¨ãƒã‚§ãƒƒã‚¯ã€port å­˜åœ¨ãƒã‚§ãƒƒã‚¯ã‚’å¿…é ˆã¨ã™ã‚‹ã€‚shape æ¤œè¨¼ã¯å°†æ¥æ‹¡å¼µã€‚

PipelineNode ã®å®šç¾©ãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆnode_pipeline.yamlï¼‰ã¯ Â§12.2.1.2 ã«è¨˜è¿°ã™ã‚‹ã€‚

---

## 11.3 Node Type Registry

YAML ã® `type` ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã¯ **Node Type Registry** ã‚’é€šã˜ã¦å…·ä½“ã‚¯ãƒ©ã‚¹ã«è§£æ±ºã•ã‚Œã‚‹ã€‚

**Built-in Typeï¼ˆäºˆç´„æ¸ˆã¿ï¼‰**

| type æ–‡å­—åˆ— | ãƒãƒƒãƒ”ãƒ³ã‚°å…ˆã‚¯ãƒ©ã‚¹ |
|-------------|-------------------|
| `"pipeline"` | PipelineNode |
| `"loop"` | LoopNode |

ã“ã‚Œã‚‰ã® type æ–‡å­—åˆ—ã¯ãƒ¦ãƒ¼ã‚¶ãƒ¼å®šç¾© Node ã«ä½¿ç”¨ã—ã¦ã¯ãªã‚‰ãªã„ï¼ˆMUST NOTï¼‰ã€‚ä½¿ç”¨ã—ãŸå ´åˆã®æŒ™å‹•ã¯ undefined ã§ã‚ã‚‹ã€‚

**User-defined Type**

ãƒ¦ãƒ¼ã‚¶ãƒ¼å®šç¾© Node ã¯ Registry ã«ç™»éŒ²ã™ã‚‹ã“ã¨ã§ YAML ã® type ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‹ã‚‰å‚ç…§ã§ãã‚‹ã€‚ç™»éŒ²æ–¹å¼ï¼ˆãƒ‡ã‚³ãƒ¬ãƒ¼ã‚¿ãƒ»è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ç­‰ï¼‰ã¯å®Ÿè£…å®šç¾©ã¨ã™ã‚‹ã€‚

**Version ã¨ã®é–¢ä¿‚**  
Registry ã¯ versionï¼ˆÂ§11.4ï¼‰ã¨ç‹¬ç«‹ã—ã¦ã„ã‚‹ã€‚type è§£æ±ºã¯ version ãƒã‚§ãƒƒã‚¯ï¼ˆÂ§11.4ï¼‰ã®å¾Œã«è¡Œã†ã€‚

---

## 11.4 Version Compatibility

node.yaml ãŠã‚ˆã³ node_pipeline.yaml ã® `version` ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã¯å¿…é ˆã§ã‚ã‚‹ï¼ˆMUSTï¼‰ã€‚

**ãƒ­ãƒ¼ãƒ‰æ™‚ã®æ¤œè¨¼**

ã‚¨ãƒ³ã‚¸ãƒ³ã¯ YAML ãƒ­ãƒ¼ãƒ‰æ™‚ã« version ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’æ¤œè¨¼ã—ãªã‘ã‚Œã°ãªã‚‰ãªã„ï¼ˆMUSTï¼‰ã€‚

```
if yaml.version != engine.supported_version:
    raise VersionMismatchError(
        f"Unsupported version: {yaml.version}. "
        f"Engine supports: {engine.supported_version}"
    )
```

* version ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãŒå­˜åœ¨ã—ãªã„å ´åˆã¯ **VersionMismatchError** ã¨ã™ã‚‹
* ãƒã‚¤ãƒŠãƒ¼ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã®å¾Œæ–¹äº’æ›æ€§ãƒãƒªã‚·ãƒ¼ï¼ˆä¾‹ï¼š1.2 ã‚¨ãƒ³ã‚¸ãƒ³ãŒ 1.1 ã‚’èª­ã‚ã‚‹ã‹ï¼‰ã¯ã‚¨ãƒ³ã‚¸ãƒ³å®Ÿè£…è€…ãŒå®šç¾©ã™ã‚‹ã€‚ãŸã ã—ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯ **å³æ ¼ä¸€è‡´ï¼ˆexact matchï¼‰** ã¨ã™ã‚‹
* version ã®æ¯”è¼ƒã¯æ–‡å­—åˆ—å®Œå…¨ä¸€è‡´ã¨ã™ã‚‹ï¼ˆ`"1.2"` ã¨ `"1.20"` ã¯åˆ¥ç‰©ï¼‰

---

# 12. å„ç¨® Node

# Part III â€” Concrete Nodes

Node ãã®ã‚‚ã®ã¨ã¾ã‚ã‚Šã®ä»•çµ„ã¿ã‚’è¿°ã¹ãŸã‚ã¨ã§ã€å…·è±¡ã® Node ç¨®åˆ¥ã‚’å®šç¾©ã™ã‚‹ã€‚12.1 ã§ã¯å„ç¨® Leaf Nodeï¼ˆDataNodeï¼‰ã€12.2 ã§ã¯å„ç¨® StructuralNode ã«åˆ†ã‘ã¦è¨˜è¿°ã™ã‚‹ã€‚

**è¨˜è¿°æ§‹é€ ã®çµ±ä¸€**ï¼šå„ Node ã¯ä»¥ä¸‹ã®ç« ç«‹ã¦ã«æƒãˆã‚‹ã€‚DataNode ã¨ StructuralNode ã§ç•ªå·ã®æ„å‘³ã¯åŒä¸€ã¨ã™ã‚‹ã€‚

| ç¯€ | å†…å®¹ |
|----|------|
| 12.x.x.1 | å½¹å‰² |
| 12.x.x.2 | node.yaml ã¾ãŸã¯ node_pipeline.yaml |
| 12.x.x.3 | run() ã®è²¬å‹™ ã¾ãŸã¯ å®Ÿè¡Œãƒ¢ãƒ‡ãƒ«ãƒ»çµ‚äº†åˆ¤å®š |
| 12.x.x.4 | status ã®æ‰±ã„ |
| 12.x.x.5 | limit ã®ä¾‹ |
| 12.x.x.6 ä»¥é™ | ç‰¹è¨˜äº‹é …ï¼ˆpause å†é–‹ã€conditionã€final_graph ãªã©ï¼‰ |

---

## 12.1 å„ç¨® Leaf Nodeï¼ˆDataNodeï¼‰

DataNode ã¯ run() ã‚’å®Ÿè£…ã™ã‚‹å˜ä½“ Nodeã€‚revision ã¯ BaseNode ãŒ content-hash ã§ä»˜ä¸ã™ã‚‹ï¼ˆÂ§5.7ï¼‰ã€‚usage æ›´æ–°ãƒ»status è¨­å®šã¯ Â§6.6 ã®è²¬å‹™ã«å¾“ã†ã€‚ä»¥ä¸‹ã¯ä»£è¡¨çš„ãªå…·è±¡ã®æ¦‚è¦ã§ã‚ã‚‹ã€‚è©³ç´°ã¯å„ Node ã®ä»•æ§˜ã«å§”ã­ã‚‹ã€‚

### 12.1.1 LLMNode

#### 12.1.1.1 å½¹å‰²

LLM ã‚’å‘¼ã³å‡ºã™ Nodeã€‚å…¥å‡ºåŠ›ã¯ port ã§å®šç¾©ã™ã‚‹ã€‚pauseï¼ˆhuman-in-the-loopï¼‰ã®å‚è€ƒå®Ÿè£…ã¯ Â§12.2.1.5 ã«è¨˜è¼‰ã™ã‚‹ã€‚

#### 12.1.1.2 node.yaml

```yaml
version: "1.2"
name: llm_chat
description: LLM ãƒãƒ£ãƒƒãƒˆ Node

inputs:
  prompt: { type: string, description: ãƒ¦ãƒ¼ã‚¶ãƒ¼å…¥åŠ› }

outputs:
  response: { type: string, description: LLM å¿œç­” }

params:
  model: { type: string, default: "gpt-4" }
  temperature: { type: number, default: 0.7 }
  limit:
    max_tokens: 1000
```

å½¢å¼ã¯ Â§11.1 å‚ç…§ã€‚

#### 12.1.1.3 run() ã®è²¬å‹™

run() ã¯ LLM API å‘¼ã³å‡ºã—ã€usage æ›´æ–°ï¼ˆprompt_tokens / completion_tokensï¼‰ã€å¿œç­”ã® output port æ ¼ç´ã€å¿…è¦ã«å¿œã˜ã¦ PauseSignal ã® raise ã‚’è¡Œã†ã€‚BaseNode ãŒ revision è‡ªå‹•è£œå®Œãƒ»limit pre/postãƒ»status è¨­å®šã‚’è¡Œã†ï¼ˆÂ§6.3ï¼‰ã€‚

```python
def run(self, inputs, params):
    response = llm.chat(
        model=params["model"],
        prompt=inputs["prompt"],
        temperature=params["temperature"]
    )
    self.usage.add("prompt_tokens", response.prompt_tokens)
    self.usage.add("completion_tokens", response.completion_tokens)
    return {"response": response.text}
```

#### 12.1.1.4 status ã®æ‰±ã„

| çŠ¶æ…‹   | æ„å‘³               |
|--------|--------------------|
| done   | æ­£å¸¸çµ‚äº†           |
| pause  | human review å¾…æ©Ÿ  |
| limit  | ãƒˆãƒ¼ã‚¯ãƒ³åˆ¶é™è¶…é   |
| fatal  | API ä¾‹å¤–ç­‰         |

#### 12.1.1.5 limit ã®ä¾‹

```yaml
params:
  limit:
    max_tokens: 2000
    max_calls: 5
```

#### 12.1.1.6 ç‰¹è¨˜äº‹é …

* LLM ã‚»ãƒƒã‚·ãƒ§ãƒ³å±¥æ­´ã¯ Node å†…éƒ¨ state ã«ä¿æŒã™ã‚‹ã€‚pause/resume ã®å‚è€ƒå®Ÿè£…ã¯ Â§12.2.1.5 å‚ç…§ã€‚
* revision ã¯ response port ã« BaseNode ãŒè‡ªå‹•ä»˜ä¸ã€‚resume ã¯ Â§6.7 ã«å¾“ã†ã€‚

---

### 12.1.2 GitScriptNode

#### 12.1.2.1 å½¹å‰²

Git æ“ä½œã‚’ã‚¹ã‚¯ãƒªãƒ—ãƒˆã§è¡Œã† Nodeã€‚clone / fetch / commit ç­‰ã‚’ run() å†…ã§å®Ÿè¡Œã™ã‚‹ã€‚

#### 12.1.2.2 node.yaml

```yaml
version: "1.2"
name: git_script
description: Git æ“ä½œã‚¹ã‚¯ãƒªãƒ—ãƒˆ Node

inputs:
  repo_path: { type: string, description: ãƒªãƒã‚¸ãƒˆãƒªãƒ‘ã‚¹ }
  action: { type: string, description: "clone" | "fetch" | "commit" | "push" }

outputs:
  result: { type: string, description: å®Ÿè¡Œçµæœï¼ˆstdout ç­‰ï¼‰ }

params:
  limit:
    max_calls: 10
```

å½¢å¼ã¯ Â§11.1 å‚ç…§ã€‚

#### 12.1.2.3 run() ã®è²¬å‹™

clone / fetch / commit / push ç­‰ã‚’ run() å†…ã§å®Ÿè¡Œã™ã‚‹ã€‚BaseNode ãŒ revision è‡ªå‹•è£œå®Œãƒ»limitãƒ»status ã‚’æ‰±ã†ï¼ˆÂ§6.3ï¼‰ã€‚

```python
def run(self, inputs, params):
    repo, action = inputs["repo_path"], inputs["action"]
    if action == "clone":
        result = subprocess.run(["git", "clone", repo], capture_output=True, text=True)
    elif action == "fetch":
        result = subprocess.run(["git", "fetch"], capture_output=True, text=True, cwd=repo)
    # ...
    return {"result": result.stdout}
```

#### 12.1.2.4 status ã®æ‰±ã„

ä¾‹å¤–æ™‚ã¯ fatalã€‚limit è¶…éæ™‚ã¯ status = limitï¼ˆÂ§6.3ï¼‰ã€‚

#### 12.1.2.5 limit ã®ä¾‹

```yaml
params:
  limit:
    max_calls: 10
```

#### 12.1.2.6 ç‰¹è¨˜äº‹é …

* å¤–éƒ¨ I/O ã‚’å«ã‚€ãŸã‚ã€timeout ã®å®Ÿè£…ã¯ MUST ã§ã‚ã‚‹ï¼ˆÂ§6.1ï¼‰ã€‚timeout_sec ã¯ params.limit ã§æŒ‡å®šã™ã‚‹ï¼ˆÂ§12.1.2.5 å‚ç…§ï¼‰ã€‚
* revision ã¯ BaseNode ãŒä»˜ä¸ã€‚

---

### 12.1.3 PythonScriptNode

#### 12.1.3.1 å½¹å‰²

ä»»æ„ã® Python ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’å®Ÿè¡Œã™ã‚‹ Nodeã€‚inputs / params ã‚’æ¸¡ã—ã€outputs ã‚’è¿”ã™ã€‚DataNode ã®è²¬å‹™ï¼ˆrevisionãƒ»usageãƒ»statusï¼‰ã‚’æº€ãŸã™ã€‚

#### 12.1.3.2 node.yaml

```yaml
version: "1.2"
name: python_script
description: Python ã‚¹ã‚¯ãƒªãƒ—ãƒˆå®Ÿè¡Œ Node

inputs:
  data: { type: object, description: ã‚¹ã‚¯ãƒªãƒ—ãƒˆã«æ¸¡ã™å…¥åŠ› }

outputs:
  result: { type: object, description: ã‚¹ã‚¯ãƒªãƒ—ãƒˆã®æˆ»ã‚Šå€¤ }

params:
  script_path: { type: string, description: å®Ÿè¡Œã™ã‚‹ .py ã®ãƒ‘ã‚¹ }
  limit:
    timeout_sec: 60
```

å½¢å¼ã¯ Â§11.1 å‚ç…§ã€‚

#### 12.1.3.3 run() ã®è²¬å‹™

æŒ‡å®š script_path ã® Python ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’å®Ÿè¡Œã—ã€inputs ã‚’æ¸¡ã—ã¦ result ã‚’è¿”ã™ã€‚DataNode ã®è²¬å‹™ï¼ˆrevisionãƒ»usageãƒ»statusï¼‰ã¯ Â§6.6 ã«å¾“ã†ã€‚

```python
def run(self, inputs, params):
    result = execute_script(params["script_path"], inputs["data"])
    return {"result": result}
```

#### 12.1.3.4 status ã®æ‰±ã„

ä¾‹å¤–æ™‚ã¯ fatalã€‚timeout ç­‰ã¯ limit ã§åˆ¶å¾¡ã™ã‚‹å ´åˆ status = limitã€‚

#### 12.1.3.5 limit ã®ä¾‹

```yaml
params:
  limit:
    timeout_sec: 60
```

#### 12.1.3.6 ç‰¹è¨˜äº‹é …

* å¤–éƒ¨ I/O ã‚’å«ã‚€ãŸã‚ã€timeout ã®å®Ÿè£…ã¯ MUST ã§ã‚ã‚‹ï¼ˆÂ§6.1ï¼‰ã€‚timeout_sec ã¯ params.limit ã§æŒ‡å®šã™ã‚‹ï¼ˆÂ§12.1.3.5 å‚ç…§ï¼‰ã€‚
* revision ã¯ BaseNode ãŒä»˜ä¸ã€‚

---

## 12.2 å„ç¨® StructuralNode

StructuralNode ã¯ Core Model ã«ãŠã‘ã‚‹ Graph ã®æ„å‘³è«– âŸ¦GâŸ§ ã‚’ Execution Layer ã§å…·ä½“å®Ÿè£…ã™ã‚‹ãŸã‚ã® Node ã§ã‚ã‚‹ã€‚Graph ã¯æŠ½è±¡æ§‹é€ ã§ã‚ã‚Šã€Execution Layer ã§ã¯ StructuralNode ãŒãã®å…·ä½“å®Ÿç¾ã‚’æ‹…ã†ã€‚

### 12.2.1 PipelineNode

#### 12.2.1.1 å½¹å‰²

PipelineNode ã¯ **Graph ã‚’ 1-shot å®Ÿè¡Œã™ã‚‹ StructuralNode** ã§ã‚ã‚‹ã€‚å†…éƒ¨ã« graph ã‚’æŒã¡ã€StructuralNode ã‚’ç¶™æ‰¿ã™ã‚‹ï¼ˆÂ§1.3, Â§6ï¼‰ã€‚**Runner ã¨åˆ¶å¾¡å±¤ã‚’å…¼ã­ã‚‹**ï¼šRunner ã‚’ä¿æœ‰ã—ã€status é›†ç´„ãƒ»çµ‚äº†åˆ¤å®šãƒ»limit è§£é‡ˆãƒ»resume ç®¡ç†ã‚’è¡Œã†ã€‚èª­ã¿æ‰‹ã¯ PipelineNode ã‚’ã€ŒRunner + åˆ¶å¾¡å±¤ã€ã¨ã—ã¦æŠŠæ¡ã™ã‚‹ã¨ã‚ˆã„ã€‚

PipelineNode ã¯ Runner ã‚’å†…éƒ¨ã«ä¿æŒã™ã‚‹ãŒã€**Runner ã¯æŠ½è±¡ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ã‚’é€šã˜ã¦åˆ©ç”¨ã•ã‚Œã‚‹**ã€‚

**Runner Interface Contract**ï¼šPipelineNode ãŒä¾å­˜ã™ã‚‹ã®ã¯æ¬¡ã®æŠ½è±¡ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ã®ã¿ã§ã‚ã‚‹ã€‚

* `resolve_inputs(node_id) -> dict`
* `is_executable(node_id) -> bool`
* `execute_node(node_id) -> dict`
* `save_output(node_id, output)`
* `get_latest_output(node_id) -> dict | None`

Runner ã®å®Ÿè£…ã¯ã“ã®ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ã‚’æº€ãŸã•ãªã‘ã‚Œã°ãªã‚‰ãªã„ã€‚å†…éƒ¨ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒªãƒ³ã‚°ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ã¯ Execution Layer ã§ã¯è¦å®šã—ãªã„ã€‚å®Ÿè£…ã¯å·®ã—æ›¿ãˆå¯èƒ½ã§ã‚ã‚‹ï¼ˆåˆ†æ•£ Runnerãƒ»Streaming Runnerãƒ»å¤–éƒ¨ Executor ç­‰ã‚’æƒ³å®šï¼‰ã€‚

#### 12.2.1.2 node_pipeline.yaml

PipelineNode ã®å†…éƒ¨æ§‹é€ ã¯ **node_pipeline.yaml** ã«ã‚ˆã‚Šå®šç¾©ã•ã‚Œã‚‹ã€‚`graph` ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã® `graph.nodes` ã‚’è¨˜è¿°é †ã«èµ°æŸ»ã™ã‚‹ï¼ˆÂ§7.1.1ï¼‰ã€‚**final ãƒãƒ¼ãƒ‰**ã‚’ graph å†…ã«å¿…ãš 1 ã¤æŒ‡å®šã—ãªã‘ã‚Œã°ãªã‚‰ãªã„ã€‚`graph.final` ã« node_id ã‚’è¨˜è¿°ã™ã‚‹ã€‚final ã¯ `graph.nodes` ã«å­˜åœ¨ã™ã‚‹ node_id ã§ã‚ã‚‹ã“ã¨ã€‚è¤‡æ•°æŒ‡å®šã¯ç¦æ­¢ã€‚

**å®šç¾©ãƒ•ã‚¡ã‚¤ãƒ«ã®å½¢å¼ï¼ˆnode_pipeline.yamlï¼‰**

```yaml
version: "1.2"
name: hello_pipeline
inputs: ...
outputs: ...
params:
  limit:
    max_total_node_calls: 200
graph:
  nodes:
    - id: A
      type: node_type
      inputs: ...
      params: ...
    - id: B
      type: node_type
      inputs: ...
      params: ...
  final: B
```

**Param ã®æ˜ç¤ºçš„ãƒãƒƒãƒ”ãƒ³ã‚°**ï¼šPipelineNode ã¯è‡ªèº«ã® params ã‚’å­ãƒãƒ¼ãƒ‰ã«**æ˜ç¤ºçš„ã«ãƒãƒƒãƒ”ãƒ³ã‚°**ã™ã‚‹ã€‚æš—é»™ç¶™æ‰¿ã¯ç¦æ­¢ï¼ˆÂ§4.3ï¼‰ã€‚å­ãƒãƒ¼ãƒ‰ã§è¦ªã® param ã‚’ä½¿ã†å ´åˆã¯ã€graph ã® node å®šç¾©ã§ `params` ã«è¨˜è¿°ã™ã‚‹ã€‚ä¾‹ï¼šè¦ªã® `params.threshold` ã‚’å­ã«æ¸¡ã™å ´åˆ

```yaml
graph:
  nodes:
    - id: child
      type: some_node
      params:
        threshold: ${params.threshold}
```

PipelineNode ã¯ graph å®šç¾©ã«å¾“ã„ã€å­ãƒãƒ¼ãƒ‰å®Ÿè¡Œæ™‚ã«ã“ã® param ã‚’è§£æ±ºã™ã‚‹ã€‚

**å®Ÿè¡Œä¾‹**

* **ç›´åˆ—**ï¼š`A â†’ B â†’ C`ï¼ˆC ã‚’ final ã«æŒ‡å®šï¼‰ã€‚Runner ã¯ A â†’ B â†’ C ã®é †ã«å®Ÿè¡Œå¯èƒ½ã«ãªã‚Šã€**final ãƒãƒ¼ãƒ‰ C ãŒ done** ã«ãªã£ãŸæ™‚ç‚¹ã§å½“è©² PipelineNode ã®å®Ÿè¡ŒãŒçµ‚äº†ã™ã‚‹ã€‚å‡ºåŠ›ã¯ C ã®å‡ºåŠ›ã‚’ãã®ã¾ã¾è¿”ã™ï¼ˆÂ§6.7ï¼‰ã€‚
* **ä¸¦åˆ—**ï¼š`A â†’ B` ã¨ `A â†’ C`ï¼ˆC ã‚’ final ã«æŒ‡å®šï¼‰ã€‚A ã®å¾Œ B ã¨ C ãŒåŒæ™‚ã«å®Ÿè¡Œå¯èƒ½ã«ãªã‚‹ã€‚**final ãƒãƒ¼ãƒ‰ C ãŒ done** ã«ãªã‚Šã€ã‹ã¤ C ãŒ executing ã§ãªããªã£ãŸæ™‚ç‚¹ã§çµ‚äº†ã™ã‚‹ã€‚å‡ºåŠ›ã¯ C ã®å‡ºåŠ›ã‚’ãã®ã¾ã¾è¿”ã™ï¼ˆÂ§6.7ï¼‰ã€‚

#### 12.2.1.3 çµ‚äº†æ¡ä»¶

**çµ‚äº†åˆ¤å®šã¯ Â§6.7 ã«å®Œå…¨ã«å¾“ã†ã€‚** PipelineNode ã¯ Graph ã‚’ 1-shot å®Ÿè¡Œã™ã‚‹ãŸã‚ã€**final ãƒãƒ¼ãƒ‰ãŒ done** ã«ãªã£ãŸæ™‚ç‚¹ã§å½“è©² PipelineNode ã®å®Ÿè¡ŒãŒçµ‚äº†ã™ã‚‹ã€‚å‡ºåŠ›ãƒ»revision ã¯ Â§6.7 ã«å¾“ã†ã€‚

**final ãŒ `{}` ã‚’è¿”ã™å ´åˆ**ï¼šfinal ãƒãƒ¼ãƒ‰ãŒ `{}` ã‚’è¿”ã—ãŸã¨ãã€PipelineNode ã¯ `{}` ã‚’è¿”ã™ã€‚ä»¥å‰ã®å‡ºåŠ›ã¸ã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ã¯è¡Œã‚ãªã„ï¼ˆstrictï¼‰ã€‚

#### 12.2.1.4 execute ã®æŒ™å‹•

`PipelineNode.execute(inputs, params) -> dict`ã€‚**PipelineNode.execute é–‹å§‹æ™‚ã€status ã¯ executing ã«ãªã‚‹ï¼ˆBaseNode.execute ã«ã‚ˆã‚‹ï¼‰ã€‚** å†…éƒ¨ã« Runner ã‚’æŒã¤ã€‚Runner ã¯ execute åˆå›ã«ç”Ÿæˆã—ã€åŒä¸€ PipelineNode ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã®å†å®Ÿè¡Œæ™‚ï¼ˆLoopNode ã‹ã‚‰ã®å† execute ç­‰ï¼‰ã¯åŒä¸€ Runner ã‚’å†åˆ©ç”¨ã™ã‚‹ã€‚Runner ã®å†åˆ©ç”¨ã«éš›ã—ã¦ã€latest_outputï¼ˆContextï¼‰ã¯ LoopNode ã® iteration é–“ã§å¼•ãç¶™ãŒã‚Œã‚‹ï¼ˆÂ§12.2.2.3 ã® iteration é–“ã® Node çŠ¶æ…‹å‚ç…§ï¼‰ã€‚PipelineNode ãŒç‹¬ç«‹ã—ãŸ 1-shot ã¨ã—ã¦å®Ÿè¡Œã•ã‚Œã‚‹å ´åˆï¼ˆLoopNode å¤–ï¼‰ã¯ã€Context ã¯ execute é–‹å§‹æ™‚ã«åˆæœŸåŒ–ã•ã‚Œã‚‹ã€‚å®Ÿè¡Œãƒ•ãƒ­ãƒ¼ï¼šgraph åˆæœŸåŒ– â†’ Runner ç”Ÿæˆï¼ˆã¾ãŸã¯å†åˆ©ç”¨ï¼‰â†’ Pull å‹ãƒ«ãƒ¼ãƒ— â†’ **final ãƒãƒ¼ãƒ‰ã® done åˆ¤å®šï¼ˆÂ§6.7ï¼‰** â†’ read_status() ã§ status ã‚’èª­ã¿åˆ¶å¾¡åˆ¤å®š â†’ å‡ºåŠ›è¿”å´ã€‚limit ãƒã‚§ãƒƒã‚¯ãƒ»graceful stopãƒ»æˆ»ã‚Šå€¤ã¯ã™ã¹ã¦ Â§6.7 ã«å¾“ã†ã€‚

#### 12.2.1.5 pause å†é–‹ãƒ¢ãƒ‡ãƒ«ï¼ˆç¢ºå®šï¼‰

**resume ã¯ Â§6.7 ã«å®Œå…¨ã«å¾“ã†ã€‚** APIãƒ»å‹•ä½œãƒ»æˆ»ã‚Šå€¤ãƒ»åˆ¶ç´„ã¯ã™ã¹ã¦ Â§6.7 ã®ã€Œresume ã®å…±é€šä»•æ§˜ã€ã«è¨˜è¼‰ã™ã‚‹ã€‚PipelineNode å›ºæœ‰ã®è£œè¶³ï¼šresume å¾Œã¯ termination åˆ¤å®šã‚’å†è©•ä¾¡ã™ã‚‹ï¼ˆÂ§6.7ï¼‰ã€‚

**LLMNode ã® run è¨­è¨ˆï¼ˆä»•æ§˜ä¸Šã®å‚è€ƒå®Ÿè£…ï¼‰**

LLM ã‚»ãƒƒã‚·ãƒ§ãƒ³ç¶™ç¶šå‹ pause ã®æ¨™æº–çš„ãªå®Ÿè£…ãƒ‘ã‚¿ãƒ¼ãƒ³ï¼š

```python
class LLMNode(BaseNode):
    def __init__(self):
        self._session = []            # LLM ã‚»ãƒƒã‚·ãƒ§ãƒ³å±¥æ­´ï¼ˆå†…éƒ¨çŠ¶æ…‹ï¼‰
        self._waiting_for_human = False

    def run(self, inputs: dict, params: dict) -> dict:
        if not self._waiting_for_human:
            # é€šå¸¸å®Ÿè¡Œãƒ•ã‚§ãƒ¼ã‚º
            response = llm.chat(self._session, inputs["prompt"])
            self._session.append(response)

            if needs_human_review(response):
                self._waiting_for_human = True
                raise PauseSignal(
                    reason="human review required",
                    resume_inputs_schema={"human_input": "string"}
                )
            return {"result": response}

        else:
            # resume ãƒ•ã‚§ãƒ¼ã‚ºï¼ˆåŒã˜ã‚»ãƒƒã‚·ãƒ§ãƒ³ã§ç¶šè¡Œï¼‰
            self._waiting_for_human = False
            response = llm.chat(self._session, inputs["human_input"])
            self._session.append(response)
            return {"result": response}
```

| è¦³ç‚¹ | å†…å®¹ |
|------|------|
| LLM ã‚»ãƒƒã‚·ãƒ§ãƒ³ | `self._session` ã«ä¿æŒã€‚resume å¾Œã‚‚åŒã˜å±¥æ­´ã§ç¶™ç¶š |
| resume_inputs | `human_input` ã¨ã—ã¦ run ã«æ¸¡ã‚‹ |
| çŠ¶æ…‹ç®¡ç† | `_waiting_for_human` ãƒ•ãƒ©ã‚°ã§åˆ†å²ã€‚Node å†…éƒ¨ã«å®Œçµ |
| revision | resume å¾Œã« run ãŒæˆåŠŸã™ã‚Œã° BaseNode ãŒè‡ªå‹•ä»˜ä¸ |

**å°†æ¥ã® WebUI çµ±åˆ**ï¼šã“ã®ãƒ¢ãƒ‡ãƒ«ã¯ REST API ã¨ç›¸æ€§ãŒè‰¯ã„ã€‚ä¾‹ï¼š`POST /pipeline/{id}/resume` ã« `{"resume_inputs": {"human_input": "æ‰¿èªã—ã¾ã™"}}` ã‚’é€ã‚Šã€`pipeline.resume(resume_inputs)` ã‚’ãã®ã¾ã¾ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã«ãƒãƒƒãƒ”ãƒ³ã‚°ã§ãã‚‹ã€‚PipelineNode ã¨ LoopNode ã§åŒä¸€ APIï¼ˆå†…éƒ¨æ§‹é€ ã‚’æ¼ã‚‰ã•ãªã„ï¼‰ã€‚

**ãƒã‚¹ãƒˆã—ãŸ StructuralNode ã§ã®æ³¨æ„**ï¼šGraph å†…ã« LoopNode ç­‰ã® StructuralNode ãŒå«ã¾ã‚Œã¦ãŠã‚Šã€ãã‚ŒãŒ pause ã«ãªã£ã¦ã„ã‚‹å ´åˆã€å¤–å´ PipelineNode ã® `resume()` ã¯å†…å´ StructuralNode ã® `resume()` ã‚’å‘¼ã¶ã“ã¨ã§å†é–‹ã™ã‚‹ï¼ˆÂ§6.7 ãƒã‚¹ãƒˆæ§‹é€ ã§ã® resumeï¼‰ã€‚å‘¼ã³å‡ºã—å…ƒã¯å¤–å´ PipelineNode ã® `resume()` ã®ã¿ã‚’å‘¼ã¹ã°ã‚ˆãã€å†…å´ã®æ§‹é€ ã‚’çŸ¥ã‚‹å¿…è¦ã¯ãªã„ã€‚

---

#### 12.2.1.6 status ã®æ‰±ã„

**Â§6.7 ã®ã€Œå­ã® status ã«å¯¾ã™ã‚‹æŒ™å‹•ã€ã«å¾“ã†ã€‚** å½“è©² PipelineNode ã§ã¯ã€final ãƒãƒ¼ãƒ‰ãŒ done ã«ãªã£ãŸã¨ãã«å®Ÿè¡ŒãŒçµ‚äº†ã™ã‚‹ã€‚ä¸‹è¡¨ã¯å­ãƒãƒ¼ãƒ‰ã® status ã«å¯¾ã™ã‚‹æŒ™å‹•ã®è£œè¶³ã§ã‚ã‚‹ã€‚status ã®å®šç¾©ã¯ Â§2.3 å‚ç…§ã€‚

| kind      | æŒ™å‹•ï¼ˆå­ãƒãƒ¼ãƒ‰ã® status ã«å¯¾ã™ã‚‹æ‰±ã„ï¼‰ |
| --------- | ----------------------------------------------- |
| ready     | ç¶™ç¶šï¼ˆå…¥åŠ›å¾…ã¡ãƒ»å†ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«å¯èƒ½ï¼‰             |
| executing | ç¶™ç¶šï¼ˆå®Ÿè¡Œä¸­ãƒ»å®Œäº†å¾…ã¡ï¼‰                         |
| done      | ç¶™ç¶šï¼ˆå­ãƒãƒ¼ãƒ‰ãŒ done â†’ çµ‚äº†åˆ¤å®šã¸ã€‚Â§6.7 ã§ final ãƒãƒ¼ãƒ‰ãŒ done ã¨ãªã‚Œã° PipelineNode è‡ªèº«ãŒ done ã¨ãªã‚Šå½“è©²å®Ÿè¡ŒãŒçµ‚äº†ï¼‰ |
| fatal     | å³åœæ­¢                                           |
| limit     | åœæ­¢                                             |
| pause     | åœæ­¢ï¼ˆå¤–éƒ¨åˆ¤æ–­å¾…ã¡ï¼‰                             |

Runner ã® status åˆ©ç”¨ã¯ Â§7.3 ã«å¾“ã†ã€‚

---

#### 12.2.1.7 å®Ÿè¡Œä¸èƒ½çŠ¶æ…‹ï¼ˆdeadlockï¼‰

**Â§6.7 ã«å¾“ã†ã€‚** Â§7.5 ã®ã¨ãŠã‚Š runtime ã§ã¯æ¤œå‡ºã›ãšã€deadlock ã‚’ fatal ã¨ã—ã¦æ‰±ã‚ãªã„ã€‚

---

#### 12.2.1.8 çŠ¶æ…‹ä¿æŒ

**Â§6.7 ã«å¾“ã†ã€‚** PipelineNode ã‚‚å†…éƒ¨çŠ¶æ…‹ã‚’æŒã£ã¦ã‚ˆã„ã€‚

ä¾‹ï¼š

* ç·å‘¼ã³å‡ºã—å›æ•°
* iteration ã‚«ã‚¦ãƒ³ã‚¿

ã“ã‚Œã‚‰ã¯ `params.limit` ã«å¾“ã£ã¦åˆ¶å¾¡ã™ã‚‹ã€‚

#### 12.2.1.9 PipelineNode ã® limit ã®ä¾‹ï¼ˆdeadlock å®Ÿè¡Œæ™‚ä¿è­·ï¼‰

**Â§6.7 ã«å¾“ã†ã€‚** PipelineNode ã® `params.limit` ã®ä¾‹ã¨ã—ã¦ã€é€²æ—ã®ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã‚’æŒ‡å®šã§ãã‚‹ã€‚

```yaml
params:
  limit:
    max_total_node_calls: 200
    max_wall_time_sec: 300    # Flow å…¨ä½“ã®ã‚¦ã‚©ãƒ¼ãƒ«ã‚¿ã‚¤ãƒ ä¸Šé™
    max_idle_sec: 30          # å®Ÿè¡Œå¯èƒ½ãƒãƒ¼ãƒ‰ãŒ 0 ã®çŠ¶æ…‹ãŒç¶šã„ãŸã¨ãã®å¾…æ©Ÿä¸Šé™ï¼ˆæ¨å¥¨ï¼‰
```

**`max_idle_sec`ï¼ˆæ¨å¥¨ï¼‰**ï¼š**å®Ÿè¡Œå¯èƒ½ãƒãƒ¼ãƒ‰ãŒ 0 ã‹ã¤ executing ãƒãƒ¼ãƒ‰ãŒå­˜åœ¨ã—ãªã„**çŠ¶æ…‹ãŒ `max_idle_sec` ç§’ç¶šã„ãŸå ´åˆã€PipelineNode ã¯ status = limit ã«ã—ã¦ graceful stop ã™ã‚‹ã€‚idle åˆ¤å®šã¯ã€Œå®Ÿè¡Œå¯èƒ½ãƒãƒ¼ãƒ‰ãŒ 0ã€ã ã‘ã§ã¯ä¸ååˆ†ã§ã€executing ä¸­ã®ãƒãƒ¼ãƒ‰ãŒæ®‹ã£ã¦ã„ãªã„ã“ã¨ã‚’æ¡ä»¶ã¨ã™ã‚‹ã€‚Â§7.5 ã®ã¨ãŠã‚Š deadlock ã¯æ§‹é€ çš„ã«ã¯æ¤œå‡ºã—ãªã„ãŒã€é€²æ—ãŒãªã„çŠ¶æ…‹ã¯æœ¬ limit ã§åœæ­¢ã§ãã‚‹ã€‚ä¿å­˜ãƒ«ãƒ¼ãƒ«ã¯ Â§3.3 å‚ç…§ã€‚`max_idle_sec` ã‚’æŒ‡å®šã—ãªã„å ´åˆã€åœæ­¢ä¿è¨¼ã¯ãªã„ã€‚é‹ç”¨è€…ã®è²¬ä»»ã«ãŠã„ã¦ limit ã‚’è¨­å®šã™ã‚‹ã“ã¨ã€‚

**æ™‚è¨ˆã®åŸºæº–**ï¼šmax_idle_sec ã®çµŒéæ™‚é–“ã¯ **monotonic clockï¼ˆå˜èª¿å¢—åŠ æ™‚è¨ˆï¼‰** ã§è¨ˆæ¸¬ã—ãªã‘ã‚Œã°ãªã‚‰ãªã„ï¼ˆMUSTï¼‰ã€‚å£æ™‚è¨ˆï¼ˆwall-clockï¼‰ã¯ NTP ã‚„ã‚·ã‚¹ãƒ†ãƒ æ™‚åˆ»å¤‰æ›´ã®å½±éŸ¿ã‚’å—ã‘ã‚‹ãŸã‚ã€idle åˆ¤å®šã«ã¯ä½¿ç”¨ã—ãªã„ã€‚åˆ†æ•£å®Ÿè¡Œãƒ»éåŒæœŸå®Ÿè£…ã§ã‚‚åŒä¸€ã®æ„å‘³è«–ã‚’ä¿ã¤ãŸã‚ã€å®Ÿè£…ã¯ monotonic åŸºæº–ã§ idle ç¶™ç¶šæ™‚é–“ã‚’è¨ˆæ¸¬ã™ã‚‹ã“ã¨ã€‚

**å½¢å¼å®šç¾©**ï¼š

```text
ExecutableNodes(t) := { n âˆˆ Nodes | status(n) âˆˆ {ready, done} âˆ§ RequiredInputsResolved(n, t) }
ExecutingNodes(t) := { n âˆˆ Nodes | status(n) == executing }
Idle(t) := |ExecutableNodes(t)| = 0 âˆ§ |ExecutingNodes(t)| = 0
If Idle(t) holds continuously for max_idle_sec, then status = limit.
```

RequiredInputsResolved(n, t) ã¯ Â§7.1 ã®ã€Œrequired:true ã® input port ãŒã™ã¹ã¦è§£æ±ºã§ããŸã€ã«å¯¾å¿œã™ã‚‹ã€‚status ã¯ Â§2.3 ã® Node çŠ¶æ…‹ã‚’å‚ç…§ã™ã‚‹ã€‚å®Ÿè£…æ™‚ã«ç‹¬è‡ªè§£é‡ˆã—ãªã„ã“ã¨ã€‚

---

### 12.2.2 LoopNode

#### 12.2.2.1 å½¹å‰²

`type: loop`ã€‚**StructuralNode ã®ä¸€ç¨®**ï¼ˆÂ§1.3ï¼‰ã€‚**Graph ã‚’æ¡ä»¶ä»˜ãã§åå¾©å®Ÿè¡Œã™ã‚‹ StructuralNode** ã§ã‚ã‚‹ã€‚å†…éƒ¨ã« Runner ã‚’æŒã¡ã€å¤–éƒ¨ã‹ã‚‰ã¯ 1-shot Node ã¨ã—ã¦æŒ¯ã‚‹èˆã†ã€‚

**Loop ã®æœ¬è³ªï¼ˆè¨­è¨ˆåŸå‰‡ï¼‰**

1. **Loop ã®çµ‚äº†åˆ¤å®šã¯ condition ã®ã¿ã§æ±ºå®šã•ã‚Œã‚‹**
2. **LoopNode ã¯ revision ã‚’å‚ç…§ã—ãªã„**
3. **revision ã¯ I/O å¥‘ç´„ï¼ˆå†å®Ÿè¡Œæœ€é©åŒ–ã®è£œåŠ©æƒ…å ±ï¼‰ã§ã‚ã‚Šã€Loop åˆ¶å¾¡ã¨ã¯ç„¡é–¢ä¿‚ã§ã‚ã‚‹**
4. **LoopNode ã¯å­ Node ã®å†…éƒ¨çŠ¶æ…‹ï¼ˆno-op åˆ¤å®šå«ã‚€ï¼‰ã‚’è§£é‡ˆã—ãªã„**

**LoopNode ä»•æ§˜ã®è¦ç´„**ï¼šæ¡ä»¶ã¯ declarativeï¼ˆÂ§12.2.2.5ï¼‰ã€‚çµ‚äº†ã¯ condition ã®ã¿ã€‚å‡ºåŠ›ãƒ»revision ã¯ Â§6.7 ã«å¾“ã†ã€‚Loop ã® condition ã§ã¯ revision ã‚’å‚ç…§ã—ãªã„ã€‚iteration ã”ã¨ã« Node ã‚’å†ç”Ÿæˆã—ãªã„ï¼ˆåŒä¸€ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’å†åˆ©ç”¨ã€‚Â§12.2.2.3ï¼‰ã€‚

#### 12.2.2.2 node_pipeline.yaml

graph è¨˜è¿°ã¯ PipelineNode ã¨åŒã˜ã€‚node_pipeline.yaml ã®å½¢å¼ãƒ»graph ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã¯ Â§12.2.1.2 å‚ç…§ã€‚**final ãƒãƒ¼ãƒ‰ã‚’å¿…ãš 1 ã¤æŒ‡å®šã™ã‚‹**ï¼ˆ`graph.final`ï¼‰ã€‚`type: loop` ã§ LoopNode ã¨ã—ã¦è§£é‡ˆã™ã‚‹ã€‚

#### 12.2.2.3 å®Ÿè¡Œãƒ¢ãƒ‡ãƒ«

`while True:` ã§ subgraph ã‚’ 1-shot å®Ÿè¡Œã—ã€**final ãƒãƒ¼ãƒ‰**ãŒ done ã«ãªã£ãŸã‚‰ condition ã‚’åˆ¤å®šã€‚true ãªã‚‰ breakã€false ãªã‚‰æ¬¡ iterationã€‚limit åˆ°é”æ™‚ã¯ status ãŒ limit ã«ãªã‚‹ã€‚

**LoopNode ã® subgraph å†…ã§ã® PauseSignal**ï¼š**LoopNode ã¯ subgraph ã® pause ã‚’ãã®ã¾ã¾ä¼æ’­ã™ã‚‹ã€‚** subgraph å†…ã§ PauseSignal ãŒç™ºç”Ÿã—ãŸå ´åˆã€LoopNode è‡ªèº«ã® status ã¯ pause ã¨ãªã‚‹ã€‚resume ã¯ Â§6.7 ã«å¾“ã†ï¼ˆpause ãƒãƒ¼ãƒ‰ã‚’ã™ã¹ã¦åŒæ™‚ã«å†é–‹ã€‚PipelineNode ã¨åŒä¸€ APIã€‚Â§10 ã‚¹ã‚³ãƒ¼ãƒ—ãƒ«ãƒ¼ãƒ«ï¼‰ã€‚

**iteration é–“ã® Node çŠ¶æ…‹**

LoopNode ã¯å„ iteration ã§**åŒã˜ Node ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’å†åˆ©ç”¨ã™ã‚‹**ï¼ˆæ–°è¦ç”Ÿæˆã—ãªã„ï¼‰ã€‚Node ã® status ã¯ done â†’ executing â†’ done ã¨é·ç§»ã™ã‚‹ã ã‘ã§ã€reset ã¯ä¸è¦ï¼ˆÂ§2.3.2 ã¨åŒã˜ï¼‰ã€‚

| é …ç›® | iteration é–“ã®æ‰±ã„ |
|------|---------------------|
| status | done ã®ã¾ã¾æ¬¡ iteration ã§ execute ã•ã‚Œã‚‹ï¼ˆreset ä¸è¦ï¼‰|
| å†…éƒ¨çŠ¶æ…‹ï¼ˆrevision ã‚«ã‚¦ãƒ³ã‚¿ãªã©ï¼‰| Node ãŒå¼•ãç¶™ãï¼ˆãƒªã‚»ãƒƒãƒˆã—ãªã„ï¼‰|
| latest_output | Contextï¼ˆStructuralNode ãŒç®¡ç†ï¼‰ã«ä¿æŒã—ãŸã¾ã¾å¼•ãç¶™ãï¼ˆÂ§3.9.3ï¼‰|

**Node ã®å†…éƒ¨ state ã¨ latest_output ã®æ•´åˆæ€§ã¯ Node å®Ÿè£…è€…ã®è²¬å‹™ã§ã‚ã‚‹ã€‚Execution Layer ã¯æ•´åˆã‚’ä¿è¨¼ã—ãªã„ã€‚**

**LoopNode ã¯ Node ã®å†…éƒ¨çŠ¶æ…‹ã‚„ no-op åˆ¤å®šã‚’è§£é‡ˆã—ãªã„ã€‚** Node ãŒ no-op ã‚’å®Ÿè£…ã—ã¦ã„ã¦ã‚‚ã€LoopNode ã® iteration ã¯é€²ã‚€ã€‚Loop ã®çµ‚äº†ã¯ **condition** ã«ä¾å­˜ã™ã‚‹ã€‚æ„å›³çš„ãªãƒªã‚»ãƒƒãƒˆãŒå¿…è¦ãªå ´åˆã¯ Node å®Ÿè£…å´ã§ run ã®å†’é ­ã«æ›¸ãã€‚LoopNode ã¯ãƒªã‚»ãƒƒãƒˆã‚’å¼·åˆ¶ã—ãªã„ï¼ˆÂ§12.2.2.10 limit ã®ä¾‹ï¼‰ã€‚

**Node å®Ÿè£…è€…ã®ãŸã‚ã® iteration å¢ƒç•Œã‚¬ã‚¤ãƒ‰ãƒ©ã‚¤ãƒ³**

iteration ã‚’ã¾ãŸã„ã§å†…éƒ¨ state ã‚’å¼•ãç¶™ã Node ã¯ã€run ã®å†’é ­ã§ã€Œå‰å›ã® latest_output ã¨è‡ªèº«ã®å†…éƒ¨ state ãŒæ•´åˆã—ã¦ã„ã‚‹ã‹ã€ã‚’è‡ªå·±æ¤œè¨¼ã™ã‚‹ã“ã¨ã‚’æ¨å¥¨ã™ã‚‹ã€‚

å…¸å‹çš„ãªå®Ÿè£…ãƒ‘ã‚¿ãƒ¼ãƒ³ã¯ä»¥ä¸‹ã® 3 ã¤ã§ã‚ã‚‹ã€‚

**ãƒ‘ã‚¿ãƒ¼ãƒ³ Aï¼šå®Œå…¨ã‚¹ãƒ†ãƒ¼ãƒˆãƒ¬ã‚¹ï¼ˆæœ€ã‚‚ã‚·ãƒ³ãƒ—ãƒ«ï¼‰**

```python
def run(self, inputs, params):
    # å†…éƒ¨ state ã‚’æŒãŸãªã„ã€‚æ¯å› inputs ã®ã¿ã§å‹•ä½œã™ã‚‹ã€‚
    # iteration é–“ã®æ•´åˆå•é¡Œã¯ç™ºç”Ÿã—ãªã„ã€‚
    result = process(inputs["data"])
    return {"result": result}
```

**ãƒ‘ã‚¿ãƒ¼ãƒ³ Bï¼šå‰å› revision ã‚’ç›£è¦–ã—ã¦ no-op åˆ¤å®š**

å‰å›ã® run æˆ»ã‚Šå€¤ï¼ˆ_meta ãªã—ï¼‰ã‚’ãã®ã¾ã¾ä¿æŒã™ã‚‹ã€‚revision ã¯ BaseNode ãŒæ¯å›è£œå®Œã™ã‚‹ãŸã‚ã€å®Ÿè£…è€…ã¯ _meta ã‚’ç›´æ¥æ“ä½œã—ãªã„ï¼ˆÂ§5.2ï¼‰ã€‚

```python
def run(self, inputs, params):
    current_rev = inputs["data"]["_meta"]["revision"]
    if current_rev == self._last_revision:
        # å…¥åŠ›ãŒå¤‰åŒ–ã—ã¦ã„ãªã„ â†’ å‰å›ã® run çµæœã‚’ãã®ã¾ã¾è¿”ã™ã€‚
        # BaseNode ãŒå†åº¦ revision è£œå®Œã™ã‚‹ãŒã€å†…å®¹ãŒåŒä¸€ãªã‚‰ revision å€¤ã‚‚åŒä¸€ã«ãªã‚‹ã€‚
        return self._last_output
    self._last_revision = current_rev
    result = process(inputs["data"])
    self._last_output = {"result": result}
    return self._last_output  # BaseNode ãŒ revision ã‚’ä»˜ä¸ã™ã‚‹
```

**ãƒ‘ã‚¿ãƒ¼ãƒ³ Cï¼šiteration ã‚«ã‚¦ãƒ³ã‚¿ã‚„ç´¯ç© state ã‚’æŒã¤**

```python
def run(self, inputs, params):
    # state ã‚’å¼•ãç¶™ããŒã€latest_output ã¨ã®æ•´åˆã¯è‡ªå·±ç®¡ç†ã™ã‚‹ã€‚
    # LoopNode ã¯ã“ã® state ã‚’æ„ŸçŸ¥ã—ãªã„ã€‚
    self._history.append(inputs["data"])
    result = aggregate(self._history)
    return {"result": result}
```

ã„ãšã‚Œã®ãƒ‘ã‚¿ãƒ¼ãƒ³ã§ã‚‚ã€**LoopNode ã¯ Node ã®å†…éƒ¨ state ã‚’æ„ŸçŸ¥ã—ãªã„**ã€‚iteration ã®ç¶™ç¶šãƒ»çµ‚äº†ã¯ condition ã®ã¿ã§æ±ºã¾ã‚‹ã€‚Node ãŒ no-op ã‚’è¿”ã—ã¦ã‚‚ iteration ã¯é€²ã‚€ï¼ˆÂ§12.2.2.3ï¼‰ã€‚

#### 12.2.2.4 execute ã®æŒ™å‹•

**Â§6.7 ã«å¾“ã†ã€‚** åå¾©ã¯ .3 ã®ã¨ãŠã‚Š while + condition åˆ¤å®šã€‚limit ãƒã‚§ãƒƒã‚¯ã®ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã¯ Â§6.7ã€‚

#### 12.2.2.5 conditionï¼ˆæ¨™æº–ï¼‰

**condition ã®è©•ä¾¡å¯¾è±¡ã¯ final ãƒãƒ¼ãƒ‰ã®ã€Œä¿å­˜ã•ã‚ŒãŸæœ€æ–°å‡ºåŠ›ã€ã¨ã™ã‚‹ã€‚** condition ã¯ **å¿…ãš Runnerï¼ˆStructuralNodeï¼‰ãŒä¿æŒã—ã¦ã„ã‚‹ latest_outputï¼ˆContext ä¸Šã®ä¿å­˜æ¸ˆã¿å‡ºåŠ›ï¼‰** ã‚’å‚ç…§ã—ã¦è©•ä¾¡ã™ã‚‹ã€‚**final_node.execute() ã®æˆ»ã‚Šå€¤ã§è©•ä¾¡ã—ã¦ã¯ãªã‚‰ãªã„ã€‚** å‡ºåŠ›ãŒæ›´æ–°ã•ã‚Œãªã„ iteration ãŒå­˜åœ¨ã—å¾—ã‚‹ã“ã¨ã«æ³¨æ„ã™ã‚‹ã€‚

**condition è©•ä¾¡ã®å‰æï¼ˆå½¢å¼ä»•æ§˜ï¼‰**ï¼šcondition ã®è©•ä¾¡ã¯ **final_node.status == done ã®ã¨ãã®ã¿** è¡Œã†ã€‚`final_node.status != done` ã®ã¨ãï¼ˆä¾‹ï¼šlimit post ã§ `{}` ã‚’è¿”ã—ãŸç›´å¾Œã€subgraph æœªå®Œäº†ã€pause / fatal / limit ä¼æ’­æ™‚ï¼‰ã¯ condition ã‚’è©•ä¾¡ã›ãšã€LoopNode ã¯åœæ­¢çŠ¶æ…‹ã‚’ä¼æ’­ã™ã‚‹ã€‚ã“ã‚Œã«ã‚ˆã‚Šã€final ãƒãƒ¼ãƒ‰ãŒ `{}` ã‚’è¿”ã—ãŸå ´åˆã« path è§£æ±ºä¸èƒ½ã§èª¤ã£ã¦ fatal ã«é™¥ã‚‹ã“ã¨ã‚’é˜²ãã€‚**åŒä¸€ iteration ã§ limit ãƒã‚§ãƒƒã‚¯ã¨ condition ã®ä¸¡æ–¹ã«è©²å½“ã™ã‚‹å ´åˆã¯ã€limit ã‚’å„ªå…ˆã—ã€status = limit ã§çµ‚äº†ã™ã‚‹**ï¼ˆÂ§6.7 ã®å„ªå…ˆé †ä½ï¼‰ã€‚

**Loop condition è©•ä¾¡ã®å®šç¾©åŸŸ**ï¼šåå¾© n ã®çµ‚äº†æ™‚ç‚¹ã«ãŠã‘ã‚‹ final_node ã®ä¿å­˜æ¸ˆã¿æœ€æ–°å‡ºåŠ›ã‚’ O_n ã¨ã™ã‚‹ã€‚condition ã¯ O_n ä¸Šã§è©•ä¾¡ã•ã‚Œã‚‹ã€‚**condition ãŒ O_n ä¸Šã§è©•ä¾¡ã•ã‚Œã‚‹ã®ã¯ã€subgraph å®Ÿè¡Œçµ‚äº†æ™‚ã« final_node.status == done ã§ã‚ã‚‹å ´åˆã«é™ã‚‹ã€‚**

```text
if final_node.status != done:
    skip condition evaluation; propagate status and exit loop
else:
    # å‚ç…§å…ƒã¯ Runner ãŒä¿æŒã™ã‚‹ latest_outputï¼ˆä¿å­˜æ¸ˆã¿ï¼‰ã€‚execute ã®æˆ»ã‚Šå€¤ã§ã¯ãªã„ã€‚
    evaluate condition on latest_output[final_node_id]
```

**ã€Œæ­£å¸¸å®Œäº†ã€ã®å®šç¾©**ï¼šcondition ã‚’è©•ä¾¡ã™ã‚‹ã€Œfinal ãƒãƒ¼ãƒ‰ãŒ done ã«ãªã£ãŸã€ã¨ã¯ã€å³å¯†ã«ã¯æ¬¡ã®ã™ã¹ã¦ã‚’æº€ãŸã™ã“ã¨ã‚’æŒ‡ã™ã€‚(1) subgraph å†…ã« pause / fatal / limit ã®ãƒãƒ¼ãƒ‰ãŒå­˜åœ¨ã—ãªã„ã€‚(2) final ãƒãƒ¼ãƒ‰ã® status ãŒ done ã§ã‚ã‚‹ã€‚(3) executing ã®ãƒãƒ¼ãƒ‰ãŒå­˜åœ¨ã—ãªã„ï¼ˆÂ§6.7 çµ‚äº†æ¡ä»¶ï¼‰ã€‚

åœæ­¢çŠ¶æ…‹ï¼ˆpause / limit / fatalï¼‰ã®å ´åˆï¼šsubgraph ã®å®Ÿè¡Œã¯å®Œäº†ã—ãªã„ã€‚**condition ã¯è©•ä¾¡ã•ã‚Œãªã„**ã€‚LoopNode ã¯ãã® status ã‚’ãã®ã¾ã¾ä¼æ’­ã™ã‚‹ï¼ˆÂ§6.7ï¼‰ã€‚

**final_node.status ã¨ LoopNode.status ã®å¯¾å¿œ**ï¼š

| final_node.status | LoopNode.status |
| ----------------- | --------------- |
| done              | condition è©•ä¾¡   |
| pause             | pause           |
| limit             | limit           |
| fatal             | fatal           |

```yaml
condition:
  path: "$.result"    # final ãƒãƒ¼ãƒ‰å‡ºåŠ›ã«å¯¾ã™ã‚‹ JSONPath
  # ä»¥ä¸‹ã®ã„ãšã‚Œã‹1ã¤ã‚’æŒ‡å®šã™ã‚‹ï¼ˆv1.2 ã§ã‚µãƒãƒ¼ãƒˆã™ã‚‹æ¼”ç®—å­ï¼‰
  equals: <value>       # ç­‰å€¤æ¯”è¼ƒ
  not_equals: <value>  # éç­‰å€¤æ¯”è¼ƒ
  less_than: <number>   # æ•°å€¤æ¯”è¼ƒï¼ˆæœªæº€ï¼‰
  greater_than: <number> # æ•°å€¤æ¯”è¼ƒï¼ˆã‚ˆã‚Šå¤§ï¼‰
  # ãã®ä»–ã®æ¼”ç®—å­ã¯å°†æ¥æ‹¡å¼µ
```

ä¾‹ï¼š`path: "$.score"` ã¨ `less_than: 0.5` ã®ã‚ˆã†ã«ã€final ãƒãƒ¼ãƒ‰ãŒ `{"score": 0.3}` ã‚’è¿”ã›ã° condition ãŒ true ã¨ãªã‚Š Loop ã‚’çµ‚äº†ã™ã‚‹ã€‚**revision ã®å€¤ã¯ã“ã®åˆ¤å®šã«ä½¿ç”¨ã—ãªã„ã€‚**

**condition è©•ä¾¡ã‚¨ãƒ©ãƒ¼æ™‚ã® fatal æ¡ä»¶ï¼ˆé–‰ã˜ãŸå®šç¾©ï¼‰**ï¼šæ¬¡ã®ã„ãšã‚Œã‹ã«è©²å½“ã™ã‚‹å ´åˆã¯ **fatal** ã¨ã™ã‚‹ã€‚å®Ÿè£…ãƒ–ãƒ¬ã‚’é˜²ããŸã‚ã€ã“ã‚Œä»¥å¤–ã®è§£é‡ˆã‚’æ‹¡å¼µã—ã¦ã¯ãªã‚‰ãªã„ã€‚

- **(a) path ãŒå­˜åœ¨ã—ãªã„**ï¼šæŒ‡å®šã—ãŸ JSONPathï¼ˆä¾‹ï¼š`$.score`ï¼‰ãŒå¯¾è±¡å‡ºåŠ›ã«å­˜åœ¨ã—ãªã„ã€‚
- **(b) å€¤ãŒ null**ï¼špath ã¯è§£æ±ºã•ã‚ŒãŸãŒã€ãã®å€¤ãŒ null ã§ã‚ã‚Šæ¼”ç®—å­ãŒ null ã‚’è¨±å®¹ã—ãªã„å ´åˆã€‚
- **(c) å€¤ã®å‹ãŒæ¼”ç®—å­ã®è¦æ±‚ã¨ä¸€è‡´ã—ãªã„**ï¼šä¾‹ â€” `less_than` / `greater_than` ã¯æ•°å€¤å‹ã‚’è¦æ±‚ã™ã‚‹ãŸã‚ã€å€¤ãŒæ–‡å­—åˆ—ï¼ˆä¾‹ï¼š`"0.5"`ï¼‰ã‚„ã€æ¼”ç®—å­å´ã® `value` ãŒæ–‡å­—åˆ—ã§æ¯”è¼ƒä¸èƒ½ãªå ´åˆã¯ fatalã€‚**å‹å¤‰æ›ã¯è¡Œã‚ãªã„ã€‚**

condition è©•ä¾¡ã«å¤±æ•—ã—ãŸå ´åˆã€LoopNode ã¯ status = fatal ã¨ã™ã‚‹ã€‚**ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¯å¿…ãšä»¥ä¸‹ã‚’å«ã‚€ã“ã¨**ï¼šJSONPathã€æ¼”ç®—å­ã€å®Ÿéš›ã®å€¤ã€å®Ÿéš›ã®å‹ã€‚ä¾‹ï¼š

```
condition error:
path=$.score
operator=less_than
value="abc"
type=string
```

**Condition evaluation is not input binding.** It is a semantic termination check and MUST be strict. Â§3.1 ã®ã€Œæœªå®šç¾©å‚ç…§ã¯ä¾‹å¤–ã‚’æŠ•ã’ãšå½“è©²ãƒãƒ¼ãƒ‰ã‚’å®Ÿè¡Œä¸èƒ½ã¨ã™ã‚‹ã€ã¯ **input ãƒã‚¤ãƒ³ãƒ‡ã‚£ãƒ³ã‚°** ã®è©±ã§ã‚ã‚Šã€condition ã«ã¯é©ç”¨ã—ãªã„ã€‚condition ã® path è§£æ±ºå¤±æ•—ãƒ»å‹ä¸ä¸€è‡´ã¯ fatal ã¨ã™ã‚‹ã€‚å®Ÿè£…è€…ãŒã€Œæœªå®šç¾©å‚ç…§ã¯ fatal ã˜ã‚ƒãªã„ã€ã¨è§£é‡ˆã—ã¦ condition ã‚¨ãƒ©ãƒ¼ã‚’ç„¡è¦–ã—ã¦ã¯ãªã‚‰ãªã„ã€‚condition ãŒè§£æ±ºã§ããªã„çŠ¶æ…‹ã¯ Loop è¨­è¨ˆä¸Šã®ãƒã‚°ã§ã‚ã‚Šã€å®Ÿè¡Œç¶™ç¶šã™ã‚‹ã“ã¨ã«æ„å‘³ãŒãªã„ãŸã‚ fatal ã¨ã™ã‚‹ã€‚subgraph ã®é€”ä¸­ãƒãƒ¼ãƒ‰ã®å‡ºåŠ›ã‚’ condition ã§å‚ç…§ã—ãŸã„å ´åˆã¯ã€final ãƒãƒ¼ãƒ‰ãŒãã®å€¤ã‚’ pass-through ã—ã¦å‡ºåŠ›ã™ã‚‹ã‚ˆã†è¨­è¨ˆã™ã‚‹ã“ã¨ã€‚

**LoopNode å®Œå…¨å…·ä½“ä¾‹ï¼ˆÂ§12.2.2.5 ã®è£œè¶³ï¼‰**

**ä¾‹ï¼šã‚¹ã‚³ã‚¢ãŒ 0.5 æœªæº€ã«ãªã‚‹ã¾ã§æ”¹å–„ã™ã‚‹**

* subgraphï¼š`improve`ï¼ˆLLM ã§æ”¹å–„æ¡ˆç”Ÿæˆï¼‰â†’ `evaluate`ï¼ˆPython ã§ã‚¹ã‚³ã‚¢ç®—å‡ºï¼‰ã€‚**evaluate ã‚’ final ãƒãƒ¼ãƒ‰ã«æŒ‡å®š**ã™ã‚‹ã€‚
* conditionï¼š`path: "$.score"`, `less_than: 0.5`ã€‚final ãƒãƒ¼ãƒ‰ï¼ˆevaluateï¼‰ã®å‡ºåŠ›ã® score ãŒ 0.5 æœªæº€ãªã‚‰ breakã€‚

**å®Ÿè¡Œãƒˆãƒ¬ãƒ¼ã‚¹**

* **Iteration 1**ï¼šimprove å®Ÿè¡Œ â†’ evaluate å®Ÿè¡Œ â†’ å‡ºåŠ›ä¾‹ `{"score": 0.72}` â†’ condition: 0.72 < 0.5 â†’ False â†’ ç¶™ç¶šã€‚
* **Iteration 2**ï¼šimprove å®Ÿè¡Œ â†’ evaluate å®Ÿè¡Œ â†’ å‡ºåŠ›ä¾‹ `{"score": 0.48}` â†’ condition: 0.48 < 0.5 â†’ True â†’ breakã€‚LoopNode ã®æœ€çµ‚å‡ºåŠ›ã¯ final ãƒãƒ¼ãƒ‰ï¼ˆevaluateï¼‰ã®å‡ºåŠ›ã‚’ãã®ã¾ã¾è¿”ã™ï¼ˆÂ§6.7ï¼‰ã€‚

**pause ã‚’å«ã‚€å ´åˆ**ï¼šã‚ã‚‹ iteration ã§ improve ãŒ PauseSignal ã‚’ raise ã—ãŸå ´åˆã€LoopNode.status = pauseã€graceful stopã€‚resume() å‘¼ã³å‡ºã—ã§åŒã˜ Node ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã§å†é–‹ã—ã€condition åˆ¤å®šã¸æˆ»ã‚‹ï¼ˆÂ§6.7ï¼‰ã€‚

**limit ã®å ´åˆ**ï¼š`max_iterations: 10` ç­‰ã‚’æŒ‡å®šã—ã¦ã„ã‚‹ã¨ãã€10 å›å®Ÿè¡Œã—ã¦ã‚‚ condition ãŒæº€ãŸã•ã‚Œãªã„å ´åˆã¯ status = limitã€`{}` ã‚’è¿”ã™ã€‚æ—¢å­˜ã®æœ€å¾Œã®æœ‰åŠ¹å‡ºåŠ›ã¯ä¿å­˜æ¸ˆã¿ï¼ˆÂ§3.3ï¼‰ã€‚æ°¸ä¹…ãƒ«ãƒ¼ãƒ—é˜²æ­¢ã®ãŸã‚ max_iterations ã®æŒ‡å®šã‚’å¼·ãæ¨å¥¨ï¼ˆÂ§12.2.2.10ï¼‰ã€‚

#### 12.2.2.6 pause å†é–‹ãƒ¢ãƒ‡ãƒ«

**Â§6.7 ã® resume å…±é€šä»•æ§˜ã«å¾“ã†ã€‚** PipelineNode ã¨åŒä¸€ APIãƒ»åŒä¸€å‹•ä½œã€‚resume å¾Œã¯é€šå¸¸ã® iteration ãƒ•ãƒ­ãƒ¼ã«æˆ»ã‚‹ã€‚

#### 12.2.2.7 status ã®æ‰±ã„

**Â§6.7 ã®ã€Œå­ã® status ã«å¯¾ã™ã‚‹æŒ™å‹•ã€ã«å¾“ã†ã€‚** å­ãƒãƒ¼ãƒ‰ã® status ã‚’é›†ç´„ã—ã€pause / limit / fatal ã®å ´åˆã¯ä¼æ’­ã—ã¦åœæ­¢ã™ã‚‹ã€‚

#### 12.2.2.8 å®Ÿè¡Œä¸èƒ½çŠ¶æ…‹ï¼ˆdeadlockï¼‰

**Â§6.7 ã«å¾“ã†ã€‚** Â§7.5 ã®ã¨ãŠã‚Š runtime ã§ã¯æ¤œå‡ºã›ãšã€deadlock ã‚’ fatal ã¨ã—ã¦æ‰±ã‚ãªã„ã€‚

#### 12.2.2.9 çŠ¶æ…‹ä¿æŒ

**Â§6.7 ã«å¾“ã†ã€‚** LoopNode ã‚‚å†…éƒ¨çŠ¶æ…‹ã‚’æŒã£ã¦ã‚ˆã„ã€‚

#### 12.2.2.10 LoopNode ã® limit ã®ä¾‹

**Â§6.7 ã«å¾“ã†ã€‚** Loop ã«æœ¬è³ªçš„ãªä¸Šé™ã¨ã—ã¦ `max_iterations` ã‚’æŒ‡å®šã™ã‚‹ï¼ˆæ°¸ä¹…ãƒ«ãƒ¼ãƒ—é˜²æ­¢ã®ãŸã‚å¼·ãæ¨å¥¨ï¼‰ã€‚PipelineNode ã® max_idle_sec ç­‰ã¨ä½µç”¨ã—ã¦ã‚ˆã„ã€‚è©³ç´°ã¯ Â§6.7ã€‚

```yaml
params:
  limit:
    max_iterations: 100
```

#### 12.2.2.11 final_graphï¼ˆLoopNode ã®ã¿ï¼‰

loop ã‚’æŠœã‘ãŸç›´å¾Œã« 1 å›ã ã‘å®Ÿè¡Œå¯èƒ½ãª graph ã‚’å®šç¾©ã§ãã‚‹ã€‚**v1.2 ã§ã¯æœªå®šç¾©ã¨ã™ã‚‹ã€‚** å°†æ¥æ‹¡å¼µã§ä»•æ§˜åŒ–ã™ã‚‹ã€‚

---

## 12.3 ãã®ä»–ï¼ˆå°†æ¥æ‹¡å¼µï¼‰

ä»Šå›ã®ä»•æ§˜ã§ã¯ 12.1 å„ç¨® Leaf Nodeï¼ˆLLMNodeã€GitScriptNodeã€PythonScriptNode ç­‰ï¼‰ã€12.2 å„ç¨® StructuralNodeï¼ˆPipelineNodeã€LoopNodeï¼‰ã‚’å®šç¾©ã™ã‚‹ã€‚12.3 ãã®ä»–ã¯å°†æ¥æ‹¡å¼µã¨ã™ã‚‹ã€‚

### 12.3.1 resume_inputs ã® node_id ã‚¹ã‚³ãƒ¼ãƒ—ï¼ˆv1.3 äºˆç´„ï¼‰

v1.2 ã§ã¯ resume_inputs ã¯å˜ä¸€ dict ã‚’å…¨ pause Node ã«æ¸¡ã™ï¼ˆÂ§6.7ï¼‰ã€‚ã‚­ãƒ¼è¡çªã¯æœªå®šç¾©å‹•ä½œã§ã‚ã‚‹ã€‚

v1.3 ã§ã¯ä»¥ä¸‹ã®å½¢å¼ã‚’æ¤œè¨ã™ã‚‹ï¼š

```text
resume_inputs = {
    "node_a": {"human_input": "æ‰¿èªã—ã¾ã™"},
    "node_b": {"score_override": 0.3}
}
```

å„ Node ã¯è‡ªèº«ã® node_id ã«å¯¾å¿œã™ã‚‹ã‚µãƒ– dict ã®ã¿ã‚’å—ã‘å–ã‚‹ã€‚ã“ã‚Œã«ã‚ˆã‚Šè¤‡æ•° pause Node ãŒåŒæ™‚ç™ºç”Ÿã™ã‚‹å ´åˆã®ã‚­ãƒ¼è¡çªã‚’æ§‹é€ çš„ã«è§£æ¶ˆã§ãã‚‹ã€‚

ãŸã ã—ã€ŒNode ã¯ black-box ã§ã‚ã‚Šå†…éƒ¨æ§‹é€ ã‚’ API ã«æ¼ã‚‰ã•ãªã„ã€åŸå‰‡ï¼ˆÂ§6.7ï¼‰ã¨ã®ãƒˆãƒ¬ãƒ¼ãƒ‰ã‚ªãƒ•ãŒã‚ã‚‹ãŸã‚ã€v1.3 ã§è¨­è¨ˆã‚’ç¢ºå®šã™ã‚‹ã€‚

---

## 12.4 å¤§è¦æ¨¡ãƒ‡ãƒ¼ã‚¿ãƒãƒªã‚·ãƒ¼ï¼ˆLarge Output Policyï¼‰

NodeFlow ã¯ JSON I/O ãƒ¢ãƒ‡ãƒ«ã§ã‚ã‚‹ã€‚revision ã¯ content-hash ã®ãŸã‚ã€å‡ºåŠ›ã®æ­£è¦åŒ–ãƒ»ãƒãƒƒã‚·ãƒ¥è¨ˆç®—ãŒå¯èƒ½ãªç¯„å›²ã§é‹ç”¨ã™ã‚‹ã€‚

### 12.4.1 å·¨å¤§ãƒã‚¤ãƒŠãƒªã®æ‰±ã„

ä»¥ä¸‹ã¯ output port ã«**ç›´æ¥å«ã‚ãªã„**ã“ã¨ã‚’æ¨å¥¨ã™ã‚‹ï¼š

* ç”»åƒãƒã‚¤ãƒˆåˆ—
* å‹•ç”»ãƒã‚¤ãƒˆåˆ—
* å¤§è¦æ¨¡ãƒã‚¤ãƒŠãƒªï¼ˆ1MB ä»¥ä¸Šã‚’æ¨å¥¨ä¸Šé™ã¨ã™ã‚‹ï¼‰

å·¨å¤§ãƒ‡ãƒ¼ã‚¿ã‚’ç›´æ¥å«ã‚ã‚‹ã¨ã€Canonical JSON åŒ–ãƒ»ãƒãƒƒã‚·ãƒ¥è¨ˆç®—ã®ã‚³ã‚¹ãƒˆãŒå¢—å¤§ã™ã‚‹ã€‚**å¤§è¦æ¨¡ãƒ‡ãƒ¼ã‚¿ã‚’ç›´æ¥å«ã‚ãŸå ´åˆã€Canonical JSON åŒ–ãŠã‚ˆã³ SHA-256 è¨ˆç®—ã‚³ã‚¹ãƒˆã¯ Node ã®è²¬ä»»ã§ã‚ã‚‹ã€‚ã‚¨ãƒ³ã‚¸ãƒ³ã¯æœ€é©åŒ–ã‚’ä¿è¨¼ã—ãªã„ã€‚**

### 12.4.2 æ¨å¥¨æ–¹å¼

å·¨å¤§ãƒ‡ãƒ¼ã‚¿ã¯ **å‚ç…§è­˜åˆ¥å­ã‚’è¿”ã™** æ–¹å¼ã¨ã™ã‚‹ã€‚

```json
{
  "file_path": "/tmp/image.png"
}
```

ã¾ãŸã¯

```json
{
  "blob_id": "s3://bucket/key"
}
```

revision ã¯ãã®è­˜åˆ¥å­ã‚’å«ã‚€ JSON ã‹ã‚‰ content-hash ã¨ã—ã¦è¨ˆç®—ã•ã‚Œã‚‹ã€‚

### 12.4.3 hash_skipï¼ˆä¾‹å¤–çš„ã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰

ç‰¹æ®Šãªã‚±ãƒ¼ã‚¹ã§å·¨å¤§å‡ºåŠ›ã‚’ç›´æ¥æ‰±ã†å¿…è¦ãŒã‚ã‚‹å ´åˆã€**hash_skip** ã‚’æŒ‡å®šã§ãã‚‹ã€‚

```json
{
  "_meta": { "hash_skip": true },
  "data": huge_binary
}
```

BaseNode ã¯ `hash_skip` ãŒ true ã®å ´åˆã€content-hash ã‚’è¨ˆç®—ã›ãš **revision ã‚’ UUID ç­‰ã®ä¸€æ„è­˜åˆ¥å­ã§ç”Ÿæˆ**ã™ã‚‹ã€‚

```text
if _meta.hash_skip:
    revision = UUID4()  # ã¾ãŸã¯åŒç­‰ã®ä¸€æ„å€¤
else:
    revision = SHA256(CanonicalJSON(port_value_without_meta))
```

**hash_skip ã¯ä¾‹å¤–çš„ç”¨é€”ã§ã‚ã‚Šã€åŸå‰‡ä½¿ç”¨ã—ãªã„ã€‚** é€šå¸¸ã¯ Â§12.4.2 ã®å‚ç…§æ–¹å¼ã‚’ç”¨ã„ã‚‹ã€‚**hash_skip ã‚’ä½¿ç”¨ã—ãŸ port ã¯ deterministic ã§ã¯ãªã„å¯èƒ½æ€§ãŒã‚ã‚‹**ï¼ˆUUID ç­‰ã¯å®Ÿè¡Œã”ã¨ã«ç•°ãªã‚‹ãŸã‚ï¼‰ã€‚

---

# 13. å®Ÿè£…æ§‹é€ 

### ã‚¯ãƒ©ã‚¹éšå±¤ï¼ˆÂ§1.3 ã¨ã®å¯¾å¿œï¼‰

```
Node (abstract)
 â”œâ”€â”€ DataNode (abstract)  â€¦ BaseNode ã‚’ç¶™æ‰¿ã™ã‚‹å˜ä½“ Node
 â”‚       â”œâ”€â”€ LLMNode
 â”‚       â”œâ”€â”€ ScriptNode
 â”‚       â””â”€â”€ ...
 â”‚
 â””â”€â”€ StructuralNode (abstract)
         â”œâ”€â”€ PipelineNode
         â””â”€â”€ LoopNode
```

å¾“æ¥è¡¨è¨˜ã¨ã®å¯¾å¿œï¼šBaseNode ã¯ DataNodeãƒ»StructuralNode å…±é€šã®åŸºåº•ã‚¯ãƒ©ã‚¹ã€‚DataNode ã¯ãã®ä¸Šã« run() å®Ÿè£…ã‚’è¿½åŠ ã—ãŸæŠ½è±¡ã‚¯ãƒ©ã‚¹ã§ã‚ã‚‹ã€‚PipelineNodeBase / LLMNodeBase ç­‰ã¯ä¸Šè¨˜ã®å…·è±¡ã«ãƒãƒƒãƒ”ãƒ³ã‚°ã™ã‚‹ã€‚

### ãƒãƒ¼ãƒ‰å®Ÿä½“æ§‹æˆ

```
nodes/
  node_name/
    node.yaml
    node.py
```

* node.yaml = å®£è¨€
* node.py = å®Ÿè£…

---

# 14. ä¸å¤‰æ¡ä»¶ï¼ˆInvariantsï¼‰

# Part IV â€” Invariants

ä»¥ä¸‹ã®ä¸å¤‰æ¡ä»¶ã‚’æº€ãŸã™ã“ã¨ã§ã€æ›–æ˜§ã•ã®æ’é™¤ãƒ»å®Ÿè£…ãƒ–ãƒ¬é˜²æ­¢ãƒ»å°†æ¥æ‹¡å¼µå¯èƒ½æ€§ã‚’ä¿ã¤ã€‚

1. **Node ã®å†…éƒ¨çŠ¶æ…‹ã¯ Node ã®ã¿ãŒå¤‰æ›´å¯èƒ½**ï¼ˆÂ§2.3.1 åˆ¶ç´„ã€‚state / usage / Context ã®åˆ†é›¢åŸå‰‡ã¯ Â§3.9.4ï¼‰
2. **StructuralNode ã¯å­ã‚’ black-box ã¨ã—ã¦æ‰±ã†**ï¼ˆå­ã® status ã‚’ç›´æ¥å¤‰æ›´ã—ãªã„ï¼‰
3. **usage ã¯ç´¯ç©**ï¼ˆreset ã—ãªã„ã€‚Â§3.7, Â§3.9.2ï¼‰
4. **revision ã¯ BaseNode ãŒ content-hash ã«ã‚ˆã‚Šè‡ªå‹•ç”Ÿæˆã™ã‚‹ã€‚StructuralNode ã¯ revision ã‚’å¤‰æ›´ã—ãªã„ã€‚**ï¼ˆÂ§5.7, Â§6.6, Â§6.7ï¼‰
5. **execute ã¯ ready ã¾ãŸã¯ done ã®ã¨ãã«é€šå¸¸çµŒè·¯ã§å‘¼ã¹ã‚‹ã€‚pause ã®ã¨ãã¯ resume çµŒç”±ã§ã®ã¿å‘¼ã¹ã‚‹**ï¼ˆÂ§2.2, Â§7.3ï¼‰
6. **Node ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã¯åŒä¸€ Execution Scope ã§å†åˆ©ç”¨ã™ã‚‹**ï¼ˆexecute ã®ãŸã³ã«å†ç”Ÿæˆã—ãªã„ï¼‰ã€‚LoopNode ã¯ iteration é–“ã§å­ Node ã®åŒä¸€ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’å†åˆ©ç”¨ã™ã‚‹ã€‚PipelineNode ã«ã¤ã„ã¦ã‚‚ã€åŒä¸€ Execution Scope å†…ã§ã¯åŒä¸€ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ä½¿ç”¨ã™ã‚‹ã€‚
7. **revision ã¯ output å†…å®¹ã®ã¿ã«ä¾å­˜ã™ã‚‹**ï¼ˆcontent-hashã€‚Â§5.1, Â§5.7ï¼‰
8. **Node å®Ÿè£…ã¯ revision ã‚’ç›´æ¥ç”Ÿæˆã—ã¦ã¯ãªã‚‰ãªã„**ï¼ˆBaseNode ãŒä»˜ä¸ã€‚Â§5.2, Â§5.7ï¼‰
9. **revision è¨ˆç®—æ™‚ã« _meta ã¯é™¤å¤–ã™ã‚‹**ï¼ˆÂ§5.9.4ï¼‰
10. **hash_skip ãŒæŒ‡å®šã•ã‚ŒãŸå ´åˆã€revision ã¯ content-hash ã§ã‚ã‚‹ä¿è¨¼ã‚’å¤±ã†**ï¼ˆÂ§12.4.3ï¼‰
11. **hash_skip ã¯ä¾‹å¤–çš„ç”¨é€”ã§ã‚ã‚Šã€é€šå¸¸ä½¿ç”¨ã—ã¦ã¯ãªã‚‰ãªã„**ï¼ˆÂ§12.4.3ï¼‰
12. **StructuralNode ã¯å­ãƒãƒ¼ãƒ‰ã®å‡ºåŠ›å†…å®¹ã‚’å¤‰æ›´ã—ã¦ã¯ãªã‚‰ãªã„**
13. **StructuralNode ã¯ revision ã‚’å†ç”Ÿæˆã—ã¦ã¯ãªã‚‰ãªã„**ï¼ˆfinal ãƒãƒ¼ãƒ‰ã®å‡ºåŠ›ã‚’ãã®ã¾ã¾è¿”ã™ã€‚Â§6.7ï¼‰
14. **LoopNode ã¯åŒä¸€ Execution Scope å†…ã® iteration é–“ã§ã€å­ Node ã®åŒä¸€ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’å†åˆ©ç”¨ã—ãªã‘ã‚Œã°ãªã‚‰ãªã„**ï¼ˆiteration ã”ã¨ã«å­ã‚’å†ç”Ÿæˆã—ã¦ã¯ãªã‚‰ãªã„ã€‚Â§12.2.2.3ï¼‰
15. **StructuralNode ã® status é›†ç´„ã¯ Â§6.7 ã«å¾“ã†**
16. **ä¸¦åˆ—å®Ÿè¡Œã«ãŠã„ã¦ã€status ã®èª­ã¿å–ã‚Šã¨ execute() ã®å‘¼ã³å‡ºã—ã¯ã‚¢ãƒˆãƒŸãƒƒã‚¯ã«è¡Œã‚ã‚Œãªã‘ã‚Œã°ãªã‚‰ãªã„**ï¼ˆÂ§7.3 Atomicity requirementï¼‰
17. **node_calls ã¯ BaseNode.execute() ã®å‘¼ã³å‡ºã—å›æ•°ã¨ã—ã¦å®šç¾©ã•ã‚Œã‚‹**ï¼ˆÂ§3.8ï¼‰
18. **revision è¨ˆç®—ã«ãŠã„ã¦é JSON å‹ã¯ TypeErrorï¼ˆfatalï¼‰ã¨ã™ã‚‹ã€‚æš—é»™å‹å¤‰æ›ã¯ç¦æ­¢ã™ã‚‹**ï¼ˆÂ§5.9ï¼‰
19. **BaseNode ã¯ fatal ç™ºç”Ÿæ™‚ã«åŸå› ä¾‹å¤–ã‚’å†…éƒ¨ä¿æŒã—ã€read_error() ã§å…¬é–‹ã—ãªã‘ã‚Œã°ãªã‚‰ãªã„**ï¼ˆÂ§9ï¼‰

---

# NodeFlow v1.2ï¼ˆäºŒå±¤æ§‹é€ ç‰ˆï¼‰ã®æ„å‘³

ã“ã®å†æ§‹æˆã«ã‚ˆã‚Šï¼š

* NodeFlow ã¯è¨ˆç®—ãƒ¢ãƒ‡ãƒ«ï¼ˆPart Iï¼‰ã‚’æŒã¤
* å®Ÿè£…ä»•æ§˜ã¨ç†è«–ãŒåˆ†é›¢ã•ã‚ŒãŸ
* å°†æ¥ v1.3 ã§ Execution Layer ã‚’å·®ã—æ›¿ãˆå¯èƒ½
* åˆ†æ•£ Runner å®Ÿè£…ãƒ»Streaming å®Ÿè£…ã‚‚è¨­è¨ˆã—ã‚„ã™ã„

---

# NodeFlow v1.2 ã®ç‰¹å¾´

* å®Œå…¨ I/O ãƒ™ãƒ¼ã‚¹
* Context å»ƒæ­¢
* version å»ƒæ­¢ â†’ port å˜ä½ revision
* status â€” å†…éƒ¨çŠ¶æ…‹ï¼ˆäºˆç´„ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã§ã¯ãªã„ï¼‰ã€‚read_status() ã§èª­ã‚€ã€‚åˆ¶å¾¡ã¯ StructuralNodeï¼ˆÂ§2.3, Â§6.7ï¼‰
* **å®Ÿè¡Œé †åºã¯ nodes é…åˆ—é †ã§æ±ºå®š**ï¼ˆÂ§7.1.1ï¼‰
* **revision ã¯ BaseNode ãŒ content-hash ã§è‡ªå‹•ç”Ÿæˆ**ï¼ˆÂ§5.7ï¼‰
* Pull å‹å®Ÿè¡Œ
* revision ã¯ content-hashï¼ˆåŒä¸€å‡ºåŠ›â†’åŒä¸€ revisionï¼‰
* æ˜ç¤ºçµ‚äº†
* å¾ªç’°è¨±å¯
* æœ€æ–°å‡ºåŠ›ã®ã¿ä¿æŒ
* Param æ˜ç¤º
* limit ã¯ params å†…
* ä¾‹å¤–æ™‚ã¯ status = fatalï¼ˆè¿”ã‚Šå€¤ã§ã¯ãªã„ï¼‰
* Runner ã¯ dumbï¼ˆstatus ã®æ„å‘³ã¯è§£é‡ˆã—ãªã„ã€‚å®Ÿè¡Œå¯èƒ½åˆ¤å®šã«å‚ç…§ã™ã‚‹ã€‚Â§7.3ï¼‰
* **çŠ¶æ…‹ã¯ Node å†…éƒ¨**ï¼ˆread_status() ã§èª­ã‚€ï¼‰
* **graceful stop åŸºæœ¬**ï¼ˆkill / interrupt ãªã—ï¼‰
* **Loop ã‚‚ Node**ï¼ˆLoopNodeï¼‰

---

# ç”¨èªãƒãƒªã‚·ãƒ¼ï¼ˆæ”¹è¨‚ï¼‰

1. **Flow ã¯ Core ã®æŠ½è±¡æ§‹é€ ã§ã‚ã‚Šã€Execution Layer ã®ã‚¯ãƒ©ã‚¹ã§ã¯ãªã„ã€‚**
2. **Graph ã®æ„å‘³è«– âŸ¦GâŸ§ ã¯ Execution Layer ã§ã¯ StructuralNode.execute ã«ã‚ˆã‚Šå®Ÿç¾ã•ã‚Œã‚‹ã€‚**
3. **PipelineNode ã¯ Graph ã‚’ 1-shot å®Ÿè¡Œã™ã‚‹ StructuralNode ã®ä¸€ç¨®ã§ã‚ã‚‹ã€‚**
4. **LoopNode ã¯ Graph ã‚’åå¾©å®Ÿè¡Œã™ã‚‹ StructuralNode ã®ä¸€ç¨®ã§ã‚ã‚‹ã€‚**
5. **Runner ã¯ StructuralNode ã®å†…éƒ¨è£œåŠ©æ©Ÿæ§‹ã§ã‚ã‚Šã€Graph ã®å®Ÿè¡Œä¸»ä½“ã§ã¯ãªã„ã€‚**
6. **ã€ŒFlow å®Ÿè¡Œã€ã¨ã„ã†èªã¯ä½¿ç”¨ã›ãšã€ã€ŒStructuralNode ã® execute å‘¼ã³å‡ºã—ã€ã¨è¨˜è¿°ã™ã‚‹ã€‚**
